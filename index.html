<!DOCTYPE html>
<html lang="si" data-theme="light"> <!-- Default theme -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>gaviru sandiptha official web & app</title>
    <style>
        /* --- CSS Variables (Themes) --- */
        :root {
            /* Light Theme (Default) */
            --bg-primary: #f0f4f8; /* Slightly cooler light background */
            --bg-secondary: #ffffff;
            --text-primary: #1a1a1a;
            --text-secondary: #555;
            --border-color: #e0e5eb;
            --accent-primary: #0056b3;
            --accent-secondary: #007bff;
            --accent-secondary-hover: #0056b3;
            --success-bg: #e6f7ec;
            --success-border: #b7e4c7;
            --success-text: #0d6330;
            --error-bg: #fff0f1;
            --error-border: #ffccd1;
            --error-text: #a82233;
            --error-text-strong: #8a1c29;
            --calc-display-bg: #e1e8ed;
            --calc-button-bg: #fcfdfe;
            --calc-button-hover: #f0f4f7;
            --calc-operator-bg: #e9f1f8;
            --calc-operator-text: #0056b3; /* Operator text color */
            --calc-clear-bg: #fee7e9;
            --calc-clear-hover: #fdd8db;
            --calc-clear-text: #a82233; /* Clear text color */
            --calc-equals-bg: #007bff;
            --calc-equals-hover: #0056b3;
            --calc-equals-text: #ffffff; /* Equals text color */
            --calc-button-text: var(--text-primary); /* Default button text */
            --calc-border-color: #d3dce6;
            --shadow-color: rgba(0, 80, 150, 0.1); /* Adjusted shadow color */
            --shadow-hover-color: rgba(0, 80, 150, 0.15);
            --section-shadow: 0 12px 40px var(--shadow-color);
            --section-hover-shadow: 0 16px 50px var(--shadow-hover-color);
            --input-bg: #fdfdfe;
            --disabled-bg: #e9ecef;
            --disabled-text: #6c757d;
            --button-text: #ffffff;
            --link-color: var(--accent-secondary);
            --chat-bg: var(--bg-primary);
            --chat-user-bg: #e1f5fe;
            --chat-ai-bg: #f1f3f5;
            --social-icon-color: #495057;
            --social-icon-hover-color: var(--accent-secondary);
            --nav-button-bg: var(--accent-secondary);
            --nav-button-hover-bg: var(--accent-secondary-hover);
            --nav-button-text: #ffffff;
            --zeno-iframe-border: var(--border-color);
            --back-button-bg: transparent;
            --back-button-text: var(--text-secondary);
            --back-button-hover-bg: color-mix(in srgb, var(--text-secondary) 10%, transparent);
            --back-button-hover-text: var(--accent-secondary);
            --capture-button-bg: color-mix(in srgb, var(--accent-secondary) 15%, transparent);
            --capture-button-hover-bg: color-mix(in srgb, var(--accent-secondary) 25%, transparent);
            --capture-button-text: var(--accent-secondary);

            --font-primary: 'Poppins', 'Noto Sans Sinhala', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --font-code: 'Fira Code', Menlo, Monaco, Consolas, monospace;
            --font-display: 'Orbitron', sans-serif;
            --font-calc: 'Poppins', sans-serif;

            --loader-bg: var(--bg-primary);
            --loader-color: var(--accent-secondary);
            --transition-speed: 0.4s;
            --transition-timing: ease;
            --transition-fast: 0.2s;
        }

        :root[data-theme="dark"] {
            --bg-primary: #121212;
            --bg-secondary: #1e1f21;
            --text-primary: #e1e1e1;
            --text-secondary: #a0a0a0;
            --border-color: #333538;
            --accent-primary: #4dabf7;
            --accent-secondary: #74c0fc;
            --accent-secondary-hover: #a5d8ff;
            --success-bg: #13312c;
            --success-border: #1a4d40;
            --success-text: #a3e9a4;
            --error-bg: #3b1c23;
            --error-border: #5c2a34;
            --error-text: #ffacad;
            --error-text-strong: #ffa6b8;
            --calc-display-bg: #161718;
            --calc-button-bg: #2a2c2f;
            --calc-button-hover: #383b3e;
            --calc-operator-bg: #222831;
            --calc-operator-text: #74c0fc; /* Bright text for dark operator */
            --calc-clear-bg: #4d262a;
            --calc-clear-hover: #633135;
            --calc-clear-text: #ffacad; /* Bright text for dark clear */
            --calc-equals-bg: #4dabf7;
            --calc-equals-hover: #74c0fc;
            --calc-equals-text: #121212; /* Dark text for light blue equals */
            --calc-button-text: var(--text-primary); /* Default button text */
            --calc-border-color: #2f3134;
            --shadow-color: rgba(0, 0, 0, 0.4);
            --shadow-hover-color: rgba(0, 0, 0, 0.5);
            --section-shadow: 0 12px 45px var(--shadow-color);
            --section-hover-shadow: 0 18px 60px var(--shadow-hover-color);
            --input-bg: #2c2c2c;
            --disabled-bg: #424242;
            --disabled-text: #888;
            --button-text: #ffffff;
            --link-color: var(--accent-secondary);
            --chat-bg: var(--bg-secondary);
            --chat-user-bg: #1c3a4d;
            --chat-ai-bg: #2f3134;
            --social-icon-color: #adb5bd;
            --social-icon-hover-color: var(--accent-secondary);
            --nav-button-bg: var(--accent-secondary);
            --nav-button-hover-bg: var(--accent-secondary-hover);
            --nav-button-text: #121212; /* Darker text on light blue */
            --zeno-iframe-border: var(--border-color);
            --back-button-bg: transparent;
            --back-button-text: var(--text-secondary);
            --back-button-hover-bg: color-mix(in srgb, var(--text-secondary) 15%, transparent);
            --back-button-hover-text: var(--accent-secondary);
            --capture-button-bg: color-mix(in srgb, var(--accent-secondary) 20%, transparent);
            --capture-button-hover-bg: color-mix(in srgb, var(--accent-secondary) 30%, transparent);
            --capture-button-text: var(--accent-secondary);

            --loader-bg: var(--bg-primary);
            --loader-color: var(--accent-secondary);
        }

        /* --- Loading Animation Styles --- */
        #loading-overlay {
            position: fixed; inset: 0; background-color: var(--loader-bg);
            display: flex; justify-content: center; align-items: center;
            z-index: 9999; opacity: 1; transition: opacity 0.5s ease-out; pointer-events: auto; /* Start enabled */
        }
        #loading-overlay.hidden { opacity: 0; pointer-events: none; } /* Disable pointer events when hidden */
        #loading-overlay lottie-player { width: 250px; height: 250px; } /* Slightly larger loader */
        .container { opacity: 0; transition: opacity 0.5s ease-in 0.2s; visibility: hidden; } /* Faster fade-in */
        body.loaded .container { opacity: 1; visibility: visible; }

        /* --- Base Styles --- */
        body {
            font-family: var(--font-primary); line-height: 1.7; margin: 0; padding: 20px 0;
            background-color: var(--bg-primary); color: var(--text-primary);
            transition: background-color var(--transition-speed) var(--transition-timing), color var(--transition-speed) var(--transition-timing);
        }
        .container {
            background-color: var(--bg-secondary); padding: 40px 50px; border-radius: 20px;
            box-shadow: 0 10px 35px var(--shadow-color); max-width: 1100px; margin: 40px auto;
            border: 1px solid var(--border-color);
            transition: background-color var(--transition-speed) var(--transition-timing), border-color var(--transition-speed) var(--transition-timing), box-shadow var(--transition-speed) var(--transition-timing), opacity 0.5s ease-in, visibility 0s linear 0.5s; /* Match fade-in */
        }
         .header {
             display: flex; justify-content: space-between; align-items: center;
             margin-bottom: 35px; padding-bottom: 25px; border-bottom: 3px solid var(--accent-secondary);
             transition: border-color var(--transition-speed) var(--transition-timing);
         }
        h1 {
            color: var(--accent-primary); margin: 0; font-weight: 600; font-size: 2em;
            display: flex; align-items: center; gap: 15px; transition: color var(--transition-speed) var(--transition-timing);
        }
         h1 svg { fill: var(--accent-primary); height: 35px; width: 35px; transition: fill var(--transition-speed) var(--transition-timing); }

        /* Theme Toggle Styles */
         .theme-switcher {
             display: flex; align-items: center; background-color: var(--input-bg);
             border-radius: 25px; padding: 6px 8px; border: 1px solid var(--border-color);
             cursor: pointer; position: relative; width: 55px; height: 30px;
             transition: background-color var(--transition-speed) var(--transition-timing), border-color var(--transition-speed) var(--transition-timing);
         }
         #themeToggle { opacity: 0; position: absolute; }
         .theme-icon {
             position: absolute; top: 50%; transform: translateY(-50%); font-size: 1.3em;
             transition: opacity 0.3s ease, transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
             color: var(--accent-secondary);
         }
         .icon-sun { left: 8px; opacity: 1; transform: translateY(-50%) rotate(0deg); }
         .icon-moon { right: 8px; opacity: 0; transform: translateY(-50%) rotate(360deg); }
         [data-theme="dark"] .theme-switcher .icon-sun { opacity: 0; transform: translateY(-50%) rotate(360deg); }
         [data-theme="dark"] .theme-switcher .icon-moon { opacity: 1; transform: translateY(-50%) rotate(0deg); }

         /* --- Home Section & Navigation --- */
         #home-section {
             padding: 20px 0; /* Add padding if needed */
             text-align: center;
         }
         .nav-buttons {
             display: grid;
             grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); /* Responsive grid */
             gap: 25px;
             margin: 40px 0;
         }
         .nav-button {
             background: linear-gradient(145deg, color-mix(in srgb, var(--nav-button-bg) 95%, #fff), var(--nav-button-bg));
             color: var(--nav-button-text);
             padding: 25px 20px; /* Larger padding */
             border: none; border-radius: 15px; /* Rounder corners */
             cursor: pointer; font-size: 1.15em; font-weight: 500;
             transition: background var(--transition-fast) var(--transition-timing), box-shadow var(--transition-fast) var(--transition-timing), transform var(--transition-fast) cubic-bezier(0.34, 1.56, 0.64, 1);
             display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 15px; /* Icon and text */
             box-shadow: 0 6px 15px var(--shadow-color);
             text-decoration: none; text-align: center; line-height: 1.4;
         }
         .nav-button:hover {
            background: linear-gradient(145deg, var(--nav-button-hover-bg), color-mix(in srgb, var(--nav-button-hover-bg) 90%, #000));
            box-shadow: 0 8px 20px var(--shadow-hover-color); transform: translateY(-4px) scale(1.03); /* Enhanced hover */
         }
          .nav-button:active {
              transform: translateY(0px) scale(0.98); box-shadow: 0 3px 8px var(--shadow-color);
          }
          .nav-button svg {
              width: 40px; height: 40px; /* Larger icons */
              fill: var(--nav-button-text);
              transition: fill var(--transition-fast) var(--transition-timing);
              margin-bottom: 5px;
          }

         /* Zeno FM Player */
          .zeno-player-container {
             margin: 40px auto; padding: 20px; border-radius: 15px;
             border: 1px solid var(--zeno-iframe-border);
             background-color: color-mix(in srgb, var(--bg-secondary) 80%, var(--bg-primary));
             box-shadow: 0 5px 15px rgba(0,0,0,0.05);
             transition: border-color var(--transition-speed) var(--transition-timing), background-color var(--transition-speed) var(--transition-timing);
             max-width: 500px; /* Limit width */
         }
          .zeno-player-container h3 {
             margin-top: 0; margin-bottom: 15px; font-weight: 500;
             color: var(--text-secondary); text-align: center;
             font-size: 1.1em;
         }
         .zeno-player-container iframe {
             width: 100%; height: 180px; /* Adjust height as needed */
             border: none; border-radius: 10px;
             overflow: hidden;
         }


        /* --- Section Styles (for Tools) --- */
        .tool-section {
            background-color: var(--bg-secondary); /* Revert to secondary bg */
            border: 1px solid var(--border-color); padding: 35px;
            margin-top: 30px; border-radius: 16px;
            box-shadow: var(--section-shadow);
            transition: box-shadow var(--transition-speed) var(--transition-timing), background-color var(--transition-speed) var(--transition-timing), border-color var(--transition-speed) var(--transition-timing),
                        opacity var(--transition-speed) var(--transition-timing), transform var(--transition-speed) var(--transition-timing),
                        visibility 0s linear var(--transition-speed);
            opacity: 0; transform: translateY(10px); visibility: hidden;
            position: absolute; top: 150px; left: 50px; right: 50px;
            max-width: calc(1100px - 100px);
        }
         .tool-section.active-section {
             opacity: 1; transform: translateY(0); visibility: visible;
             position: relative; top: 0; left: 0; right: 0;
             margin-top: 30px; transition-delay: 0.1s; max-width: none;
         }
        .tool-section:hover { box-shadow: var(--section-hover-shadow); }
        .tool-section-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 30px; padding-bottom: 15px; border-bottom: 2px solid var(--border-color);
            transition: border-color var(--transition-speed) var(--transition-timing);
        }
        .tool-section h2 {
            margin: 0; /* Reset margin */
            color: var(--accent-secondary); font-size: 1.6em; font-weight: 500;
            display: flex; align-items: center; gap: 15px; /* Add gap */
            transition: color var(--transition-speed) var(--transition-timing);
        }
        .tool-section h2 svg { fill: var(--accent-secondary); transition: fill var(--transition-speed) var(--transition-timing); width: 26px; height: 26px; } /* Removed margin */

        /* Back Button Styles */
         button.back-to-home-button {
             background: var(--back-button-bg); color: var(--back-button-text); border: 1px solid var(--border-color);
             padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 0.9em;
             display: inline-flex; align-items: center; gap: 6px;
             transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease, transform 0.1s ease;
         }
         button.back-to-home-button svg {
             width: 18px; height: 18px; fill: var(--back-button-text); transition: fill 0.2s ease;
         }
         button.back-to-home-button:hover {
             background: var(--back-button-hover-bg); color: var(--back-button-hover-text); border-color: var(--back-button-hover-text);
             transform: translateY(-1px);
         }
          button.back-to-home-button:hover svg { fill: var(--back-button-hover-text); }
          button.back-to-home-button:active { transform: translateY(0px); background: color-mix(in srgb, var(--back-button-hover-bg) 80%, black); }


        /* --- Input/Textarea/Select Styles --- */
        textarea, input[type="text"], input[type="file"], select {
            width: 100%; padding: 16px 18px; margin-bottom: 20px; border: 1px solid var(--border-color);
            border-radius: 10px; box-sizing: border-box; font-size: 1.05em; font-family: inherit;
            background-color: var(--input-bg); color: var(--text-primary);
            transition: border-color 0.3s ease, box-shadow 0.3s ease, background-color var(--transition-speed) var(--transition-timing), color var(--transition-speed) var(--transition-timing);
        }
        textarea:focus, input[type="text"]:focus, select:focus {
            border-color: var(--accent-secondary); box-shadow: 0 0 0 4px color-mix(in srgb, var(--accent-secondary) 20%, transparent); outline: none;
        }
         input::placeholder, textarea::placeholder { color: var(--text-secondary); opacity: 0.6; font-style: italic; }
        label { display: block; margin-bottom: 12px; font-weight: 500; color: var(--text-secondary); font-size: 0.95em; transition: color var(--transition-speed) var(--transition-timing); }

        /* File input specific styles */
        .file-input-area { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; } /* Container for both buttons */
        .file-input-wrapper {
            position: relative; overflow: hidden; display: block; width: 100%;
            border: 2px dashed var(--border-color); border-radius: 10px; padding: 25px 20px; text-align: center;
            background-color: color-mix(in srgb, var(--bg-primary) 60%, var(--bg-secondary));
            transition: background-color 0.3s ease, border-color 0.3s ease; cursor: pointer;
        }
        .file-input-wrapper:hover {
             background-color: color-mix(in srgb, var(--bg-primary) 80%, var(--bg-secondary));
             border-color: var(--accent-secondary); border-style: solid;
        }
        .file-input-wrapper input[type=file] { position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }
         .file-input-label {
             color: var(--accent-secondary); font-weight: 500; cursor: pointer; display: flex;
             align-items: center; justify-content: center; gap: 12px; font-size: 1.15em;
             pointer-events: none; transition: color 0.3s ease;
         }
          .file-input-label svg { fill: var(--accent-secondary); transition: fill 0.3s ease; width: 22px; height: 22px; }
          /* Capture Button Style */
          button.capture-button {
              background-color: var(--capture-button-bg); color: var(--capture-button-text);
              border: 1px solid var(--border-color); border-radius: 8px; padding: 10px 18px;
              font-size: 0.95em; font-weight: 500; cursor: pointer;
              display: inline-flex; align-items: center; gap: 8px; width: 100%; justify-content: center;
              transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease, transform 0.1s ease;
          }
           button.capture-button svg { fill: var(--capture-button-text); width: 18px; height: 18px; transition: fill 0.2s ease; }
           button.capture-button:hover {
              background-color: var(--capture-button-hover-bg); transform: translateY(-1px); border-color: var(--capture-button-text);
           }
           button.capture-button:active { transform: translateY(0); }

          .file-name-display { margin-top: 12px; font-style: italic; color: var(--text-secondary); font-size: 0.9em; min-height: 1.5em; transition: color var(--transition-speed) var(--transition-timing); }
          .file-needs-reselect { font-weight: bold; color: var(--error-text-strong); margin-left: 10px; }

        /* --- Button Styles --- */
         .button-group { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 15px; align-items: center; }
         /* General Purpose Buttons */
        button.api-button, button.action-button /* Added class for non-api buttons like Clear Base */ {
            background: linear-gradient(145deg, color-mix(in srgb, var(--accent-secondary) 95%, #fff), var(--accent-secondary)); color: var(--button-text, #ffffff);
            padding: 14px 28px; border: none; border-radius: 10px; cursor: pointer; font-size: 1.05em; font-weight: 500;
            transition: background 0.3s ease, box-shadow 0.3s ease, transform var(--transition-fast) cubic-bezier(0.34, 1.56, 0.64, 1), color var(--transition-speed) var(--transition-timing);
            display: inline-flex; align-items: center; justify-content: center; gap: 10px;
            box-shadow: 0 4px 8px var(--shadow-color); text-decoration: none;
        }
        button.api-button:hover:not(:disabled), button.action-button:hover:not(:disabled) {
            background: linear-gradient(145deg, var(--accent-secondary-hover), color-mix(in srgb, var(--accent-secondary-hover) 90%, #000));
            box-shadow: 0 6px 12px var(--shadow-hover-color); transform: translateY(-2px) scale(1.02);
        }
         button.api-button:active:not(:disabled), button.action-button:active:not(:disabled) { transform: translateY(0px) scale(0.97); box-shadow: 0 2px 4px var(--shadow-color); }
         button.api-button:disabled, button.action-button:disabled {
            background: var(--disabled-bg); color: var(--disabled-text); cursor: not-allowed; box-shadow: none; transform: none;
        }
        button.api-button svg, button.action-button svg { fill: var(--button-text, #ffffff); transition: fill var(--transition-speed) var(--transition-timing); width: 19px; height: 19px; }
         button.api-button:disabled svg, button.action-button:disabled svg { fill: var(--disabled-text); }

         /* Clear Button Specific Style */
         button.clear-button {
             background: color-mix(in srgb, var(--text-secondary) 80%, transparent); color: var(--text-primary); padding: 8px 16px; font-size: 0.9em;
             box-shadow: none; border: 1px solid var(--border-color);
             border-radius: 8px; /* Consistent rounding */
             transition: background-color 0.3s ease, border-color 0.3s ease, transform var(--transition-fast) ease, box-shadow 0.3s ease, color var(--transition-speed) var(--transition-timing);
             display: inline-flex; align-items: center; justify-content: center; gap: 8px; /* Align icon */
         }
          button.clear-button svg { fill: var(--text-primary); transition: fill var(--transition-speed) var(--transition-timing); width: 16px; height: 16px; }
          button.clear-button:hover:not(:disabled) {
              background-color: color-mix(in srgb, var(--text-secondary) 100%, transparent); border-color: var(--text-secondary); transform: translateY(-1px);
              box-shadow: 0 2px 4px var(--shadow-hover-color);
          }
           button.clear-button:active:not(:disabled) { transform: translateY(0px) scale(0.98); box-shadow: none; background-color: color-mix(in srgb, var(--text-secondary) 90%, transparent); }
           button.clear-button:disabled { /* Match general disabled */
                background: var(--disabled-bg); color: var(--disabled-text); cursor: not-allowed; box-shadow: none; transform: none; border-color: var(--disabled-bg);
           }
           button.clear-button:disabled svg { fill: var(--disabled-text); }

        /* --- Result Box Styles --- */
        .result-box {
            margin-top: 30px; padding: 25px 30px; border: 1px solid var(--success-border); background-color: var(--success-bg);
            border-radius: 10px; min-height: 100px; white-space: pre-wrap; font-family: var(--font-code);
            overflow-x: auto; font-size: 1.05em; line-height: 1.7; color: var(--success-text);
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.06); position: relative;
            transition: background-color var(--transition-speed) var(--transition-timing), border-color var(--transition-speed) var(--transition-timing), color var(--transition-speed) var(--transition-timing);
        }
        .result-box p:first-child { margin-top: 0; }
        .result-box p:last-child { margin-bottom: 0; }
        .result-box pre { background-color: color-mix(in srgb, var(--border-color) 10%, transparent); padding: 15px; border-radius: 8px; overflow-x: auto; font-size: 0.95em; }
        .result-box code { font-family: var(--font-code); }
        .result-box ul, .result-box ol { margin-left: 25px; padding-left: 15px;}
        .result-box li { margin-bottom: 8px;}

        /* Loading Indicator Styles */
        .loading-overlay {
             position: absolute; inset: 0; background-color: color-mix(in srgb, var(--bg-secondary) 90%, transparent);
             display: flex; justify-content: center; align-items: center; border-radius: inherit; z-index: 10;
             opacity: 0; transition: opacity 0.4s ease; pointer-events: none;
         }
          .result-box.loading .loading-overlay { opacity: 1; pointer-events: auto; }
         .loading-overlay lottie-player { width: 80px; height: 80px; }
        .error { border-color: var(--error-border); background-color: var(--error-bg); color: var(--error-text); }
         .error strong { color: var(--error-text-strong); }
         .processing-interrupted { font-style: italic; color: var(--text-secondary); }
        hr { border: none; border-top: 1px solid var(--border-color); margin: 50px 0; transition: border-color var(--transition-speed) var(--transition-timing); }

         /* --- Chat Bot Styles --- */
         .chat-input-container { margin-top: 20px; }
         .chat-input-area { display: flex; gap: 10px; align-items: flex-end; margin-bottom: 15px; }
         .chat-input-area textarea { flex-grow: 1; margin-bottom: 0; height: 50px; resize: none; }
         .chat-input-area button { height: 50px; flex-shrink: 0; padding: 0 25px; }
         .chat-file-input-wrapper { /* Reusing general file input area */
             border: 1px dashed var(--border-color); border-radius: 8px; padding: 8px 15px; margin-bottom: 15px;
             background-color: transparent; text-align: left; cursor: pointer;
             transition: border-color 0.3s ease, background-color 0.3s ease;
             position: relative;
         }
         .chat-file-input-wrapper:hover { border-color: var(--accent-secondary); border-style: solid; }
         .chat-file-input-wrapper input[type=file] { position: absolute; left: 0; top: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
         .chat-file-input-label {
             display: flex; align-items: center; gap: 8px; font-size: 0.95em; color: var(--accent-secondary);
             pointer-events: none; /* Let clicks pass through to input */
         }
         .chat-file-input-label svg { width: 18px; height: 18px; flex-shrink: 0; }
         #fileNameDisplayChat { margin-left: 10px; font-style: italic; font-size: 0.9em; color: var(--text-secondary); }


         .chat-history-box {
             background-color: var(--chat-bg); border: 1px solid var(--border-color); border-radius: 10px;
             padding: 20px; margin-bottom: 25px; max-height: 500px; overflow-y: auto;
             display: flex; flex-direction: column; gap: 15px;
             transition: background-color var(--transition-speed) var(--transition-timing), border-color var(--transition-speed) var(--transition-timing);
         }
         .chat-message { padding: 12px 18px; border-radius: 15px; max-width: 85%; word-wrap: break-word; line-height: 1.6; }
         .user-message { background-color: var(--chat-user-bg); align-self: flex-end; border-bottom-right-radius: 5px; color: var(--text-primary); }
         .ai-message { background-color: var(--chat-ai-bg); align-self: flex-start; border-bottom-left-radius: 5px; color: var(--text-primary); }
         .ai-message p:first-child { margin-top: 0; }
         .ai-message p:last-child { margin-bottom: 0; }
         .ai-message pre { margin-top: 10px; margin-bottom: 5px; }
          .chat-message img.embedded-image {
              max-width: 100%; height: auto; border-radius: 8px; margin-top: 8px; display: block;
              cursor: pointer; transition: transform var(--transition-fast) ease;
          }
           .chat-message img.embedded-image:hover { transform: scale(1.03); }
           /* Style for generic file display in chat */
            .chat-message .file-display i {
                display: inline-flex; align-items: center; gap: 8px;
                background-color: color-mix(in srgb, var(--border-color) 30%, transparent);
                padding: 6px 12px; border-radius: 6px; font-style: normal;
            }
            .chat-message .file-display svg { width: 16px; height: 16px; fill: currentColor; }


         /* --- Calculator Styles --- */
         #calculator {
             border: 1px solid var(--calc-border-color); border-radius: 18px; overflow: hidden;
             box-shadow: 0 12px 35px var(--shadow-color); max-width: 500px; margin: 0 auto;
             background-color: var(--bg-secondary);
             transition: border-color var(--transition-speed) var(--transition-timing), box-shadow 0.3s ease, background-color var(--transition-speed) var(--transition-timing);
         }
         #calculator-display {
             background-color: var(--calc-display-bg); color: var(--text-primary); font-size: 2.5em;
             padding: 30px 30px; text-align: right; border-bottom: 1px solid var(--calc-border-color);
             font-family: var(--font-display); height: 90px; box-sizing: border-box; overflow-x: auto;
             transition: background-color var(--transition-speed) var(--transition-timing), color var(--transition-speed) var(--transition-timing), border-color var(--transition-speed) var(--transition-timing);
             border-radius: 17px 17px 0 0;
         }
         .calculator-buttons {
             display: grid; grid-template-columns: repeat(5, 1fr); gap: 2px;
             background-color: var(--calc-border-color); padding: 2px;
             border-radius: 0 0 17px 17px;
             transition: background-color var(--transition-speed) var(--transition-timing);
         }
         .calculator-buttons button {
             background-color: var(--calc-button-bg); color: var(--calc-button-text); /* Use specific variable */
             padding: 0; font-size: 1.25em; border: none; border-radius: 12px; cursor: pointer;
             transition: background-color 0.2s ease, color var(--transition-speed) var(--transition-timing), box-shadow 0.2s ease, transform 0.1s ease;
             margin: 0; box-shadow: 0 3px 5px rgba(0,0,0,0.04), inset 0 -1px 1px rgba(255,255,255,0.1);
             font-family: var(--font-calc); font-weight: 500; height: 75px;
             display: flex; justify-content: center; align-items: center; position: relative;
         }
          [data-theme="dark"] .calculator-buttons button {
             box-shadow: 0 3px 5px rgba(0,0,0,0.1), inset 0 -1px 1px rgba(255,255,255,0.05);
          }
         .calculator-buttons button:hover:not(:disabled) {
             background-color: var(--calc-button-hover); box-shadow: 0 4px 7px rgba(0,0,0,0.07), inset 0 -1px 1px rgba(255,255,255,0.1); transform: translateY(-2px);
         }
          [data-theme="dark"] .calculator-buttons button:hover:not(:disabled) {
             box-shadow: 0 4px 7px rgba(0,0,0,0.15), inset 0 -1px 1px rgba(255,255,255,0.05);
          }
         .calculator-buttons button:active:not(:disabled) {
             background-color: color-mix(in srgb, var(--calc-button-hover) 80%, black); transform: translateY(0px) scale(0.97); box-shadow: inset 0 3px 5px rgba(0,0,0,0.18);
         }
         .calculator-buttons .operator, .calculator-buttons .function {
             background-color: var(--calc-operator-bg); color: var(--calc-operator-text); /* Use specific variable */
             box-shadow: 0 3px 5px rgba(0,0,0,0.04), inset 0 -1px 1px rgba(255,255,255,0.1);
         }
          [data-theme="dark"] .calculator-buttons .operator, [data-theme="dark"] .calculator-buttons .function {
               box-shadow: 0 3px 5px rgba(0,0,0,0.1), inset 0 -1px 1px rgba(255,255,255,0.05);
          }
         .calculator-buttons .equals {
             background-color: var(--calc-equals-bg); color: var(--calc-equals-text); /* Use specific variable */
             box-shadow: 0 3px 5px rgba(0,0,0,0.08), inset 0 -1px 1px rgba(255,255,255,0.2);
         }
          [data-theme="dark"] .calculator-buttons .equals {
             box-shadow: 0 3px 5px rgba(0,0,0,0.2), inset 0 -1px 1px rgba(255,255,255,0.1);
          }
          .calculator-buttons .equals:hover:not(:disabled) { background-color: var(--calc-equals-hover); transform: translateY(-2px); }
         .calculator-buttons .clear {
             background-color: var(--calc-clear-bg); color: var(--calc-clear-text); /* Use specific variable */
             box-shadow: 0 3px 5px rgba(0,0,0,0.04), inset 0 -1px 1px rgba(255,255,255,0.1);
         }
           [data-theme="dark"] .calculator-buttons .clear {
             box-shadow: 0 3px 5px rgba(0,0,0,0.1), inset 0 -1px 1px rgba(255,255,255,0.05);
           }
         .calculator-buttons .clear:hover:not(:disabled) { background-color: var(--calc-clear-hover); transform: translateY(-2px); }


          /* --- Base Converter Styles --- */
          .base-converter-grid {
              display: grid; grid-template-columns: auto 1fr; gap: 20px 15px; align-items: center; margin-top: 20px;
          }
          .base-converter-grid label { margin-bottom: 0; text-align: right; font-weight: 500; color: var(--text-secondary); font-size: 1.1em; }
           .base-converter-grid input { margin-bottom: 0; font-family: var(--font-code); font-size: 1.2em; }
           #baseConverterError { margin-top: 25px; padding: 15px 20px; font-size: 1em; }


           /* --- Social Links Section --- */
           .social-links {
                text-align: center; margin-top: 40px; padding-top: 30px; border-top: 1px solid var(--border-color);
                transition: border-color var(--transition-speed) var(--transition-timing);
           }
           .social-links h3 {
                margin-bottom: 25px; font-size: 1.3em; font-weight: 500; color: var(--text-secondary);
                transition: color var(--transition-speed) var(--transition-timing);
           }
           .social-links-list {
                list-style: none; padding: 0; margin: 0; display: flex; justify-content: center; flex-wrap: wrap; gap: 30px;
           }
           .social-links-list li { display: inline-block; }
           .social-links-list a {
                color: var(--social-icon-color); text-decoration: none; display: inline-block; transition: color 0.3s ease, transform var(--transition-fast) ease;
           }
            .social-links-list a:hover {
                color: var(--social-icon-hover-color); transform: scale(1.15);
            }
           .social-links-list svg {
                width: 35px; height: 35px; fill: currentColor;
           }


           /* --- Responsive Design --- */
           @media (max-width: 768px) {
               body { padding: 10px 0; }
               .container { padding: 25px 20px; margin: 20px 10px; border-radius: 15px; }
               .header { flex-direction: column; align-items: flex-start; gap: 18px; margin-bottom: 30px; padding-bottom: 20px; }
               h1 { font-size: 1.7em; }
                 h1 svg { height: 30px; width: 30px; }
                .nav-buttons { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
                .nav-button { padding: 20px 15px; font-size: 1em; gap: 10px; border-radius: 12px; }
                .nav-button svg { width: 30px; height: 30px; }

               .tool-section { padding: 25px 20px; margin-top: 20px; border-radius: 12px; box-shadow: 0 8px 25px var(--shadow-color); position: relative; opacity: 1; transform: none; visibility: visible; /* Simplify visibility for mobile */ display: none; /* Use display none/block instead of absolute positioning */ top: auto; left: auto; right: auto; max-width: none;}
               .tool-section.active-section { display: block; }
               .tool-section-header { flex-direction: column; align-items: flex-start; gap: 15px; margin-bottom: 25px; padding-bottom: 12px; }
                .tool-section h2 { font-size: 1.4em; gap: 12px; } /* Adjust gap */
                 .tool-section h2 svg { width: 22px; height: 22px;}
                 button.back-to-home-button { align-self: flex-end; margin-top: -50px; /* Position it near top right corner relative to header */ margin-right: -5px; }
               button.api-button, button.action-button, button.clear-button { padding: 12px 22px; font-size: 1em; }
                 button.clear-button { padding: 8px 14px; font-size: 0.85em; gap: 6px; }
                 button.clear-button svg { width: 14px; height: 14px; }
                 .button-group { flex-direction: column; align-items: stretch; gap: 10px; }
                 .button-group button { width: 100%; margin: 0; }
                .result-box { padding: 20px; font-size: 1em; }
               .base-converter-grid { grid-template-columns: 1fr; gap: 8px 10px; }
                .base-converter-grid label { text-align: left; margin-bottom: 5px; font-size: 1em; }
                 .base-converter-grid input { font-size: 1.1em;}
                 #calculator { max-width: 100%; border-radius: 15px; box-shadow: 0 8px 20px var(--shadow-color); }
                  #calculator-display { font-size: 2.1em; padding: 25px 20px; height: 80px;}
                  .calculator-buttons button { padding: 0; font-size: 1.15em; height: 65px; border-radius: 10px; }
                 .file-input-area { gap: 8px; }
                 .file-input-wrapper { padding: 20px 15px; }
                 .file-input-label { font-size: 1.1em; gap: 10px; }
                  .file-input-label svg { width: 20px; height: 20px; }
                  button.capture-button { padding: 9px 15px; font-size: 0.9em; gap: 6px; }
                  button.capture-button svg { width: 16px; height: 16px; }
                  .chat-history-box { max-height: 400px; padding: 15px; }
                  .chat-input-area textarea { height: 45px; }
                  .chat-input-area button { height: 45px; padding: 0 20px; }
                  .chat-file-input-wrapper { padding: 6px 12px; }
                  .chat-file-input-label { font-size: 0.9em; gap: 6px; }
                  .chat-file-input-label svg { width: 16px; height: 16px; }
                  .social-links-list { gap: 20px; }
                  .social-links-list svg { width: 30px; height: 30px; }
                   .zeno-player-container { max-width: 90%; padding: 15px; }
                   .zeno-player-container iframe { height: 150px; }
                   .tool-section { left: 20px; right: 20px; max-width: calc(100% - 40px); } /* Adjust absolute pos for mobile if used */
           }

            @media (max-width: 480px) {
                 .container { padding: 20px 15px; margin: 15px 5px; }
                 h1 { font-size: 1.5em; gap: 10px;}
                 h1 svg { height: 28px; width: 28px; }
                 .nav-buttons { grid-template-columns: 1fr; gap: 15px; } /* Single column */
                 .nav-button { font-size: 1em; }
                  .tool-section-header { gap: 10px; }
                  .tool-section h2 { font-size: 1.3em; gap: 10px; }
                  button.back-to-home-button { margin-top: -45px; padding: 6px 10px; font-size: 0.8em; }
                  button.back-to-home-button svg { width: 16px; height: 16px; }
                  textarea, input[type="text"], input[type="file"], select { padding: 14px 16px; font-size: 1em;}
                  button.api-button, button.action-button, button.clear-button { padding: 12px 20px; font-size: 0.95em; gap: 8px; }
                   button.api-button svg, button.action-button svg { width: 17px; height: 17px; }
                   button.clear-button { padding: 8px 12px; font-size: 0.8em; gap: 5px; }
                   button.clear-button svg { width: 13px; height: 13px; }
                  #calculator { max-width: 100%; margin: 0 auto; border-radius: 12px;}
                  #calculator-display { font-size: 1.9em; padding: 20px 15px; height: 70px;}
                  .calculator-buttons button { height: 60px; font-size: 1.05em; border-radius: 8px;}
                  .file-input-wrapper { padding: 15px 10px; }
                  button.capture-button { font-size: 0.85em; }
                  .chat-history-box { max-height: 350px; }
                  .chat-input-area { flex-direction: column; align-items: stretch; gap: 8px; }
                  .chat-input-area textarea { height: 60px; }
                  .chat-input-area button { height: 45px; width: 100%;}
                  .chat-input-container { margin-top: 15px; }
                  .chat-file-input-wrapper { margin-bottom: 10px; }
                  .social-links-list { gap: 15px; }
                  .social-links-list svg { width: 28px; height: 28px; }
                   .zeno-player-container iframe { height: 140px; }
                   .tool-section { left: 15px; right: 15px; max-width: calc(100% - 30px); } /* Adjust absolute pos for mobile if used */
             }

           /* --- Utility Classes --- */
           .hidden { display: none !important; }

    </style>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&family=Noto+Sans+Sinhala:wght@400;500;600&family=Orbitron:wght@500;700&family=Fira+Code&display=swap" rel="stylesheet">
    <!-- Lottie Player -->
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
</head>
<body>

    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <!-- Updated animation -->
        <lottie-player src="https://assets3.lottiefiles.com/packages/lf20_qhrndegx.json" background="transparent" speed="1" loop autoplay></lottie-player>
    </div>

    <div class="container">
        <div class="header">
            <h1>
                <svg xmlns="http://www.w3.org/2000/svg" height="35px" viewBox="0 -960 960 960" width="35px"><path d="M480-120q-151 0-255.5-104.5T120-480q0-151 104.5-255.5T480-840q151 0 255.5 104.5T840-480q0 151-104.5 255.5T480-120Zm0-60q125 0 212.5-87.5T780-480q0-125-87.5-212.5T480-780q-125 0-212.5 87.5T180-480q0 125 87.5 212.5T480-180Zm0-300Zm-.455 180q81.554 0 138.777-57.223Q676-414.446 676-496q0-81.554-57.223-138.777Q561.554-692 480-692q-81.554 0-138.777 57.223Q284-577.554 284-496q0 81.554 57.223 138.777Q398.446-300 479.545-300Z"/></svg>
                 gaviru sandiptha official web & app
            </h1>
             <input type="checkbox" id="themeToggle" class="hidden">
             <label for="themeToggle" class="theme-switcher" title="තේමාව මාරු කරන්න">
                 <span class="theme-icon icon-sun">☀️</span>
                  <span class="theme-icon icon-moon">🌙</span>
             </label>
        </div>

        <!-- ============================================== -->
        <!-- ========= HOME SECTION (Visible First) ========= -->
        <!-- ============================================== -->
        <div id="home-section" class="active-section"> <!-- Add active-section class -->
             <!-- Navigation Buttons -->
            <div class="nav-buttons">
                <button class="nav-button" data-target-section="combined-ai-section">
                    <svg xmlns="http://www.w3.org/2000/svg" height="40px" viewBox="0 -960 960 960" width="40px"><path d="M480-80q-84 0-157-31t-127-85q-54-54-85-127T80-480q0-84 31-157t85-127q54-54 127-85t157-31q74 0 138.5 25.5T729-794l-57 57q-38-17-79.5-25.5T480-770q-121 0-205.5 84.5T190-480q0 121 84.5 205.5T480-190q121 0 205.5-84.5T770-480q0-21-2.5-41.5T760-560l57-57q18 40 25.5 81.5T850-480q0 84-31 157t-85 127q-54 54-127 85T480-80Z"/></svg>
                    AI සමඟ සෘජු සංවාදය
                </button>
                 <button class="nav-button" data-target-section="chat-section">
                    <svg xmlns="http://www.w3.org/2000/svg" height="40px" viewBox="0 -960 960 960" width="40px"><path d="M800-240v-400q0-33-23.5-56.5T720-720H240q-33 0-56.5 23.5T160-640v400l80-80h480q33 0 56.5 23.5T800-240Zm-80 0H304l-64 64v-464h480v400Z M240-720h480-480Z"/></svg>
                     AI Chat Bot
                 </button>
                 <button class="nav-button" data-target-section="translate-section">
                     <svg xmlns="http://www.w3.org/2000/svg" height="40px" viewBox="0 -960 960 960" width="40px"><path d="M535.385-80 319.978-294.872l46.128-46.128 118.679 118.705V-800h61.025v577.705l118.679-118.705 46.128 46.128L535.385-80ZM220-160q-24.75 0-42.375-17.625T160-220v-520q0-24.75 17.625-42.375T220-800h180v60H220v520h520v-180h60v180q0 24.75-17.625 42.375T740-160H220Z"/></svg>
                     භාෂා පරිවර්තනය
                 </button>
                 <button class="nav-button" data-target-section="ocr-section">
                     <svg xmlns="http://www.w3.org/2000/svg" height="40px" viewBox="0 -960 960 960" width="40px"><path d="M140-160q-24.75 0-42.375-17.625T80-220v-520q0-24.75 17.625-42.375T140-800h680q24.75 0 42.375 17.625T880-740v520q0 24.75-17.625 42.375T740-160H140Zm0-60h600v-520H140v520Zm80-80h440v-60H220v60Zm0-100h440v-60H220v60Zm0-100h440v-60H220v60ZM140-740v520-520Z"/></svg>
                     OCR (Text හඳුනාගැනීම)
                 </button>
                <button class="nav-button" data-target-section="unicode-converter-section">
                     <svg xmlns="http://www.w3.org/2000/svg" height="40px" viewBox="0 -960 960 960" width="40px"><path d="M247-280h83l50 120h90l-121-282h-88L140-160h90l17-40Zm103-60h-123l61-145 62 145ZM540-160v-320h140q46 0 73 27t27 73q0 46-27 73t-73 27H600v120h-60Zm60-180h80q17 0 28.5-11.5T720-380q0-17-11.5-28.5T680-420h-80v180Z"/></svg>
                     සිංහල Unicode පරිවර්තකය
                </button>
                 <button class="nav-button" data-target-section="summarize-section">
                     <svg xmlns="http://www.w3.org/2000/svg" height="40px" viewBox="0 -960 960 960" width="40px"><path d="M160-120q-33 0-56.5-23.5T80-200v-560q0-33 23.5-56.5T160-840h640q33 0 56.5 23.5T880-760v560q0 33-23.5 56.5T800-120H160Zm0-60h640v-560H160v560Zm80-80h480v-80H240v80Zm0-120h480v-80H240v80Zm0-120h320v-80H240v80Z"/></svg>
                     Text සාරාංශකරණය
                 </button>
                 <button class="nav-button" data-target-section="code-gen-section">
                      <svg xmlns="http://www.w3.org/2000/svg" height="40px" viewBox="0 -960 960 960" width="40px"><path d="m313-170-143-64 143-64 64 143-64 143Zm334 0L583-313l64-143 143 64-64 143ZM480-80 313-440l167-74 167 74L480-80Zm0-400L240-617l57-143L480-880l183 120 57 143L480-480Z"/></svg>
                      කේත උත්පාදනය
                 </button>
                 <button class="nav-button" data-target-section="mcq-marking-section">
                     <svg xmlns="http://www.w3.org/2000/svg" height="40px" viewBox="0 -960 960 960" width="40px"><path d="M280-280q17 0 28.5-11.5T320-320q0-17-11.5-28.5T280-360q-17 0-28.5 11.5T240-320q0 17 11.5 28.5T280-280Zm0 160q17 0 28.5-11.5T320-160q0-17-11.5-28.5T280-200q-17 0-28.5 11.5T240-160q0 17 11.5 28.5T280-120Zm0 160q17 0 28.5-11.5T320 0q0-17-11.5-28.5T280-40q-17 0-28.5 11.5T240 0q0 17 11.5 28.5T280 40Zm120-320v-80h400v80H400Zm0 160v-80h400v80H400Zm0 160v-80h400v80H400ZM160-80q-33 0-56.5-23.5T80-160v-640q0-33 23.5-56.5T160-880h640q33 0 56.5 23.5T880-800v640q0 33-23.5 56.5T800-80H160Zm0-60h640v-640H160v640Zm0 0v-640 640Z"/></svg>
                     MCQ ලකුණු කිරීම
                 </button>
                 <button class="nav-button" data-target-section="answer-gen-section">
                      <svg xmlns="http://www.w3.org/2000/svg" height="40px" viewBox="0 -960 960 960" width="40px"><path d="M480-320q75 0 127.5-52.5T660-500q0-75-52.5-127.5T480-680q-75 0-127.5 52.5T300-500q0 75 52.5 127.5T480-320Zm0-70q-46 0-78-32t-32-78q0-46 32-78t78-32q46 0 78 32t32 78q0 46-32 78t-78 32Zm0 190q-116 0-214-67.5T138-440h-58v-60h58q2-10 3.5-20t3.5-20q-14-40-21-79t-7-81q0-100 55-177t147-117q37 5 74 5t74-5q92 40 147 117t55 177q0 42-7 81t-21 79q2 10 3.5 20t3.5 20h58v60h-58q-48 85-128 132.5T480-100Zm0-70q57 0 107.5-27t88.5-73H284q38 46 88.5 73T480-170Zm176-155q-2-8-4-16.5t-5-18.5q13-37 19-72.5t6-72.5q0-75-40.5-130T528-710q-32 3-64 3t-64-3q-67 34-107.5 89T252-495q0 37 6 72.5t19 72.5q-3 10-5 18.5T268-325h388Z"/></svg>
                      පත්‍රයට පිළිතුරු (General)
                 </button>
                 <button class="nav-button" data-target-section="section-two-section">
                     <svg xmlns="http://www.w3.org/2000/svg" height="40px" viewBox="0 -960 960 960" width="40px"><path d="M220-80q-24.75 0-42.375-17.625T160-140v-400h640v400q0 24.75-17.625 42.375T740-80H220Zm0-60h520v-400H220v400Zm0 180q-33 0-56.5-23.5T140-20v-120h60v120h560v-120h60v120q0 33-23.5 56.5T740-20H140Zm80-520h360v-80H300v80Zm0 120h360v-80H300v80Zm0-280h360v-80H300v80ZM220-140v-400 400Z"/></svg>
                     පත්‍රයේ II කොටසට පිළිතුරු
                 </button>
                 <button class="nav-button" data-target-section="calculator-section">
                     <svg xmlns="http://www.w3.org/2000/svg" height="40px" viewBox="0 -960 960 960" width="40px"><path d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h560q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H200Zm0-60h560v-560H200v560Zm180-80h200v-60H380v60Zm-88-140h80v-80h80v80h80v-80h80v80h80v-60H620v-80h-80v80h-80v-80h-80v80h-80v-80h-80v60Zm88 0h80v-80h-80v80Zm160 0h80v-80h-80v80Z"/></svg>
                      විද්‍යාත්මක කැල්කියුලේටරය
                 </button>
                 <button class="nav-button" data-target-section="base-converter-section">
                     <svg xmlns="http://www.w3.org/2000/svg" height="40px" viewBox="0 -960 960 960" width="40px"><path d="M220-80q-24.75 0-42.375-17.625T160-140v-680q0-24.75 17.625-42.375T220-880h520q24.75 0 42.375 17.625T800-820v680q0 24.75-17.625 42.375T740-80H220Zm0-60h520v-680H220v680Zm80-80h360v-80H300v80Zm0-160h360v-80H300v80Zm0-160h360v-80H300v80Zm0-160h360v-80H300v80ZM220-140v-680 680Z"/></svg>
                     සංඛ්‍යා පාද පරිවර්තකය
                 </button>
            </div>

            <!-- Zeno FM Player -->
            <div class="zeno-player-container">
                 <h3>Online Radio</h3>
                 <iframe src="https://zeno.fm/player/gavirusandipthaofficial" title="gaviru sandiptha official Radio Player"></iframe>
            </div>

            <!-- Social Links Section -->
             <div class="social-links">
                  <h3>අපව අනුගමනය කරන්න</h3>
                  <ul class="social-links-list">
                      <li>
                          <a href="https://vm.tiktok.com/ZS6eRF6tv/" target="_blank" rel="noopener noreferrer" title="TikTok">
                             <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M448 209.9a210.1 210.1 0 0 1 -122.8-39.3V349.4A162.6 162.6 0 1 1 185 188.3V278.2a74.6 74.6 0 1 0 52.2 71.2V0l88 0a121.2 121.2 0 0 0 1.9 22.2h0A122.2 122.2 0 0 0 381 102.4a121.4 121.4 0 0 0 67 20.1z"/></svg>
                          </a>
                      </li>
                      <li>
                          <a href="https://www.facebook.com/share/1PaXuhSutZ/" target="_blank" rel="noopener noreferrer" title="Facebook">
                              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M512 256C512 114.6 397.4 0 256 0S0 114.6 0 256C0 376 82.7 476.8 194.2 504.5V334.2H141.4V256h52.8V222.3c0-87.1 39.4-127.5 125-127.5c16.2 0 44.2 3.2 55.7 6.4V172c-6-.6-16.5-1-29.6-1c-42 0-58.2 15.9-58.2 57.2V256h83.6l-14.4 78.2H287V510.1C413.8 494.8 512 386.9 512 256h0z"/></svg>
                          </a>
                      </li>
                      <li>
                          <a href="https://youtube.com/@Gavirusandiptha_official?si=Eg1jgEDlXMVFjAhs" target="_blank" rel="noopener noreferrer" title="YouTube">
                              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path d="M549.7 124.1c-6.3-23.7-24.8-42.3-48.3-48.6C458.8 64 288 64 288 64S117.2 64 74.6 75.5c-23.5 6.3-42 24.9-48.3 48.6C16 165.6 16 256 16 256s0 90.4 10.3 131.9c6.3 23.7 24.8 42.3 48.3 48.6C117.2 448 288 448 288 448s170.8 0 213.4-11.5c23.5-6.3 42-24.9 48.3-48.6C560 346.4 560 256 560 256s0-90.4-10.3-131.9zM232 341.5V170.5l144 85.5-144 85.5z"/></svg>
                          </a>
                      </li>
                  </ul>
             </div>

        </div> <!-- End Home Section -->


        <!-- ============================================== -->
        <!-- ======== TOOL SECTIONS (Hidden First) ======== -->
        <!-- ============================================== -->

        <!-- Section 1: Combined AI Interaction -->
        <div id="combined-ai-section" class="tool-section hidden">
             <div class="tool-section-header">
                 <h2>
                    <svg xmlns="http://www.w3.org/2000/svg" height="26px" viewBox="0 -960 960 960" width="26px"><path d="M480-80q-84 0-157-31t-127-85q-54-54-85-127T80-480q0-84 31-157t85-127q54-54 127-85t157-31q74 0 138.5 25.5T729-794l-57 57q-38-17-79.5-25.5T480-770q-121 0-205.5 84.5T190-480q0 121 84.5 205.5T480-190q121 0 205.5-84.5T770-480q0-21-2.5-41.5T760-560l57-57q18 40 25.5 81.5T850-480q0 84-31 157t-85 127q-54 54-127 85T480-80Z"/></svg>
                    AI සමඟ සෘජු සංවාදය (Text/Image/PDF)
                 </h2>
                 <button class="back-to-home-button" title="ආපසු මුල් පිටුවට">
                     <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="18px"><path d="M400-80 0-480l400-400 71 71-329 329 329 329-71 71Z"/></svg>
                      ආපසු
                 </button>
            </div>
            <label for="aiCombinedPrompt">ඔබේ ප්‍රශ්නය, උපදෙස, හෝ කාර්යය:</label>
            <textarea id="aiCombinedPrompt" rows="5" placeholder="ගණිත ගැටලුවක්, කේතයක් ලිවීමට උපදෙසක්, සාරාංශ කිරීමට ලිපියක්, හෝ ඡායාරූපයක්/PDF එකක් ගැන විමසීමක් මෙහි ඇතුලත් කරන්න..." data-storage-key="input_aiCombinedPrompt"></textarea>

             <label>ඡායාරූපයක් හෝ PDF එකක් එක් කිරීමට (වෛකල්පිත):</label>
             <div class="file-input-area">
                 <div class="file-input-wrapper">
                     <input type="file" id="aiCombinedImage" accept="image/*,application/pdf" data-display-id="fileNameDisplayCombined" data-storage-key="file_aiCombinedImage">
                     <span class="file-input-label">
                         <svg xmlns="http://www.w3.org/2000/svg" height="22px" viewBox="0 -960 960 960" width="22px"><path d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h360v80H200v560h560v-280h80v280q0 33-23.5 56.5T760-120H200Zm480-480v-80h-80v-80h80v-80h80v80h80v80h-80v80h-80ZM240-280h480L570-480 450-320l-90-120-120 160Z"/></svg>
                          ගොනුවක් තෝරන්න (Image/PDF)
                     </span>
                 </div>
                 <button class="capture-button" data-target-input="aiCombinedImage">
                     <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="18px"><path d="M160-200q-33 0-56.5-23.5T80-280v-400q0-33 23.5-56.5T160-760h126l74-80h240l74 80h126q33 0 56.5 23.5T880-680v400q0 33-23.5 56.5T800-200H160Zm0-80h640v-400H160v400Zm320-60q66 0 113-47t47-113q0-66-47-113t-113-47q-66 0-113 47t-47 113q0 66 47 113t113 47Zm0-80q-33 0-56.5-23.5T380-520q0-33 23.5-56.5T480-600q33 0 56.5 23.5T560-520q0 33-23.5 56.5T480-440ZM160-280h640v-400H160v400Z"/></svg>
                     කැමරාවෙන් ලබාගන්න
                 </button>
             </div>
             <div id="fileNameDisplayCombined" class="file-name-display"></div>

             <div class="button-group">
                <button id="submitCombinedAI" class="api-button" data-processing-key="processing_aiCombined" data-result-id="aiCombinedResult">
                    <svg xmlns="http://www.w3.org/2000/svg" height="19px" viewBox="0 -960 960 960" width="19px"><path d="M120-160v-640l760 320-760 320Z"/></svg>
                    AI වෙත යවන්න
                </button>
                 <button class="clear-button" data-target-inputs="aiCombinedPrompt,aiCombinedImage" data-target-result="aiCombinedResult" data-target-display="fileNameDisplayCombined">
                    <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="18px"><path d="M280-120q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520ZM360-280h80v-360h-80v360Zm160 0h80v-360h-80v360ZM280-720v520-520Z"/></svg>
                    මකන්න
                 </button>
             </div>
            <div id="aiCombinedResult" class="result-box" data-storage-key="result_aiCombinedResult"><p>AI ප්‍රතිචාරය මෙහි දිස්වනු ඇත.</p></div>
        </div>

        <!-- Section 2: AI Chat Bot -->
        <div id="chat-section" class="tool-section hidden">
             <div class="tool-section-header">
                 <h2>
                     <svg xmlns="http://www.w3.org/2000/svg" height="26px" viewBox="0 -960 960 960" width="26px"><path d="M800-240v-400q0-33-23.5-56.5T720-720H240q-33 0-56.5 23.5T160-640v400l80-80h480q33 0 56.5 23.5T800-240Zm-80 0H304l-64 64v-464h480v400Z M240-720h480-480Z"/></svg>
                     AI Chat Bot (Any File)
                 </h2>
                  <button class="back-to-home-button" title="ආපසු මුල් පිටුවට">
                     <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="18px"><path d="M400-80 0-480l400-400 71 71-329 329 329 329-71 71Z"/></svg>
                      ආපසු
                 </button>
             </div>
             <div id="chatHistory" class="chat-history-box" data-storage-key="chatHistoryData">
                 <!-- Chat messages will be appended here -->
                 <div class="ai-message"><p>ආයුබෝවන්! ඔබට උදව් කළ හැක්කේ කෙසේද? ඔබට ප්‍රශ්නයක් ඇසීමට, උපදෙසක් ලබා ගැනීමට හෝ ඕනෑම ගොනුවක් (ඡායාරූප, PDF, වීඩියෝ, ශ්‍රව්‍ය etc.) පිළිබඳව විමසීමට හැකිය.</p></div>
             </div>

             <div class="chat-input-container">
                 <div class="chat-input-area">
                     <textarea id="chatInput" rows="1" placeholder="AI වෙත පණිවිඩයක් යවන්න..." data-storage-key="input_chatInput"></textarea>
                     <button id="sendChatMessage" class="api-button" data-processing-key="processing_chat" data-result-id="chatHistory">
                         <svg xmlns="http://www.w3.org/2000/svg" height="19px" viewBox="0 -960 960 960" width="19px"><path d="M120-160v-640l760 320-760 320Z"/></svg>
                         යවන්න
                     </button>
                 </div>

                 <!-- Reusing general file input area -->
                 <label>ගොනුවක් එක් කිරීමට (වෛකල්පිත):</label>
                 <div class="file-input-area">
                      <div class="file-input-wrapper">
                          <input type="file" id="chatImageInput" data-display-id="fileNameDisplayChat" data-storage-key="file_chatImageInput"> <!-- Removed accept -->
                          <label for="chatImageInput" class="chat-file-input-label">
                              <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="18px"><path d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h360v80H200v560h560v-280h80v280q0 33-23.5 56.5T760-120H200Zm480-480v-80h-80v-80h80v-80h80v80h80v80h-80v80h-80ZM240-280h480L570-480 450-320l-90-120-120 160Z"/></svg>
                              ගොනුවක් තෝරන්න
                              <span id="fileNameDisplayChat" class="file-name-display"></span>
                          </label>
                      </div>
                      <button class="capture-button" data-target-input="chatImageInput">
                          <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="18px"><path d="M160-200q-33 0-56.5-23.5T80-280v-400q0-33 23.5-56.5T160-760h126l74-80h240l74 80h126q33 0 56.5 23.5T880-680v400q0 33-23.5 56.5T800-200H160Zm0-80h640v-400H160v400Zm320-60q66 0 113-47t47-113q0-66-47-113t-113-47q-66 0-113 47t-47 113q0 66 47 113t113 47Zm0-80q-33 0-56.5-23.5T380-520q0-33 23.5-56.5T480-600q33 0 56.5 23.5T560-520q0 33-23.5 56.5T480-440ZM160-280h640v-400H160v400Z"/></svg>
                          කැමරාවෙන් ලබාගන්න
                      </button>
                 </div>
             </div>

             <div class="button-group" style="justify-content: flex-end; margin-top: 15px;">
                  <button class="clear-button" id="clearChatButton">
                     <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="18px"><path d="M280-120q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520ZM360-280h80v-360h-80v360Zm160 0h80v-360h-80v360ZM280-720v520-520Z"/></svg>
                    Chat මකන්න
                  </button>
             </div>
        </div>


        <!-- Section 3: Translation -->
        <div id="translate-section" class="tool-section hidden">
             <div class="tool-section-header">
                <h2>
                    <svg xmlns="http://www.w3.org/2000/svg" height="26px" viewBox="0 -960 960 960" width="26px"><path d="M535.385-80 319.978-294.872l46.128-46.128 118.679 118.705V-800h61.025v577.705l118.679-118.705 46.128 46.128L535.385-80ZM220-160q-24.75 0-42.375-17.625T160-220v-520q0-24.75 17.625-42.375T220-800h180v60H220v520h520v-180h60v180q0 24.75-17.625 42.375T740-160H220Z"/></svg>
                    භාෂා පරිවර්තනය (Text/Image/PDF)
                </h2>
                 <button class="back-to-home-button" title="ආපසු මුල් පිටුවට">
                     <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="18px"><path d="M400-80 0-480l400-400 71 71-329 329 329 329-71 71Z"/></svg>
                      ආපසු
                 </button>
            </div>
            <label for="translateText">පරිවර්තනය කිරීමට අවශ්‍ය පාඨය (වෛකල්පිත):</label>
            <textarea id="translateText" rows="4" placeholder="පරිවර්තනය කිරීමට අවශ්‍ය පාඨය මෙහි ඇතුලත් කරන්න..." data-storage-key="input_translateText"></textarea>

            <label>හෝ පරිවර්තනයට ඡායාරූපයක්/PDF එක් කරන්න (වෛකල්පිත):</label>
             <div class="file-input-area">
                 <div class="file-input-wrapper">
                     <input type="file" id="translateImage" accept="image/*,application/pdf" data-display-id="fileNameDisplayTranslate" data-storage-key="file_translateImage">
                      <span class="file-input-label">
                         <svg xmlns="http://www.w3.org/2000/svg" height="22px" viewBox="0 -960 960 960" width="22px"><path d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h360v80H200v560h560v-280h80v280q0 33-23.5 56.5T760-120H200Zm480-480v-80h-80v-80h80v-80h80v80h80v80h-80v80h-80ZM240-280h480L570-480 450-320l-90-120-120 160Z"/></svg>
                          ගොනුවක් තෝරන්න (Image/PDF)
                     </span>
                 </div>
                  <button class="capture-button" data-target-input="translateImage">
                     <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="18px"><path d="M160-200q-33 0-56.5-23.5T80-280v-400q0-33 23.5-56.5T160-760h126l74-80h240l74 80h126q33 0 56.5 23.5T880-680v400q0 33-23.5 56.5T800-200H160Zm0-80h640v-400H160v400Zm320-60q66 0 113-47t47-113q0-66-47-113t-113-47q-66 0-113 47t-47 113q0 66 47 113t113 47Zm0-80q-33 0-56.5-23.5T380-520q0-33 23.5-56.5T480-600q33 0 56.5 23.5T560-520q0 33-23.5 56.5T480-440ZM160-280h640v-400H160v400Z"/></svg>
                     කැමරාවෙන් ලබාගන්න
                 </button>
            </div>
            <div id="fileNameDisplayTranslate" class="file-name-display"></div>

            <label for="translateLang">පරිවර්තනය කළ යුතු භාෂාව:</label>
             <select id="translateLang" data-storage-key="select_translateLang">
                <option value="si">සිංහල (Sinhala)</option>
                <option value="en">English</option>
                <option value="ta">தமிழ் (Tamil)</option>
                 <option value="ar">العربية (Arabic)</option>
                 <option value="zh-CN">中文 (Simplified Chinese)</option>
                 <option value="fr">Français (French)</option>
                <option value="de">Deutsch (German)</option>
                 <option value="hi">हिन्दी (Hindi)</option>
                 <option value="it">Italiano (Italian)</option>
                <option value="ja">日本語 (Japanese)</option>
                <option value="ko">한국어 (Korean)</option>
                <option value="pt">Português (Portuguese)</option>
                <option value="ru">Русский (Russian)</option>
                <option value="es">Español (Spanish)</option>
            </select>

             <div class="button-group">
                <button id="submitTranslateBtn" class="api-button" data-processing-key="processing_translate" data-result-id="translateResult">
                     <svg xmlns="http://www.w3.org/2000/svg" height="19px" viewBox="0 -960 960 960" width="19px"><path d="M535.385-80 319.978-294.872l46.128-46.128 118.679 118.705V-800h61.025v577.705l118.679-118.705 46.128 46.128L535.385-80ZM220-160q-24.75 0-42.375-17.625T160-220v-520q0-24.75 17.625-42.375T220-800h180v60H220v520h520v-180h60v180q0 24.75-17.625 42.375T740-160H220Z"/></svg>
                    පරිවර්තනය කරන්න
                </button>
                 <button class="clear-button" data-target-inputs="translateText,translateImage" data-target-result="translateResult" data-target-display="fileNameDisplayTranslate">
                    <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="18px"><path d="M280-120q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520ZM360-280h80v-360h-80v360Zm160 0h80v-360h-80v360ZM280-720v520-520Z"/></svg>
                    මකන්න
                 </button>
             </div>
            <div id="translateResult" class="result-box" data-storage-key="result_translateResult"><p>පරිවර්තනය මෙහි දිස්වනු ඇත.</p></div>
        </div>


        <!-- Section 4: OCR -->
        <div id="ocr-section" class="tool-section hidden">
             <div class="tool-section-header">
                 <h2>
                     <svg xmlns="http://www.w3.org/2000/svg" height="26px" viewBox="0 -960 960 960" width="26px"><path d="M140-160q-24.75 0-42.375-17.625T80-220v-520q0-24.75 17.625-42.375T140-800h680q24.75 0 42.375 17.625T880-740v520q0 24.75-17.625 42.375T740-160H140Zm0-60h600v-520H140v520Zm80-80h440v-60H220v60Zm0-100h440v-60H220v60Zm0-100h440v-60H220v60ZM140-740v520-520Z"/></svg>
                     ගොනුවක අකුරු හඳුනාගැනීම (OCR - Image/PDF)
                 </h2>
                  <button class="back-to-home-button" title="ආපසු මුල් පිටුවට">
                     <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="18px"><path d="M400-80 0-480l400-400 71 71-329 329 329 329-71 71Z"/></svg>
                      ආපසු
                 </button>
            </div>
            <label>අකුරු හඳුනාගැනීමට ඡායාරූපයක් හෝ PDF එකක් Upload කරන්න:</label>
            <div class="file-input-area">
                 <div class="file-input-wrapper">
                     <input type="file" id="ocrImageFile" accept="image/*,application/pdf" data-display-id="ocrFileNameDisplay" data-storage-key="file_ocrImageFile">
                     <span class="file-input-label">
                          <svg xmlns="http://www.w3.org/2000/svg" height="22px" viewBox="0 -960 960 960" width="22px"><path d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h360v80H200v560h560v-280h80v280q0 33-23.5 56.5T760-120H200Zm480-480v-80h-80v-80h80v-80h80v80h80v80h-80v80h-80ZM240-280h480L570-480 450-320l-90-120-120 160Z"/></svg>
                           ගොනුවක් තෝරන්න (Image/PDF)
                     </span>
                 </div>
                 <button class="capture-button" data-target-input="ocrImageFile">
                     <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="18px"><path d="M160-200q-33 0-56.5-23.5T80-280v-400q0-33 23.5-56.5T160-760h126l74-80h240l74 80h126q33 0 56.5 23.5T880-680v400q0 33-23.5 56.5T800-200H160Zm0-80h640v-400H160v400Zm320-60q66 0 113-47t47-113q0-66-47-113t-113-47q-66 0-113 47t-47 113q0 66 47 113t113 47Zm0-80q-33 0-56.5-23.5T380-520q0-33 23.5-56.5T480-600q33 0 56.5 23.5T560-520q0 33-23.5 56.5T480-440ZM160-280h640v-400H160v400Z"/></svg>
                     කැමරාවෙන් ලබාගන්න
                 </button>
            </div>
             <div id="ocrFileNameDisplay" class="file-name-display"></div>

              <div class="button-group">
                <button id="submitOcrImageBtn" class="api-button" data-processing-key="processing_ocr" data-result-id="ocrImageResult">
                    <svg xmlns="http://www.w3.org/2000/svg" height="19px" viewBox="0 -960 960 960" width="19px"><path d="m380-80-40-40 100-100-100-100 40-40 140 140-140 140Zm140 0-40-40 100-100-100-100 40-40 140 140-140 140Z"/></svg>
                     Text ලබාගන්න
                </button>
                  <button class="clear-button" data-target-inputs="ocrImageFile" data-target-result="ocrImageResult" data-target-display="ocrFileNameDisplay">
                    <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="18px"><path d="M280-120q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520ZM360-280h80v-360h-80v360Zm160 0h80v-360h-80v360ZM280-720v520-520Z"/></svg>
                    මකන්න
                 </button>
              </div>
            <div id="ocrImageResult" class="result-box" data-storage-key="result_ocrImageResult"><p>ගොනුවේ හඳුනාගත් අකුරු මෙහි දිස්වනු ඇත.</p></div>
        </div>

        <!-- Section 12: Sinhala Unicode Converter -->
        <div id="unicode-converter-section" class="tool-section hidden">
             <div class="tool-section-header">
                 <h2>
                     <svg xmlns="http://www.w3.org/2000/svg" height="26px" viewBox="0 -960 960 960" width="26px"><path d="M247-280h83l50 120h90l-121-282h-88L140-160h90l17-40Zm103-60h-123l61-145 62 145ZM540-160v-320h140q46 0 73 27t27 73q0 46-27 73t-73 27H600v120h-60Zm60-180h80q17 0 28.5-11.5T720-380q0-17-11.5-28.5T680-420h-80v180Z"/></svg>
                     සිංහල Unicode පරිවර්තකය
                 </h2>
                  <button class="back-to-home-button" title="ආපසු මුල් පිටුවට">
                     <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="18px"><path d="M400-80 0-480l400-400 71 71-329 329 329 329-71 71Z"/></svg>
                      ආපසු
                 </button>
            </div>
            <label for="unicodeInputText">පරිවර්තනයට සිංහල Text එක ඇතුලත් කරන්න (වෛකල්පිත):</label>
            <textarea id="unicodeInputText" rows="5" placeholder="මෙහි Singlish හෝ legacy font (උදා: FM Abhaya) වලින් টাইප් කළ Text එක ඇතුලත් කරන්න..." data-storage-key="input_unicodeInputText"></textarea>

            <label>හෝ පරිවර්තනයට ඡායාරූපයක්/PDF එක් කරන්න (වෛකල්පිත):</label>
            <div class="file-input-area">
                 <div class="file-input-wrapper">
                     <input type="file" id="unicodeInputFile" accept="image/*,application/pdf" data-display-id="unicodeFileNameDisplay" data-storage-key="file_unicodeInputFile">
                     <span class="file-input-label">
                         <svg xmlns="http://www.w3.org/2000/svg" height="22px" viewBox="0 -960 960 960" width="22px"><path d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h360v80H200v560h560v-280h80v280q0 33-23.5 56.5T760-120H200Zm480-480v-80h-80v-80h80v-80h80v80h80v80h-80v80h-80ZM240-280h480L570-480 450-320l-90-120-120 160Z"/></svg>
                           ගොනුවක් තෝරන්න (Image/PDF)
                     </span>
                 </div>
                  <button class="capture-button" data-target-input="unicodeInputFile">
                     <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="18px"><path d="M160-200q-33 0-56.5-23.5T80-280v-400q0-33 23.5-56.5T160-760h126l74-80h240l74 80h126q33 0 56.5 23.5T880-680v400q0 33-23.5 56.5T800-200H160Zm0-80h640v-400H160v400Zm320-60q66 0 113-47t47-113q0-66-47-113t-113-47q-66 0-113 47t-47 113q0 66 47 113t113 47Zm0-80q-33 0-56.5-23.5T380-520q0-33 23.5-56.5T480-600q33 0 56.5 23.5T560-520q0 33-23.5 56.5T480-440ZM160-280h640v-400H160v400Z"/></svg>
                     කැමරාවෙන් ලබාගන්න
                 </button>
            </div>
            <div id="unicodeFileNameDisplay" class="file-name-display"></div>

            <div class="button-group">
               <button id="submitUnicodeConvert" class="api-button" data-processing-key="processing_unicodeConvert" data-result-id="unicodeResult">
                   <svg xmlns="http://www.w3.org/2000/svg" height="19px" viewBox="0 -960 960 960" width="19px"><path d="M646-160 518-480h-92l-128 320h76l25-60h144l25 60h78ZM360-480q-33 0-56.5-23.5T280-560v-240h80v240h160v80H360Zm234-60L480-680l114-140h-123l-40-80h209v68l-114 132h124l40 80H594Z"/></svg>
                   Unicode වලට හරවන්න
               </button>
                <button class="clear-button" data-target-inputs="unicodeInputText,unicodeInputFile" data-target-result="unicodeResult" data-target-display="unicodeFileNameDisplay">
                   <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="18px"><path d="M280-120q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520ZM360-280h80v-360h-80v360Zm160 0h80v-360h-80v360ZM280-720v520-520Z"/></svg>
                   මකන්න
                </button>
            </div>
            <div id="unicodeResult" class="result-box" data-storage-key="result_unicodeResult"><p>Unicode බවට පරිවර්තනය කළ text එක මෙහි දිස්වනු ඇත.</p></div>
       </div>

        <!-- Section 5: Text Summarization -->
         <div id="summarize-section" class="tool-section hidden">
             <div class="tool-section-header">
                 <h2>
                     <svg xmlns="http://www.w3.org/2000/svg" height="26px" viewBox="0 -960 960 960" width="26px"><path d="M160-120q-33 0-56.5-23.5T80-200v-560q0-33 23.5-56.5T160-840h640q33 0 56.5 23.5T880-760v560q0 33-23.5 56.5T800-120H160Zm0-60h640v-560H160v560Zm80-80h480v-80H240v80Zm0-120h480v-80H240v80Zm0-120h320v-80H240v80Z"/></svg>
                     Text සාරාංශකරණය (Text/Image/PDF)
                 </h2>
                  <button class="back-to-home-button" title="ආපසු මුල් පිටුවට">
                     <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="18px"><path d="M400-80 0-480l400-400 71 71-329 329 329 329-71 71Z"/></svg>
                      ආපසු
                 </button>
             </div>
             <label for="summarizeText">සාරාංශ කිරීමට අවශ්‍ය දීර්ඝ පාඨය හෝ උපදෙස් (වෛකල්පිත):</label>
             <textarea id="summarizeText" rows="4" placeholder="සාරාංශ කිරීමට අවශ්‍ය සම්පූර්ණ ලිපිය, කතාව හෝ වාර්තාව මෙහි අලවන්න, නැතහොත් ගොනුවක් Upload කරන්න..." data-storage-key="input_summarizeText"></textarea>

             <label>හෝ සාරාංශ කිරීමට ඡායාරූපයක්/PDF එක් කරන්න (වෛකල්පිත):</label>
             <div class="file-input-area">
                 <div class="file-input-wrapper">
                     <input type="file" id="summarizeFile" accept="image/*,application/pdf" data-display-id="fileNameDisplaySummarize" data-storage-key="file_summarizeFile">
                     <span class="file-input-label">
                         <svg xmlns="http://www.w3.org/2000/svg" height="22px" viewBox="0 -960 960 960" width="22px"><path d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h360v80H200v560h560v-280h80v280q0 33-23.5 56.5T760-120H200Zm480-480v-80h-80v-80h80v-80h80v80h80v80h-80v80h-80ZM240-280h480L570-480 450-320l-90-120-120 160Z"/></svg>
                          ගොනුවක් තෝරන්න (Image/PDF)
                     </span>
                 </div>
                  <button class="capture-button" data-target-input="summarizeFile">
                     <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="18px"><path d="M160-200q-33 0-56.5-23.5T80-280v-400q0-33 23.5-56.5T160-760h126l74-80h240l74 80h126q33 0 56.5 23.5T880-680v400q0 33-23.5 56.5T800-200H160Zm0-80h640v-400H160v400Zm320-60q66 0 113-47t47-113q0-66-47-113t-113-47q-66 0-113 47t-47 113q0 66 47 113t113 47Zm0-80q-33 0-56.5-23.5T380-520q0-33 23.5-56.5T480-600q33 0 56.5 23.5T560-520q0 33-23.5 56.5T480-440ZM160-280h640v-400H160v400Z"/></svg>
                     කැමරාවෙන් ලබාගන්න
                 </button>
            </div>
             <div id="fileNameDisplaySummarize" class="file-name-display"></div>

             <div class="button-group">
                <button id="submitSummarizeBtn" class="api-button" data-processing-key="processing_summarize" data-result-id="summarizeResult">
                    <svg xmlns="http://www.w3.org/2000/svg" height="19px" viewBox="0 -960 960 960" width="19px"><path d="M160-120q-33 0-56.5-23.5T80-200v-560q0-33 23.5-56.5T160-840h640q33 0 56.5 23.5T880-760v560q0 33-23.5 56.5T800-120H160Zm0-60h640v-560H160v560Zm80-80h480v-80H240v80Zm0-120h480v-80H240v80Zm0-120h320v-80H240v80Z"/></svg>
                    සාරාංශය ලබාගන්න
                </button>
                 <button class="clear-button" data-target-inputs="summarizeText,summarizeFile" data-target-result="summarizeResult" data-target-display="fileNameDisplaySummarize">
                    <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="18px"><path d="M280-120q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520ZM360-280h80v-360h-80v360Zm160 0h80v-360h-80v360ZM280-720v520-520Z"/></svg>
                    මකන්න
                 </button>
             </div>
             <div id="summarizeResult" class="result-box" data-storage-key="result_summarizeResult"><p>සාරාංශය මෙහි දිස්වනු ඇත.</p></div>
         </div>

         <!-- Section 6: Code Generation -->
         <div id="code-gen-section" class="tool-section hidden">
             <div class="tool-section-header">
                 <h2>
                      <svg xmlns="http://www.w3.org/2000/svg" height="26px" viewBox="0 -960 960 960" width="26px"><path d="m313-170-143-64 143-64 64 143-64 143Zm334 0L583-313l64-143 143 64-64 143ZM480-80 313-440l167-74 167 74L480-80Zm0-400L240-617l57-143L480-880l183 120 57 143L480-480Z"/></svg>
                     කේත (Code) උත්පාදනය
                 </h2>
                  <button class="back-to-home-button" title="ආපසු මුල් පිටුවට">
                     <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="18px"><path d="M400-80 0-480l400-400 71 71-329 329 329 329-71 71Z"/></svg>
                      ආපසු
                 </button>
             </div>
             <label for="codeGenPrompt">කේතය සෑදීමට අවශ්‍ය කාර්යය විස්තර කරන්න:</label>
             <textarea id="codeGenPrompt" rows="5" placeholder="උදා: 'Python වලින් CSV file එකක් කියවා data print කරන function එකක් ලියන්න' හෝ 'HTML සහ CSS වලින් සරල login form එකක් හදන්න'..." data-storage-key="input_codeGenPrompt"></textarea>
              <label for="codeGenLang">කේත භාෂාව (වෛකල්පිත):</label>
              <input type="text" id="codeGenLang" placeholder="උදා: Python, JavaScript, Java, C++, HTML, CSS" data-storage-key="input_codeGenLang">
              <div class="button-group">
                <button id="submitCodeGenBtn" class="api-button" data-processing-key="processing_codeGen" data-result-id="codeGenResult">
                    <svg xmlns="http://www.w3.org/2000/svg" height="19px" viewBox="0 -960 960 960" width="19px"><path d="M320-240 80-480l240-240 57 57-183 183 183 183-57 57Zm320 0-57-57 183-183-183-183 57-57 240 240-240 240Z"/></svg>
                    කේතය සාදන්න
                </button>
                 <button class="clear-button" data-target-inputs="codeGenPrompt,codeGenLang" data-target-result="codeGenResult">
                     <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="18px"><path d="M280-120q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520ZM360-280h80v-360h-80v360Zm160 0h80v-360h-80v360ZM280-720v520-520Z"/></svg>
                    මකන්න
                 </button>
              </div>
             <div id="codeGenResult" class="result-box" data-storage-key="result_codeGenResult"><p>උත්පාදනය කළ කේතය මෙහි දිස්වනු ඇත.</p></div>
         </div>

         <!-- Section 7: MCQ Paper Marking -->
        <div id="mcq-marking-section" class="tool-section hidden">
            <div class="tool-section-header">
                 <h2>
                     <svg xmlns="http://www.w3.org/2000/svg" height="26px" viewBox="0 -960 960 960" width="26px"><path d="M280-280q17 0 28.5-11.5T320-320q0-17-11.5-28.5T280-360q-17 0-28.5 11.5T240-320q0 17 11.5 28.5T280-280Zm0 160q17 0 28.5-11.5T320-160q0-17-11.5-28.5T280-200q-17 0-28.5 11.5T240-160q0 17 11.5 28.5T280-120Zm0 160q17 0 28.5-11.5T320 0q0-17-11.5-28.5T280-40q-17 0-28.5 11.5T240 0q0 17 11.5 28.5T280 40Zm120-320v-80h400v80H400Zm0 160v-80h400v80H400Zm0 160v-80h400v80H400ZM160-80q-33 0-56.5-23.5T80-160v-640q0-33 23.5-56.5T160-880h640q33 0 56.5 23.5T880-800v640q0 33-23.5 56.5T800-80H160Zm0-60h640v-640H160v640Zm0 0v-640 640Z"/></svg>
                     MCQ පත්‍ර ලකුණු කිරීම (Image/PDF)
                 </h2>
                  <button class="back-to-home-button" title="ආපසු මුල් පිටුවට">
                     <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="18px"><path d="M400-80 0-480l400-400 71 71-329 329 329 329-71 71Z"/></svg>
                      ආපසු
                 </button>
            </div>

             <label>නිවැරදි පිළිතුරු පත්‍රය (Answer Key - Image/PDF) Upload කරන්න:</label>
             <div class="file-input-area">
                 <div class="file-input-wrapper">
                     <input type="file" id="mcqAnswerKeyImage" accept="image/*,application/pdf" data-display-id="mcqAnswerKeyDisplay" data-storage-key="file_mcqAnswerKeyImage">
                     <span class="file-input-label">
                         <svg xmlns="http://www.w3.org/2000/svg" height="22px" viewBox="0 -960 960 960" width="22px"><path d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h360v80H200v560h560v-280h80v280q0 33-23.5 56.5T760-120H200Zm480-480v-80h-80v-80h80v-80h80v80h80v80h-80v80h-80ZM240-280h480L570-480 450-320l-90-120-120 160Z"/></svg>
                          Answer Key ගොනුව තෝරන්න (Image/PDF)
                     </span>
                 </div>
                  <button class="capture-button" data-target-input="mcqAnswerKeyImage">
                     <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="18px"><path d="M160-200q-33 0-56.5-23.5T80-280v-400q0-33 23.5-56.5T160-760h126l74-80h240l74 80h126q33 0 56.5 23.5T880-680v400q0 33-23.5 56.5T800-200H160Zm0-80h640v-400H160v400Zm320-60q66 0 113-47t47-113q0-66-47-113t-113-47q-66 0-113 47t-47 113q0 66 47 113t113 47Zm0-80q-33 0-56.5-23.5T380-520q0-33 23.5-56.5T480-600q33 0 56.5 23.5T560-520q0 33-23.5 56.5T480-440ZM160-280h640v-400H160v400Z"/></svg>
                     කැමරාවෙන් ලබාගන්න
                 </button>
            </div>
             <div id="mcqAnswerKeyDisplay" class="file-name-display"></div>

              <label>ලකුණු කිරීමට අවශ්‍ය ශිෂ්‍යයාගේ MCQ පත්‍රය (Image/PDF) Upload කරන්න:</label>
             <div class="file-input-area">
                 <div class="file-input-wrapper">
                     <input type="file" id="mcqStudentPaperImage" accept="image/*,application/pdf" data-display-id="mcqStudentPaperDisplay" data-storage-key="file_mcqStudentPaperImage">
                     <span class="file-input-label">
                         <svg xmlns="http://www.w3.org/2000/svg" height="22px" viewBox="0 -960 960 960" width="22px"><path d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h360v80H200v560h560v-280h80v280q0 33-23.5 56.5T760-120H200Zm480-480v-80h-80v-80h80v-80h80v80h80v80h-80v80h-80ZM240-280h480L570-480 450-320l-90-120-120 160Z"/></svg>
                           ශිෂ්‍ය පත්‍රයේ ගොනුව තෝරන්න (Image/PDF)
                     </span>
                 </div>
                  <button class="capture-button" data-target-input="mcqStudentPaperImage">
                     <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="18px"><path d="M160-200q-33 0-56.5-23.5T80-280v-400q0-33 23.5-56.5T160-760h126l74-80h240l74 80h126q33 0 56.5 23.5T880-680v400q0 33-23.5 56.5T800-200H160Zm0-80h640v-400H160v400Zm320-60q66 0 113-47t47-113q0-66-47-113t-113-47q-66 0-113 47t-47 113q0 66 47 113t113 47Zm0-80q-33 0-56.5-23.5T380-520q0-33 23.5-56.5T480-600q33 0 56.5 23.5T560-520q0 33-23.5 56.5T480-440ZM160-280h640v-400H160v400Z"/></svg>
                     කැමරාවෙන් ලබාගන්න
                 </button>
            </div>
             <div id="mcqStudentPaperDisplay" class="file-name-display"></div>

             <div class="button-group">
                <button id="submitMcqMarking" class="api-button" data-processing-key="processing_mcqMarking" data-result-id="mcqMarkingResult">
                    <svg xmlns="http://www.w3.org/2000/svg" height="19px" viewBox="0 -960 960 960" width="19px"><path d="m424-296 282-282-56-56-226 226-114-114-56 56 170 170Zm56 216q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-60q142 0 241-99.5T820-480q0-142-99-241t-241-99q-141 0-240.5 99T140-480q0 141 99.5 240.5T480-140Zm0-340Z"/></svg>
                     ලකුණු කරන්න
                </button>
                 <button class="clear-button" data-target-inputs="mcqAnswerKeyImage,mcqStudentPaperImage" data-target-result="mcqMarkingResult" data-target-display="mcqAnswerKeyDisplay,mcqStudentPaperDisplay">
                     <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="18px"><path d="M280-120q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520ZM360-280h80v-360h-80v360Zm160 0h80v-360h-80v360ZM280-720v520-520Z"/></svg>
                    මකන්න
                 </button>
             </div>
             <div id="mcqMarkingResult" class="result-box" data-storage-key="result_mcqMarkingResult"><p>ලකුණු කිරීමේ ප්‍රතිඵල මෙහි දිස්වනු ඇත.</p></div>
        </div>

         <!-- Section 8: Answer Generation from Paper (General) -->
        <div id="answer-gen-section" class="tool-section hidden">
            <div class="tool-section-header">
                 <h2>
                     <svg xmlns="http://www.w3.org/2000/svg" height="26px" viewBox="0 -960 960 960" width="26px"><path d="M480-320q75 0 127.5-52.5T660-500q0-75-52.5-127.5T480-680q-75 0-127.5 52.5T300-500q0 75 52.5 127.5T480-320Zm0-70q-46 0-78-32t-32-78q0-46 32-78t78-32q46 0 78 32t32 78q0 46-32 78t-78 32Zm0 190q-116 0-214-67.5T138-440h-58v-60h58q2-10 3.5-20t3.5-20q-14-40-21-79t-7-81q0-100 55-177t147-117q37 5 74 5t74-5q92 40 147 117t55 177q0 42-7 81t-21 79q2 10 3.5 20t3.5 20h58v60h-58q-48 85-128 132.5T480-100Zm0-70q57 0 107.5-27t88.5-73H284q38 46 88.5 73T480-170Zm176-155q-2-8-4-16.5t-5-18.5q13-37 19-72.5t6-72.5q0-75-40.5-130T528-710q-32 3-64 3t-64-3q-67 34-107.5 89T252-495q0 37 6 72.5t19 72.5q-3 10-5 18.5T268-325h388Z"/></svg>
                     ප්‍රශ්න පත්‍රයට පිළිතුරු උත්පාදනය (Image/PDF - General)
                 </h2>
                  <button class="back-to-home-button" title="ආපසු මුල් පිටුවට">
                     <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="18px"><path d="M400-80 0-480l400-400 71 71-329 329 329 329-71 71Z"/></svg>
                      ආපසු
                 </button>
            </div>
             <label>පිළිතුරු උත්පාදනය කිරීමට ප්‍රශ්න පත්‍රයේ (Image/PDF) Upload කරන්න:</label>
             <div class="file-input-area">
                 <div class="file-input-wrapper">
                     <input type="file" id="answerGenPaperImage" accept="image/*,application/pdf" data-display-id="answerGenPaperDisplay" data-storage-key="file_answerGenPaperImage">
                     <span class="file-input-label">
                          <svg xmlns="http://www.w3.org/2000/svg" height="22px" viewBox="0 -960 960 960" width="22px"><path d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h360v80H200v560h560v-280h80v280q0 33-23.5 56.5T760-120H200Zm480-480v-80h-80v-80h80v-80h80v80h80v80h-80v80h-80ZM240-280h480L570-480 450-320l-90-120-120 160Z"/></svg>
                           ප්‍රශ්න පත්‍ර ගොනුව තෝරන්න (Image/PDF)
                     </span>
                 </div>
                  <button class="capture-button" data-target-input="answerGenPaperImage">
                     <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="18px"><path d="M160-200q-33 0-56.5-23.5T80-280v-400q0-33 23.5-56.5T160-760h126l74-80h240l74 80h126q33 0 56.5 23.5T880-680v400q0 33-23.5 56.5T800-200H160Zm0-80h640v-400H160v400Zm320-60q66 0 113-47t47-113q0-66-47-113t-113-47q-66 0-113 47t-47 113q0 66 47 113t113 47Zm0-80q-33 0-56.5-23.5T380-520q0-33 23.5-56.5T480-600q33 0 56.5 23.5T560-520q0 33-23.5 56.5T480-440ZM160-280h640v-400H160v400Z"/></svg>
                     කැමරාවෙන් ලබාගන්න
                 </button>
            </div>
             <div id="answerGenPaperDisplay" class="file-name-display"></div>

             <div class="button-group">
                <button id="submitAnswerGen" class="api-button" data-processing-key="processing_answerGen" data-result-id="answerGenResult">
                    <svg xmlns="http://www.w3.org/2000/svg" height="19px" viewBox="0 -960 960 960" width="19px"><path d="M320-242 140-422l58-58 122 122 280-280 58 58-338 338ZM480-80q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-60q142 0 241-99.5T820-480q0-142-99-241t-241-99q-141 0-240.5 99T140-480q0 141 99.5 240.5T480-140Z"/></svg>
                     පිළිතුරු ලබාගන්න
                </button>
                 <button class="clear-button" data-target-inputs="answerGenPaperImage" data-target-result="answerGenResult" data-target-display="answerGenPaperDisplay">
                     <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="18px"><path d="M280-120q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520ZM360-280h80v-360h-80v360Zm160 0h80v-360h-80v360ZM280-720v520-520Z"/></svg>
                    මකන්න
                 </button>
             </div>
             <div id="answerGenResult" class="result-box" data-storage-key="result_answerGenResult"><p>උත්පාදනය කළ පිළිතුරු මෙහි දිස්වනු ඇත.</p></div>
        </div>

        <!-- Section 9: Answer Generation for Section II -->
        <div id="section-two-section" class="tool-section hidden">
             <div class="tool-section-header">
                 <h2>
                      <svg xmlns="http://www.w3.org/2000/svg" height="26px" viewBox="0 -960 960 960" width="26px"><path d="M220-80q-24.75 0-42.375-17.625T160-140v-400h640v400q0 24.75-17.625 42.375T740-80H220Zm0-60h520v-400H220v400Zm0 180q-33 0-56.5-23.5T140-20v-120h60v120h560v-120h60v120q0 33-23.5 56.5T740-20H140Zm80-520h360v-80H300v80Zm0 120h360v-80H300v80Zm0-280h360v-80H300v80ZM220-140v-400 400Z"/></svg>
                     ප්‍රශ්න පත්‍රයේ II කොටසට පිළිතුරු (AI - Image/PDF)
                 </h2>
                  <button class="back-to-home-button" title="ආපසු මුල් පිටුවට">
                     <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="18px"><path d="M400-80 0-480l400-400 71 71-329 329 329 329-71 71Z"/></svg>
                      ආපසු
                 </button>
            </div>
             <label>II කොටසේ ප්‍රශ්න පත්‍රයේ (Image/PDF) Upload කරන්න:</label>
             <div class="file-input-area">
                 <div class="file-input-wrapper">
                     <input type="file" id="sectionTwoPaperImage" accept="image/*,application/pdf" data-display-id="sectionTwoFileNameDisplay" data-storage-key="file_sectionTwoPaperImage">
                     <span class="file-input-label">
                          <svg xmlns="http://www.w3.org/2000/svg" height="22px" viewBox="0 -960 960 960" width="22px"><path d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h360v80H200v560h560v-280h80v280q0 33-23.5 56.5T760-120H200Zm480-480v-80h-80v-80h80v-80h80v80h80v80h-80v80h-80ZM240-280h480L570-480 450-320l-90-120-120 160Z"/></svg>
                           II කොටසේ ගොනුව තෝරන්න (Image/PDF)
                     </span>
                 </div>
                  <button class="capture-button" data-target-input="sectionTwoPaperImage">
                     <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="18px"><path d="M160-200q-33 0-56.5-23.5T80-280v-400q0-33 23.5-56.5T160-760h126l74-80h240l74 80h126q33 0 56.5 23.5T880-680v400q0 33-23.5 56.5T800-200H160Zm0-80h640v-400H160v400Zm320-60q66 0 113-47t47-113q0-66-47-113t-113-47q-66 0-113 47t-47 113q0 66 47 113t113 47Zm0-80q-33 0-56.5-23.5T380-520q0-33 23.5-56.5T480-600q33 0 56.5 23.5T560-520q0 33-23.5 56.5T480-440ZM160-280h640v-400H160v400Z"/></svg>
                     කැමරාවෙන් ලබාගන්න
                 </button>
            </div>
             <div id="sectionTwoFileNameDisplay" class="file-name-display"></div>

             <div class="button-group">
                <button id="submitSectionTwoAnswers" class="api-button" data-processing-key="processing_sectionTwo" data-result-id="sectionTwoResult">
                    <svg xmlns="http://www.w3.org/2000/svg" height="19px" viewBox="0 -960 960 960" width="19px"><path d="M320-242 140-422l58-58 122 122 280-280 58 58-338 338ZM480-80q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-60q142 0 241-99.5T820-480q0-142-99-241t-241-99q-141 0-240.5 99T140-480q0 141 99.5 240.5T480-140Z"/></svg>
                     II කොටසට පිළිතුරු ලබාගන්න
                </button>
                 <button class="clear-button" data-target-inputs="sectionTwoPaperImage" data-target-result="sectionTwoResult" data-target-display="sectionTwoFileNameDisplay">
                     <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="18px"><path d="M280-120q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520ZM360-280h80v-360h-80v360Zm160 0h80v-360h-80v360ZM280-720v520-520Z"/></svg>
                    මකන්න
                 </button>
             </div>
             <div id="sectionTwoResult" class="result-box" data-storage-key="result_sectionTwoResult"><p>II කොටසට උත්පාදනය කළ දීර්ඝ පිළිතුරු මෙහි දිස්වනු ඇත.</p></div>
        </div>

        <!-- Section 10: Scientific Calculator -->
        <div id="calculator-section" class="tool-section hidden">
            <div class="tool-section-header">
                <h2>
                    <svg xmlns="http://www.w3.org/2000/svg" height="26px" viewBox="0 -960 960 960" width="26px"><path d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h560q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H200Zm0-60h560v-560H200v560Zm180-80h200v-60H380v60Zm-88-140h80v-80h80v80h80v-80h80v80h80v-60H620v-80h-80v80h-80v-80h-80v80h-80v-80h-80v60Zm88 0h80v-80h-80v80Zm160 0h80v-80h-80v80Z"/></svg>
                    විද්‍යාත්මක කැල්කියුලේටරය
                </h2>
                 <button class="back-to-home-button" title="ආපසු මුල් පිටුවට">
                     <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="18px"><path d="M400-80 0-480l400-400 71 71-329 329 329 329-71 71Z"/></svg>
                      ආපසු
                 </button>
            </div>
            <div id="calculator">
                <input type="text" id="calculator-display" value="0" readonly data-storage-key="input_calculatorDisplay">
                <div class="calculator-buttons">
                    <!-- Functions Row 1 -->
                    <button onclick="appendFunction('Math.sin(')" class="function">sin</button>
                    <button onclick="appendFunction('Math.cos(')" class="function">cos</button>
                    <button onclick="appendFunction('Math.tan(')" class="function">tan</button>
                    <button onclick="appendFunction('Math.log10(')" class="function">log</button>
                    <button onclick="appendFunction('Math.log(')" class="function">ln</button>
                     <!-- Functions Row 2 -->
                    <button onclick="appendOperator('(')" class="operator">(</button>
                    <button onclick="appendOperator(')')" class="operator">)</button>
                    <button onclick="appendOperator('**')" class="operator">xʸ</button>
                    <button onclick="appendFunction('Math.sqrt(')" class="function">√</button>
                    <button onclick="clearDisplay()" class="clear">AC</button>
                    <!-- Numbers & Ops -->
                    <button onclick="appendNumber('7')">7</button>
                    <button onclick="appendNumber('8')">8</button>
                    <button onclick="appendNumber('9')">9</button>
                    <button onclick="deleteLast()" class="operator">DEL</button>
                    <button onclick="appendOperator('/')" class="operator">÷</button>

                    <button onclick="appendNumber('4')">4</button>
                    <button onclick="appendNumber('5')">5</button>
                    <button onclick="appendNumber('6')">6</button>
                    <button onclick="appendOperator('*')" class="operator">×</button>
                    <button onclick="appendOperator('%')" class="operator">%</button>

                    <button onclick="appendNumber('1')">1</button>
                    <button onclick="appendNumber('2')">2</button>
                    <button onclick="appendNumber('3')">3</button>
                    <button onclick="appendOperator('-')" class="operator">-</button>
                     <button onclick="appendConstant('Math.PI')" class="function">π</button>

                    <button onclick="appendNumber('0')">0</button>
                    <button onclick="appendDecimal()">.</button>
                    <button onclick="appendConstant('Math.E')" class="function">e</button>
                     <button onclick="toggleSign()" class="operator">+/-</button>
                    <button onclick="calculateResult()" class="equals">=</button>
                </div>
            </div>
            <input type="hidden" id="calculator-expression" data-storage-key="input_calculatorExpression">
        </div>

         <!-- Section 11: Number Base Converter -->
        <div id="base-converter-section" class="tool-section hidden">
            <div class="tool-section-header">
                 <h2>
                     <svg xmlns="http://www.w3.org/2000/svg" height="26px" viewBox="0 -960 960 960" width="26px"><path d="M220-80q-24.75 0-42.375-17.625T160-140v-680q0-24.75 17.625-42.375T220-880h520q24.75 0 42.375 17.625T800-820v680q0 24.75-17.625 42.375T740-80H220Zm0-60h520v-680H220v680Zm80-80h360v-80H300v80Zm0-160h360v-80H300v80Zm0-160h360v-80H300v80Zm0-160h360v-80H300v80ZM220-140v-680 680Z"/></svg>
                     සංඛ්‍යා පාද පරිවර්තකය
                 </h2>
                  <button class="back-to-home-button" title="ආපසු මුල් පිටුවට">
                     <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="18px"><path d="M400-80 0-480l400-400 71 71-329 329 329 329-71 71Z"/></svg>
                      ආපසු
                 </button>
             </div>
             <div class="base-converter-grid">
                 <label for="decimalInput">දශමය (10):</label>
                 <input type="text" id="decimalInput" placeholder="Decimal අගය" oninput="convertBase('decimal', this.value)" data-storage-key="input_decimalInput">

                 <label for="binaryInput">ද්විමය (2):</label>
                 <input type="text" id="binaryInput" placeholder="Binary අගය" oninput="convertBase('binary', this.value)" data-storage-key="input_binaryInput">

                 <label for="octalInput">අෂ්ටමය (8):</label>
                 <input type="text" id="octalInput" placeholder="Octal අගය" oninput="convertBase('octal', this.value)" data-storage-key="input_octalInput">

                 <label for="hexInput">ෂඩ්දශමය (16):</label>
                 <input type="text" id="hexInput" placeholder="Hexadecimal අගය" oninput="convertBase('hex', this.value)" data-storage-key="input_hexInput">
             </div>
              <div id="baseConverterError" class="result-box error hidden"></div>
               <div class="button-group" style="justify-content: flex-end;">
                   <!-- Changed to action-button class for consistent styling -->
                   <button class="clear-button action-button" onclick="clearBaseInputs(null, true); hideBaseConverterError();">
                       <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="18px"><path d="M280-120q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520ZM360-280h80v-360h-80v360Zm160 0h80v-360h-80v360ZM280-720v520-520Z"/></svg>
                       සියල්ල මකන්න
                   </button>
               </div>
        </div>


    </div> <!-- End Container -->

    <script>
        const GEMINI_API_KEY = "AIzaSyArZSyD2A00WCWEzYjRwy_967DrSRybv3g"; // <<<--- WARNING: Insecure! Replace or use backend
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;
        const STORAGE_PREFIX = "gaviruApp_v2_"; // Updated prefix for new structure
        const ACTIVE_SECTION_KEY = "activeSection";

        // --- DOM Elements ---
        const themeToggle = document.getElementById('themeToggle');
        const htmlElement = document.documentElement;
        const loadingOverlay = document.getElementById('loading-overlay');
        const bodyElement = document.body;
        const containerElement = document.querySelector('.container'); // Get container for section positioning later if needed

        // Navigation & Sections
        const homeSection = document.getElementById('home-section');
        const toolSections = document.querySelectorAll('.tool-section');
        const navButtons = document.querySelectorAll('.nav-button');
        const backButtons = document.querySelectorAll('.back-to-home-button');

        // --- Tool Section Specific Elements ---
        const aiCombinedPrompt = document.getElementById('aiCombinedPrompt');
        const aiCombinedImage = document.getElementById('aiCombinedImage');
        const submitCombinedAI = document.getElementById('submitCombinedAI');
        const aiCombinedResult = document.getElementById('aiCombinedResult');
        const fileNameDisplayCombined = document.getElementById('fileNameDisplayCombined');

        const chatHistory = document.getElementById('chatHistory');
        const chatInput = document.getElementById('chatInput');
        const chatImageInput = document.getElementById('chatImageInput');
        const fileNameDisplayChat = document.getElementById('fileNameDisplayChat');
        const sendChatMessage = document.getElementById('sendChatMessage');
        const clearChatButton = document.getElementById('clearChatButton');
        let conversationHistory = [];

        const translateText = document.getElementById('translateText');
        const translateImage = document.getElementById('translateImage');
        const translateLang = document.getElementById('translateLang');
        const submitTranslateBtn = document.getElementById('submitTranslateBtn');
        const translateResult = document.getElementById('translateResult');
        const fileNameDisplayTranslate = document.getElementById('fileNameDisplayTranslate');

        const ocrImageFile = document.getElementById('ocrImageFile');
        const submitOcrImageBtn = document.getElementById('submitOcrImageBtn');
        const ocrImageResult = document.getElementById('ocrImageResult');
        const ocrFileNameDisplay = document.getElementById('ocrFileNameDisplay');

        const unicodeInputText = document.getElementById('unicodeInputText');
        const unicodeInputFile = document.getElementById('unicodeInputFile');
        const submitUnicodeConvert = document.getElementById('submitUnicodeConvert');
        const unicodeResult = document.getElementById('unicodeResult');
        const unicodeFileNameDisplay = document.getElementById('unicodeFileNameDisplay');

        const summarizeText = document.getElementById('summarizeText');
        const summarizeFile = document.getElementById('summarizeFile');
        const submitSummarizeBtn = document.getElementById('submitSummarizeBtn');
        const summarizeResult = document.getElementById('summarizeResult');
        const fileNameDisplaySummarize = document.getElementById('fileNameDisplaySummarize');

        const codeGenPrompt = document.getElementById('codeGenPrompt');
        const codeGenLang = document.getElementById('codeGenLang');
        const submitCodeGenBtn = document.getElementById('submitCodeGenBtn');
        const codeGenResult = document.getElementById('codeGenResult');

        const mcqAnswerKeyImage = document.getElementById('mcqAnswerKeyImage');
        const mcqStudentPaperImage = document.getElementById('mcqStudentPaperImage');
        const submitMcqMarking = document.getElementById('submitMcqMarking');
        const mcqMarkingResult = document.getElementById('mcqMarkingResult');
        const mcqAnswerKeyDisplay = document.getElementById('mcqAnswerKeyDisplay');
        const mcqStudentPaperDisplay = document.getElementById('mcqStudentPaperDisplay');

        const answerGenPaperImage = document.getElementById('answerGenPaperImage');
        const submitAnswerGen = document.getElementById('submitAnswerGen');
        const answerGenResult = document.getElementById('answerGenResult');
        const answerGenPaperDisplay = document.getElementById('answerGenPaperDisplay');

        const sectionTwoPaperImage = document.getElementById('sectionTwoPaperImage');
        const submitSectionTwoAnswers = document.getElementById('submitSectionTwoAnswers');
        const sectionTwoResult = document.getElementById('sectionTwoResult');
        const sectionTwoFileNameDisplay = document.getElementById('sectionTwoFileNameDisplay');

        const calculatorDisplay = document.getElementById('calculator-display');
        const calculatorExpressionInput = document.getElementById('calculator-expression');

        const decimalInput = document.getElementById('decimalInput');
        const binaryInput = document.getElementById('binaryInput');
        const octalInput = document.getElementById('octalInput');
        const hexInput = document.getElementById('hexInput');
        const baseConverterError = document.getElementById('baseConverterError');

        const allInputs = document.querySelectorAll('[data-storage-key]');
        const apiButtons = document.querySelectorAll('.api-button');
        const clearButtons = document.querySelectorAll('.clear-button');
        const fileInputs = document.querySelectorAll('input[type="file"]');
        const captureButtons = document.querySelectorAll('button.capture-button');


        // --- Local Storage Helper Functions ---
        function saveToStorage(key, value) {
            try {
                localStorage.setItem(STORAGE_PREFIX + key, value);
            } catch (e) { console.error("Error saving to localStorage:", e); }
        }
        function loadFromStorage(key) {
            try { return localStorage.getItem(STORAGE_PREFIX + key); }
            catch (e) { console.error("Error loading from localStorage:", e); return null; }
        }
        function removeFromStorage(key) {
            try { localStorage.removeItem(STORAGE_PREFIX + key); }
            catch (e) { console.error("Error removing from localStorage:", e); }
        }

        // --- Helper Functions ---
        function showLoading(resultElement) {
            if (resultElement.id !== 'chatHistory') {
                 resultElement.innerHTML = '';
                 resultElement.classList.remove('error');
                 resultElement.classList.add('loading');
                 resultElement.style.display = 'block';
                 const overlay = document.createElement('div');
                 overlay.className = 'loading-overlay';
                 const lottie = document.createElement('lottie-player');
                 lottie.src = 'https://assets10.lottiefiles.com/packages/lf20_p8bfn5to.json';
                 lottie.background = 'transparent'; lottie.speed = '1'; lottie.loop = true; lottie.autoplay = true;
                 overlay.appendChild(lottie);
                 resultElement.appendChild(overlay);
            }
        }
        function hideLoading(resultElement) {
             if (resultElement.id !== 'chatHistory') {
                resultElement.classList.remove('loading');
                const overlay = resultElement.querySelector('.loading-overlay');
                if (overlay) {
                     overlay.style.opacity = '0';
                     setTimeout(() => overlay.remove(), 400);
                }
             }
        }
        function showError(element, message) {
            hideLoading(element);
            element.classList.add('error');
             if (element.id === 'chatHistory') {
                 const errorDiv = document.createElement('div');
                 errorDiv.classList.add('chat-message', 'ai-message', 'error');
                 errorDiv.innerHTML = `<p><strong>දෝෂයකි:</strong> ${message}</p>`;
                 element.appendChild(errorDiv);
                 element.scrollTop = element.scrollHeight;
             } else {
                element.innerHTML = `<p><strong>දෝෂයකි:</strong> ${message}</p>`;
                element.style.display = 'block';
             }
        }
        function displayResult(element, text, isHtml = false, saveKey = null) {
             hideLoading(element);
             element.classList.remove('error');
             let contentToSave = '';
             let htmlContentResult = '';

             if (isHtml) {
                  htmlContentResult = text; contentToSave = text;
             } else {
                  let mdToHtml = text
                      .replace(/```(\w+)?\n([\s\S]*?)\n```/g, (match, lang, code) => {
                           const languageClass = lang ? ` class="language-${lang}"` : '';
                           const escapedCode = code.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                           return `<pre><code${languageClass}>${escapedCode.trim()}</code></pre>`;
                      })
                      .split('\n')
                      .reduce((acc, line) => {
                           const trimmedLine = line.trim();
                          if (trimmedLine.startsWith('* ') || trimmedLine.startsWith('- ')) {
                              if (!acc.inUl) { acc.html += '<ul>'; acc.inUl = true; }
                              acc.html += `<li>${trimmedLine.substring(2)}</li>`;
                          } else if (/^\d+\.\s/.test(trimmedLine)) {
                               if (!acc.inOl) { acc.html += '<ol>'; acc.inOl = true; }
                               acc.html += `<li>${trimmedLine.replace(/^\d+\.\s/, '')}</li>`;
                           } else {
                               if (acc.inUl) { acc.html += '</ul>'; acc.inUl = false; }
                               if (acc.inOl) { acc.html += '</ol>'; acc.inOl = false; }
                               if (line.startsWith('<pre>') || line.startsWith('<code>') || acc.inPre) {
                                   acc.html += line + '\n';
                                   if (line.includes('<pre>')) acc.inPre = true;
                                   if (line.includes('</pre>')) acc.inPre = false;
                               } else if (trimmedLine !== '') {
                                   acc.html += `<p>${line}</p>`;
                               }
                           }
                           return acc;
                       }, { html: '', inUl: false, inOl: false, inPre: false });
                 if (mdToHtml.inUl) mdToHtml.html += '</ul>';
                 if (mdToHtml.inOl) mdToHtml.html += '</ol>';
                  htmlContentResult = mdToHtml.html.trim(); contentToSave = htmlContentResult;
             }

              if (element.classList.contains('chat-message')) {
                  element.innerHTML = htmlContentResult;
              } else if (element.id === 'chatHistory') {
                  const aiMessageDiv = document.createElement('div');
                  aiMessageDiv.classList.add('chat-message', 'ai-message');
                  aiMessageDiv.innerHTML = htmlContentResult;
                  element.appendChild(aiMessageDiv);
                  element.scrollTop = element.scrollHeight;
              }
              else {
                 element.innerHTML = htmlContentResult;
                 element.style.display = 'block';
              }
             if (saveKey) { saveToStorage(saveKey, contentToSave); }
         }
        function showBaseConverterError(message) {
            baseConverterError.textContent = `දෝෂයකි: ${message}`;
            baseConverterError.classList.remove('hidden');
        }
        function hideBaseConverterError() {
            baseConverterError.classList.add('hidden'); baseConverterError.textContent = '';
        }
        function disableApiButtons(disabled) {
            apiButtons.forEach(btn => { if (btn) btn.disabled = disabled; });
        }
        function updateFileNameDisplay(inputElement) {
             const displayElementId = inputElement.getAttribute('data-display-id');
             if (!displayElementId) return;
             const displayIds = displayElementId.split(',');
             const file = inputElement.files && inputElement.files.length > 0 ? inputElement.files[0] : null;
             const fileName = file ? file.name : null;
             const storageKey = inputElement.getAttribute('data-storage-key');
             displayIds.forEach(id => {
                const display = document.getElementById(id.trim());
                 if (display) {
                     if (fileName) {
                         // Store minimal info needed for redisplay/chat history rendering
                         inputElement.dataset.fileInfo = JSON.stringify({ name: file.name, type: file.type });
                         display.textContent = `${fileName}`;
                         if(display.id !== 'fileNameDisplayChat') { display.innerHTML = `තෝරාගත් ගොනුව: ${fileName}`; }
                         if (storageKey) saveToStorage(storageKey, fileName); // Save just the name for redisplay hint
                     } else {
                         delete inputElement.dataset.fileInfo;
                         display.textContent = '';
                         if(display.id !== 'fileNameDisplayChat') { display.innerHTML = ''; }
                         if (storageKey) removeFromStorage(storageKey);
                     }
                 }
             });
        }
         function fileInputChangeHandler(event) { updateFileNameDisplay(event.target); }
         function clearSectionHandler(event) {
             const button = event.currentTarget;
             const inputSelectors = button.getAttribute('data-target-inputs')?.split(',');
             const resultSelector = button.getAttribute('data-target-result');
             const displaySelectors = button.getAttribute('data-target-display')?.split(',');
             if (inputSelectors) {
                 inputSelectors.forEach(selector => {
                     const input = document.getElementById(selector.trim());
                     if (input) {
                         const storageKey = input.getAttribute('data-storage-key');
                         if (storageKey) removeFromStorage(storageKey);
                         if (input.type === 'file') { input.value = null; delete input.dataset.fileInfo; } // Clear file info
                         else if (input.tagName === 'SELECT') { input.selectedIndex = 0; if (storageKey) saveToStorage(storageKey, input.value); }
                         else { input.value = ''; }
                     }
                 });
             }
             if (resultSelector) {
                 const resultBox = document.getElementById(resultSelector);
                 if (resultBox) {
                      const storageKey = resultBox.getAttribute('data-storage-key');
                      if (storageKey) removeFromStorage(storageKey);
                      if (resultBox.id !== 'chatHistory') {
                         let defaultMsg = '<p>ප්‍රතිචාරය මෙහි දිස්වනු ඇත.</p>';
                         // Add default messages for other sections
                         if (resultBox.id === 'ocrImageResult') defaultMsg = '<p>ගොනුවේ හඳුනාගත් අකුරු මෙහි දිස්වනු ඇත.</p>';
                         else if (resultBox.id === 'unicodeResult') defaultMsg = '<p>Unicode බවට පරිවර්තනය කළ text එක මෙහි දිස්වනු ඇත.</p>';
                         else if (resultBox.id === 'summarizeResult') defaultMsg = '<p>සාරාංශය මෙහි දිස්වනු ඇත.</p>';
                         else if (resultBox.id === 'codeGenResult') defaultMsg = '<p>උත්පාදනය කළ කේතය මෙහි දිස්වනු ඇත.</p>';
                         else if (resultBox.id === 'mcqMarkingResult') defaultMsg = '<p>ලකුණු කිරීමේ ප්‍රතිඵල මෙහි දිස්වනු ඇත.</p>';
                         else if (resultBox.id === 'answerGenResult') defaultMsg = '<p>උත්පාදනය කළ පිළිතුරු මෙහි දිස්වනු ඇත.</p>';
                         else if (resultBox.id === 'sectionTwoResult') defaultMsg = '<p>II කොටසට උත්පාදනය කළ දීර්ඝ පිළිතුරු මෙහි දිස්වනු ඇත.</p>';
                         else if (resultBox.id === 'translateResult') defaultMsg = '<p>පරිවර්තනය මෙහි දිස්වනු ඇත.</p>';
                         resultBox.innerHTML = defaultMsg;
                      }
                     resultBox.classList.remove('error', 'loading'); hideLoading(resultBox);
                 }
             }
             if (displaySelectors) {
                 displaySelectors.forEach(selector => { const display = document.getElementById(selector.trim()); if (display) display.textContent = ''; });
             }
         }

         // --- Function to call Gemini API ---
         async function callGeminiAPI(promptParts, resultElement, currentHistory = null, processingKey = null) {
             disableApiButtons(true);
             if(processingKey) saveToStorage(processingKey, 'true');
             const requestBody = { "contents": currentHistory ? currentHistory : [{ "parts": promptParts }] };
             showLoading(resultElement);

             try {
                 const response = await fetch(GEMINI_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestBody) });
                 if (!response.ok) {
                     let errorMsg = `API ඇමතුම අසාර්ථක විය (${response.status} ${response.statusText})`;
                     try {
                         const errorData = await response.json();
                         errorMsg += `. ${errorData?.error?.message || JSON.stringify(errorData?.error) || ''}`;
                         if (response.status === 403 || (response.status === 400 && errorData?.error?.message.includes("API key"))) errorMsg += " (API key වැරදියි හෝ අවසර නැත)";
                         else if (response.status === 429) errorMsg += " (ඉල්ලීම් සීමාව ඉක්මවා ඇත)";
                         else if (response.status === 400 && (errorData?.error?.message.includes("image") || errorData?.error?.message.includes("inline data") || errorData?.error?.message.includes("bytes"))) errorMsg += " (ගොනුවේ (image/pdf/etc.) දෝෂයක්, නොගැලපීමක් හෝ සහය නොදක්වන වර්ගයක් විය හැක)";
                         else if (response.status === 400 && errorData?.error?.message.includes("size")) errorMsg += " (ඉල්ලීමේ ප්‍රමාණය (text/file) ඉතා විශාලයි)";
                     } catch (e) { /* Ignore */ }
                     throw new Error(errorMsg);
                 }
                 const data = await response.json();
                 if (data.promptFeedback && data.promptFeedback.blockReason) { throw new Error(`ඉල්ලීම අවහිර කරන ලදී: ${data.promptFeedback.blockReason}.`); }
                 else if (data.candidates?.[0]?.content?.parts?.[0]?.text) {
                     const resultText = data.candidates[0].content.parts[0].text; const resultStorageKey = resultElement.getAttribute('data-storage-key');
                     const aiResponseForHistory = data.candidates[0].content;
                     if (resultElement.id === 'chatHistory') { displayResult(resultElement, resultText, false); }
                     else { displayResult(resultElement, resultText, false, resultStorageKey); }
                     return { text: resultText, aiResponseObject: aiResponseForHistory };
                 }
                 else if (data.candidates?.length > 0 && (!data.candidates[0].content || !data.candidates[0].content.parts || data.candidates[0].content.parts.length === 0)) {
                     const lastRequestParts = currentHistory ? currentHistory[currentHistory.length - 1].parts : promptParts;
                     const isOcrRequest = lastRequestParts.some(p => p.text && (p.text.toLowerCase().includes("extract all text") || p.text.toLowerCase().includes("extract text from")));
                     const noContentMessage = (isOcrRequest) ? "මෙම ගොනුවේ හඳුනාගත හැකි text එකක් සොයාගත නොහැකි විය." : "AI වෙතින් ප්‍රතිචාරයක් ලැබුනි, නමුත් එහි අන්තර්ගතයක් නොමැත.";
                     const resultStorageKey = resultElement.getAttribute('data-storage-key'); const aiResponseForHistory = { role: 'model', parts: [{ text: noContentMessage }] };
                     if (resultElement.id === 'chatHistory') { displayResult(resultElement, noContentMessage, false); }
                     else { displayResult(resultElement, noContentMessage, false, resultStorageKey); }
                     return { text: "", aiResponseObject: aiResponseForHistory };
                 }
                 else { console.warn("Unexpected API response structure:", data); throw new Error("AI වෙතින් වලංගු හෝ අපේක්ෂිත ආකාරයේ පිළිතුරක් නොලැබුණි."); }
             } catch (error) { console.error('Error calling Gemini API:', error); showError(resultElement, error.message); throw error; }
             finally { disableApiButtons(false); if(processingKey) removeFromStorage(processingKey); }
         }

        // --- Function to read ANY file as Base64 ---
         function readFileAsBase64(file) {
             return new Promise((resolve, reject) => {
                 if (!file) return reject(new Error("ගොනුවක් තෝරා නොමැත."));
                 const maxSize = 10 * 1024 * 1024; // 10MB limit (adjust if needed, Gemini Flash might have stricter limits for some types)
                 if (file.size > maxSize) { return reject(new Error(`ගොනුව ඉතා විශාලයි (උපරිමය: ${maxSize / 1024 / 1024}MB).`)); }

                 // Allow any file type, rely on Gemini to handle it or error out
                 // const isImage = file.type.startsWith('image/');
                 // const isPdf = file.type === 'application/pdf';
                 // if (!isImage && !isPdf) {
                 //     // Removed strict check - allow other types
                 //     console.warn(`Unsupported file type for direct processing: ${file.type}. Attempting to send anyway.`);
                 // }

                 const reader = new FileReader();
                 reader.onload = () => {
                     const base64String = reader.result.split(',')[1];
                     resolve({ base64String, mimeType: file.type || 'application/octet-stream', fileObject: file }); // Provide a default mime type
                 };
                 reader.onerror = (error) => reject(new Error(`ගොනුව කියවීමේදී දෝෂයකි: ${error}`));
                 reader.readAsDataURL(file);
             });
         }

        // --- Theme Switcher Logic ---
        function setInitialTheme() {
            const savedTheme = loadFromStorage('theme') || 'light';
            htmlElement.setAttribute('data-theme', savedTheme);
            themeToggle.checked = (savedTheme === 'dark');
            loadingOverlay.style.backgroundColor = getComputedStyle(htmlElement).getPropertyValue('--loader-bg');
        }
        themeToggle.addEventListener('change', () => {
            const newTheme = themeToggle.checked ? 'dark' : 'light';
            htmlElement.setAttribute('data-theme', newTheme);
            saveToStorage('theme', newTheme);
            loadingOverlay.style.backgroundColor = getComputedStyle(htmlElement).getPropertyValue('--loader-bg');
        });

         // --- Page Load & Navigation Logic ---
         window.addEventListener('load', () => {
             setTimeout(() => { // Reduced loading time
                 loadingOverlay.classList.add('hidden');
                 bodyElement.classList.add('loaded');
             }, 300); // Reduced from 500ms
         });

        function navigateToSection(targetSectionId) {
            // Hide all sections (home and tools)
            homeSection.classList.remove('active-section');
            homeSection.classList.add('hidden');
            toolSections.forEach(section => {
                section.classList.remove('active-section');
                section.classList.add('hidden');
            });

            // Show the target section
            const targetSection = document.getElementById(targetSectionId);
            if (targetSection) {
                targetSection.classList.remove('hidden');
                targetSection.classList.add('active-section');
                saveToStorage(ACTIVE_SECTION_KEY, targetSectionId); // Save the active section
                window.scrollTo({ top: 0, behavior: 'smooth' }); // Scroll to top
            } else {
                // Fallback to home if target not found
                homeSection.classList.remove('hidden');
                homeSection.classList.add('active-section');
                saveToStorage(ACTIVE_SECTION_KEY, 'home-section');
            }
        }

        // Add event listeners to navigation buttons
        navButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                e.preventDefault(); // Prevent default button action
                const targetId = button.getAttribute('data-target-section');
                if (targetId) {
                    navigateToSection(targetId);
                }
            });
        });

        // Add event listeners to back buttons
        backButtons.forEach(button => {
            button.addEventListener('click', () => {
                navigateToSection('home-section');
            });
        });


         // --- Load saved data from Local Storage ---
         function loadSavedState() {
             // Load theme first
             setInitialTheme();

             // Load input/result states
             allInputs.forEach(element => {
                 const key = element.getAttribute('data-storage-key');
                 if (!key) return;
                 const savedValue = loadFromStorage(key);
                 if (savedValue !== null) {
                     if (element.type === 'file') {
                          const displayId = element.getAttribute('data-display-id');
                           if (displayId) {
                                const displayIds = displayId.split(',');
                               displayIds.forEach(id => {
                                   const display = document.getElementById(id.trim());
                                    if (display && savedValue) {
                                         // Saved value is just the filename hint
                                         const baseText = display.id === 'fileNameDisplayChat' ? `${savedValue}` : `තෝරාගත් ගොනුව: ${savedValue}`;
                                         display.innerHTML = `${baseText} <span class="file-needs-reselect">(නැවත තෝරන්න)</span>`;
                                    }
                               });
                           }
                     } else if (element.tagName === 'TEXTAREA' || element.type === 'text' || element.type === 'hidden') { element.value = savedValue; }
                     else if (element.tagName === 'SELECT') { element.value = savedValue; }
                     else if (element.classList.contains('result-box') && element.id !== 'chatHistory') { element.innerHTML = savedValue; element.style.display = 'block'; }
                     else if (element.id === 'chatHistory') {
                         try {
                             const savedHistory = JSON.parse(savedValue);
                             if (Array.isArray(savedHistory) && savedHistory.length > 0) { conversationHistory = savedHistory; renderChatHistory(); }
                             else { renderChatHistory(true); }
                         } catch (e) { console.error("Error parsing saved chat history:", e); renderChatHistory(true); }
                     }
                 } else if (element.id === 'chatHistory' && conversationHistory.length === 0) { renderChatHistory(true); }
             });

             // Restore calculator state
             const savedDisplay = loadFromStorage('input_calculatorDisplay');
             const savedExpression = loadFromStorage('input_calculatorExpression');
             if (savedDisplay !== null) calculatorDisplay.value = savedDisplay;
             if (savedExpression !== null) currentExpression = savedExpression;
              shouldResetDisplay = (loadFromStorage('calculator_shouldReset') === 'true');

             // Check for interrupted processing
             apiButtons.forEach(button => {
                 const processingKey = button.getAttribute('data-processing-key');
                 const resultId = button.getAttribute('data-result-id');
                 if (processingKey && loadFromStorage(processingKey) === 'true') {
                     const resultElement = document.getElementById(resultId);
                     if (resultElement) {
                          hideLoading(resultElement);
                          const interruptMsg = `<p class="processing-interrupted">කලින් ක්‍රියාවලියට බාධා විය. කරුණාකර නැවත ඉදිරිපත් කරන්න.</p>`;
                          if(resultElement.id === 'chatHistory'){
                              const errorDiv = document.createElement('div'); errorDiv.classList.add('chat-message', 'ai-message', 'error'); errorDiv.innerHTML = interruptMsg;
                              resultElement.appendChild(errorDiv); resultElement.scrollTop = resultElement.scrollHeight;
                          } else { resultElement.innerHTML = interruptMsg + resultElement.innerHTML; resultElement.style.display = 'block'; }
                     }
                     removeFromStorage(processingKey);
                 }
             });

             // Load and show the last active section
            const lastActiveSection = loadFromStorage(ACTIVE_SECTION_KEY) || 'home-section';
            navigateToSection(lastActiveSection); // Navigate after loading content

             adjustChatInputHeight();
         }

         // --- Save input state to Local Storage ---
         function saveInputState(event) {
             const element = event.target;
             const key = element.getAttribute('data-storage-key');
             if (key) {
                 if (element.type === 'checkbox') { saveToStorage(key, element.checked); }
                 else if (element.type !== 'file') { saveToStorage(key, element.value); }
                 // File inputs are handled via updateFileNameDisplay saving only the name hint
             }
         }

         // --- Add Event Listeners for Input Saving ---
         allInputs.forEach(input => {
             if (input.tagName === 'TEXTAREA' || input.type === 'text' || input.type === 'hidden') { input.addEventListener('input', saveInputState); }
             else if (input.tagName === 'SELECT' || input.type === 'checkbox') { input.addEventListener('change', saveInputState); }
         });

         // --- Add Event Listeners for Clear Buttons ---
         clearButtons.forEach(button => { button.addEventListener('click', clearSectionHandler); });

         // --- Add Event Listeners for File Inputs ---
          fileInputs.forEach(input => { input.addEventListener('change', fileInputChangeHandler); });

        // --- Add Event Listeners for Camera Capture Buttons ---
         captureButtons.forEach(button => {
            button.addEventListener('click', () => {
                const targetInputId = button.getAttribute('data-target-input');
                const originalFileInput = document.getElementById(targetInputId);
                if (!originalFileInput) return;

                // Create a temporary file input for camera capture
                const tempInput = document.createElement('input');
                tempInput.type = 'file';
                tempInput.accept = 'image/*'; // Capture only images
                tempInput.capture = 'camera'; // Or 'user'/'environment'
                tempInput.style.display = 'none'; // Hide it

                tempInput.addEventListener('change', (event) => {
                    const capturedFile = event.target.files[0];
                    if (capturedFile) {
                        // Use DataTransfer to create a FileList for the original input
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(capturedFile);
                        originalFileInput.files = dataTransfer.files;

                        // Trigger the change event on the original input
                        originalFileInput.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                    document.body.removeChild(tempInput); // Clean up the temporary input
                });

                document.body.appendChild(tempInput);
                tempInput.click(); // Trigger the camera capture
            });
         });


        // --- Event Listeners for AI Functions ---

        // 1. Combined AI Interaction
        submitCombinedAI.addEventListener('click', async () => {
             const promptText = aiCombinedPrompt.value.trim(); const file = aiCombinedImage.files[0];
             const resultElement = aiCombinedResult; const processingKey = submitCombinedAI.getAttribute('data-processing-key');
             if (!promptText && !file) { showError(resultElement, 'කරුණාකර ප්‍රශ්නයක් ඇතුළත් කරන්න හෝ ගොනුවක් (Image/PDF) තෝරන්න.'); return; }
             let promptParts = []; let userPrompt = promptText || "Describe this image/document."; promptParts.push({ "text": userPrompt });
             let fileReadPromise = Promise.resolve(null);
             if (file) {
                   fileReadPromise = readFileAsBase64(file)
                       .then(({ base64String, mimeType }) => { promptParts.push({ "inline_data": { "mime_type": mimeType, "data": base64String } }); })
                       .catch(error => { showError(resultElement, `ගොනුව සැකසීමේ දෝෂයකි: ${error.message}`); disableApiButtons(false); throw error; });
             }
             try {
                  await fileReadPromise;
                  if (promptParts.some(part => part.text || part.inline_data)) { await callGeminiAPI(promptParts, resultElement, null, processingKey); }
                  else { showError(resultElement, 'ඉදිරිපත් කිරීමට අන්තර්ගතයක් නොමැත.'); }
             } catch (error) { console.error('Error in combined AI submission:', error); }
         });

        // --- Chat Bot Logic ---
        function renderChatHistory(renderDefaultOnly = false) {
             chatHistory.innerHTML = '';
             if (renderDefaultOnly || conversationHistory.length === 0) {
                 const defaultMsgDiv = document.createElement('div'); defaultMsgDiv.classList.add('chat-message', 'ai-message');
                  defaultMsgDiv.innerHTML = '<p>ආයුබෝවන්! ඔබට උදව් කළ හැක්කේ කෙසේද? ඔබට ප්‍රශ්නයක් ඇසීමට, උපදෙසක් ලබා ගැනීමට හෝ ඕනෑම ගොනුවක් පිළිබඳව විමසීමට හැකිය.</p>';
                 chatHistory.appendChild(defaultMsgDiv); return;
             }
            conversationHistory.forEach(msg => {
                 const messageDiv = document.createElement('div'); messageDiv.classList.add('chat-message'); let messageContent = '';
                 if (msg.role === 'user') {
                     messageDiv.classList.add('user-message');
                     msg.parts.forEach(part => {
                         if (part.text) { messageContent += `<p>${part.text.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</p>`; }
                         if (part.inline_data && part.inline_data.data) {
                             const mimeType = part.inline_data.mime_type || 'application/octet-stream';
                             const fileInfo = JSON.parse(chatImageInput.dataset.fileInfo || '{}'); // Get file info saved earlier
                             const fileName = fileInfo.name || 'Uploaded File';

                             if (mimeType.startsWith('image/')) { const imgSrc = `data:${mimeType};base64,${part.inline_data.data}`; messageContent += `<img src="${imgSrc}" alt="Uploaded Image" class="embedded-image">`; }
                             else {
                                 // Generic file display for others (PDF, video, audio, etc.)
                                 messageContent += `<p class="file-display"><i><svg xmlns="http://www.w3.org/2000/svg" height="16px" viewBox="0 -960 960 960" width="16px"><path d="M240-80q-33 0-56.5-23.5T160-160v-640q0-33 23.5-56.5T240-880h320l240 240v480q0 33-23.5 56.5T720-80H240Zm280-520v-200H240v640h480v-440H520ZM240-800v200-200 640-640Z"/></svg> ගොනුව: ${fileName.replace(/</g, "&lt;").replace(/>/g, "&gt;")} (${mimeType})</i></p>`;
                             }
                         }
                     });
                     messageDiv.innerHTML = messageContent || '<p>(හිස් පණිවිඩය)</p>';
                 } else { messageDiv.classList.add('ai-message'); const textPart = msg.parts.find(p => p.text); displayResult(messageDiv, textPart ? textPart.text : '(No text content)', false); }
                 chatHistory.appendChild(messageDiv);
            });
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
         function adjustChatInputHeight() { chatInput.style.height = 'auto'; chatInput.style.height = (chatInput.scrollHeight) + 'px'; }
         chatInput.addEventListener('input', adjustChatInputHeight);
        sendChatMessage.addEventListener('click', async () => {
            const messageText = chatInput.value.trim(); const file = chatImageInput.files[0]; const processingKey = sendChatMessage.getAttribute('data-processing-key');
            if (!messageText && !file) { showError(chatHistory, 'කරුණාකර පණිවිඩයක් ඇතුළත් කරන්න හෝ ගොනුවක් තෝරන්න.'); return; }
             let userMessageParts = []; let fileReadPromise = Promise.resolve(null);
             if (messageText) { userMessageParts.push({ text: messageText }); }
             if (file) {
                 // Important: Save file info *before* reading, as reading clears the input
                 updateFileNameDisplay(chatImageInput); // Save name/type to dataset
                 fileReadPromise = readFileAsBase64(file).then(fileData => fileData)
                     .catch(error => { showError(chatHistory, `ගොනුව සැකසීමේ දෝෂයකි: ${error.message}`); disableApiButtons(false); throw error; });
             }
            try {
                 const fileData = await fileReadPromise;
                 if (fileData) { userMessageParts.push({ inline_data: { mime_type: fileData.mimeType, data: fileData.base64String } }); if (!messageText) { userMessageParts.unshift({ text: "Describe or process this file." }); } } // Add generic prompt if only file
                 if (userMessageParts.length === 0) { showError(chatHistory, 'ඉදිරිපත් කිරීමට අන්තර්ගතයක් නොමැත.'); return; }
                 const userMessage = { role: 'user', parts: userMessageParts };
                 conversationHistory.push(userMessage); renderChatHistory(); saveToStorage('chatHistoryData', JSON.stringify(conversationHistory));
                 chatInput.value = ''; chatImageInput.value = null; updateFileNameDisplay(chatImageInput); adjustChatInputHeight();
                 const result = await callGeminiAPI(null, chatHistory, conversationHistory, processingKey);
                 if (result && result.aiResponseObject) { conversationHistory.push(result.aiResponseObject); saveToStorage('chatHistoryData', JSON.stringify(conversationHistory)); }
            } catch (error) { console.error('Error sending chat message:', error); }
        });
         clearChatButton.addEventListener('click', () => {
            conversationHistory = []; renderChatHistory(true); removeFromStorage('chatHistoryData'); removeFromStorage('input_chatInput'); removeFromStorage('file_chatImageInput');
            chatInput.value = ''; chatImageInput.value = null; updateFileNameDisplay(chatImageInput); adjustChatInputHeight();
         });

        // 2. Translation
        submitTranslateBtn.addEventListener('click', async () => {
             const textToTranslate = translateText.value.trim(); const file = translateImage.files[0]; const targetLangCode = translateLang.value;
             const targetLangName = translateLang.options[translateLang.selectedIndex].text; const resultElement = translateResult; const processingKey = submitTranslateBtn.getAttribute('data-processing-key');
             if (!textToTranslate && !file) { showError(resultElement, 'කරුණාකර පරිවර්තනයට පාඨයක් ඇතුලත් කරන්න හෝ ගොනුවක් (Image/PDF) තෝරන්න.'); return; }
             let promptParts = []; let fileReadPromise = Promise.resolve(null);
             if (file) { fileReadPromise = readFileAsBase64(file).then(fileData => fileData).catch(error => { showError(resultElement, `ගොනුව සැකසීමේ දෝෂයකි: ${error.message}`); disableApiButtons(false); throw error; }); }
             try {
                 const fileData = await fileReadPromise;
                 if (fileData) { let basePrompt = `Extract text from the following image/document and translate it into ${targetLangName} (language code: ${targetLangCode}).`; if (textToTranslate) { basePrompt = `Translate the text extracted from the following image/document into ${targetLangName} (language code: ${targetLangCode}). Consider this context/instruction: "${textToTranslate}".`; } promptParts.push({ "text": basePrompt + " Respond ONLY with the translated text." }); promptParts.push({ "inline_data": { "mime_type": fileData.mimeType, "data": fileData.base64String } }); }
                 else if (textToTranslate) { promptParts.push({ "text": `Translate the following text into ${targetLangName} (language code: ${targetLangCode}). Respond ONLY with the translated text.\n\nText:\n"${textToTranslate}"` }); }
                 if (promptParts.length > 0) { await callGeminiAPI(promptParts, resultElement, null, processingKey); }
             } catch (error) { console.error('Error in translation submission:', error); }
         });

        // 3. OCR
        submitOcrImageBtn.addEventListener('click', async () => {
             const file = ocrImageFile.files[0]; const resultElement = ocrImageResult; const processingKey = submitOcrImageBtn.getAttribute('data-processing-key');
             if (!file) { showError(resultElement, 'කරුණාකර ඡායාරූපයක් හෝ PDF එකක් තෝරන්න.'); return; }
             let fileReadPromise = readFileAsBase64(file).then(fileData => fileData).catch(error => { showError(resultElement, `ගොනුව සැකසීමේ දෝෂයකි: ${error.message}`); disableApiButtons(false); throw error; });
             try {
                 const fileData = await fileReadPromise; const prompt = [ { "text": "Extract all text content from this image/document accurately. Respond ONLY with the extracted text. If no text is found, state 'No text detected'." }, { "inline_data": { "mime_type": fileData.mimeType, "data": fileData.base64String } } ];
                 await callGeminiAPI(prompt, resultElement, null, processingKey);
             } catch (error) { console.error('Error processing OCR file:', error); }
        });

        // 12. Sinhala Unicode Converter
        submitUnicodeConvert.addEventListener('click', async () => {
            const text = unicodeInputText.value.trim();
            const file = unicodeInputFile.files[0];
            const resultElement = unicodeResult;
            const processingKey = submitUnicodeConvert.getAttribute('data-processing-key');

            if (!text && !file) {
                showError(resultElement, 'කරුණාකර පරිවර්තනයට Text එකක් ඇතුලත් කරන්න හෝ ගොනුවක් (Image/PDF) තෝරන්න.');
                return;
            }

            let promptParts = [];
            let fileReadPromise = Promise.resolve(null);

            if (file) {
                fileReadPromise = readFileAsBase64(file)
                    .then(fileData => fileData)
                    .catch(error => {
                        showError(resultElement, `ගොනුව සැකසීමේ දෝෂයකි: ${error.message}`);
                        disableApiButtons(false);
                        throw error; // Stop execution if file reading fails
                    });
            }

            try {
                const fileData = await fileReadPromise;

                if (fileData) {
                    // File provided: OCR first, then convert
                    let basePrompt = "Extract all text content from the provided file. Then, convert the *entire* extracted text into standard Sinhala Unicode (compatible with fonts like Noto Sans Sinhala, Iskoola Pota, etc.). Respond ONLY with the fully converted Sinhala Unicode text. If no text is found in the file, respond with 'ගොනුවේ Text එකක් සොයාගත නොහැකි විය'.";
                    if (text) {
                         // If text is also provided, maybe use it as context? Or ignore? Let's prioritize the file's content.
                         // basePrompt += `\nAdditional context/text provided: "${text}"`; // Optional: add context if needed
                    }
                    promptParts.push({ "text": basePrompt });
                    promptParts.push({ "inline_data": { "mime_type": fileData.mimeType, "data": fileData.base64String } });
                } else if (text) {
                    // Only text provided
                    promptParts.push({
                        "text": `Convert the following Sinhala text (which might be in Singlish or a legacy font encoding like FM Abhaya) into standard Sinhala Unicode (compatible with fonts like Noto Sans Sinhala, Iskoola Pota). Respond ONLY with the converted Sinhala Unicode text.\n\nText:\n${text}`
                    });
                }

                if (promptParts.length > 0) {
                    await callGeminiAPI(promptParts, resultElement, null, processingKey);
                } else {
                     // This case should ideally not be reached due to the initial check, but as a safeguard:
                     showError(resultElement, 'ඉදිරිපත් කිරීමට අන්තර්ගතයක් නොමැත.');
                }

            } catch (error) {
                // Catch errors from readFileAsBase64 or callGeminiAPI
                console.error('Error in Unicode conversion submission:', error);
                // showError would have been called already if it was a file error
            }
        });


         // 4. Summarization
         submitSummarizeBtn.addEventListener('click', async () => {
             const text = summarizeText.value.trim(); const file = summarizeFile.files[0]; const resultElement = summarizeResult; const processingKey = submitSummarizeBtn.getAttribute('data-processing-key');
             if (!text && !file) { showError(resultElement, 'සාරාංශ කිරීමට පාඨයක් ඇතුලත් කරන්න හෝ ගොනුවක් (Image/PDF) තෝරන්න.'); return; }
             let promptParts = []; let fileReadPromise = Promise.resolve(null);
             if (file) { fileReadPromise = readFileAsBase64(file).then(fileData => fileData).catch(error => { showError(resultElement, `ගොනුව සැකසීමේ දෝෂයකි: ${error.message}`); disableApiButtons(false); throw error; }); }
             try {
                  const fileData = await fileReadPromise;
                  if (fileData) { let basePrompt = "Provide a concise and informative summary of the text content found in the provided image/document. Capture the main points and key information. Output the summary in clear paragraphs in Sinhala."; if (text) { basePrompt += `\nConsider these additional instructions or context: "${text}"`; } promptParts.push({ "text": basePrompt }); promptParts.push({ "inline_data": { "mime_type": fileData.mimeType, "data": fileData.base64String } }); }
                  else if (text) { promptParts.push({ "text": `Provide a concise and informative summary of the following text in Sinhala, capturing the main points and key information. Output the summary in clear paragraphs.\n\nText:\n${text}` }); }
                  if (promptParts.length > 0) { await callGeminiAPI(promptParts, resultElement, null, processingKey); }
             } catch (error) { console.error('Error in summarization submission:', error); }
         });

         // 5. Code Generation
         submitCodeGenBtn.addEventListener('click', async () => {
             const task = codeGenPrompt.value.trim(); const language = codeGenLang.value.trim(); const resultElement = codeGenResult; const processingKey = submitCodeGenBtn.getAttribute('data-processing-key');
             if (!task) { showError(resultElement, 'කේතය සෑදීමට අවශ්‍ය කාර්යය විස්තර කරන්න.'); return; }
             let promptText = `Generate ${language || 'relevant'} code for the following task: ${task}.`; promptText += `\nStructure the output clearly using a single markdown code block (e.g., \`\`\`${language || ''}\\nCODE HERE\\n\`\`\`). Add brief comments within the code to explain key parts where necessary. Do not add any explanations outside the code block.`;
             const prompt = [{ "text": promptText }];
             try { await callGeminiAPI(prompt, resultElement, null, processingKey); } catch (error) { /* Handled */ }
         });

        // 6. MCQ Marking
        submitMcqMarking.addEventListener('click', async () => {
            const answerKeyFile = mcqAnswerKeyImage.files[0]; const studentPaperFile = mcqStudentPaperImage.files[0]; const resultElement = mcqMarkingResult; const processingKey = submitMcqMarking.getAttribute('data-processing-key');
            if (!answerKeyFile || !studentPaperFile) { showError(resultElement, 'කරුණාකර නිවැරදි පිළිතුරු පත්‍රය (Answer Key) සහ ශිෂ්‍ය පත්‍රය යන ගොනු (Image/PDF) දෙකම Upload කරන්න.'); return; }
            try {
                const [keyFileData, studentFileData] = await Promise.all([ readFileAsBase64(answerKeyFile).catch(e => { throw new Error(`පිළිතුරු පත්‍රය: ${e.message}`); }), readFileAsBase64(studentPaperFile).catch(e => { throw new Error(`ශිෂ්‍ය පත්‍රය: ${e.message}`); }) ]);
                const prompt = [ { "text": `You are an AI assistant designed to mark multiple-choice question (MCQ) papers provided as images or PDFs. File 1 contains the correct answer key. File 2 contains the student's answer sheet. Your task is to: 1. Carefully extract the question numbers and corresponding correct answers from the Answer Key file (File 1). Assume standard numbering (1, 2, 3...). 2. Carefully extract the question numbers and the answers marked by the student from the Student Paper file (File 2). 3. Compare the student's answers to the correct answers for each question number found on both sheets. 4. Generate a result list in Sinhala. For each question, state the question number, the student's answer (or 'පිළිතුරක් නැත' if none), the correct answer, and whether the student's answer is correct ('හරි') or incorrect ('වැරදියි'). If incorrect, also mention the correct answer. Format each line like this: [අංකය]. ශිෂ්‍යයා: [ශිෂ්‍ය පිළිතුර] | නිවැරදි: [නිවැරදි පිළිතුර] | ප්‍රතිඵලය: [හරි/වැරදියි] Example: 1. ශිෂ්‍යයා: 3 | නිවැරදි: 3 | ප්‍රතිඵලය: හරි 2. ශිෂ්‍යයා: 1 | නිවැරදි: 4 | ප්‍රතිඵලය: වැරදියි (නිවැරදි පිළිතුර: 4) 3. ශිෂ්‍යයා: පිළිතුරක් නැත | නිවැරදි: 2 | ප්‍රතිඵලය: වැරදියි (නිවැරදි පිළිතුර: 2) Be accurate in reading the numbers and answers. If you cannot clearly determine an answer for a specific question number on either sheet, indicate that clearly in the output for that question. Focus only on the comparison and result list. Answer Key is File 1. Student Paper is File 2.` }, { "inline_data": { "mime_type": keyFileData.mimeType, "data": keyFileData.base64String } }, { "inline_data": { "mime_type": studentFileData.mimeType, "data": studentFileData.base64String } } ];
                await callGeminiAPI(prompt, resultElement, null, processingKey);
            } catch (error) { console.error('Error during MCQ marking process:', error); showError(resultElement, `MCQ ලකුණු කිරීමේදී දෝෂයකි: ${error.message}`); disableApiButtons(false); }
        });

         // 7. Answer Generation (General)
        submitAnswerGen.addEventListener('click', async () => {
             const paperFile = answerGenPaperImage.files[0]; const resultElement = answerGenResult; const processingKey = submitAnswerGen.getAttribute('data-processing-key');
             if (!paperFile) { showError(resultElement, 'කරුණාකර ප්‍රශ්න පත්‍රයේ ගොනුවක් (Image/PDF) තෝරන්න.'); return; }
             let fileReadPromise = readFileAsBase64(paperFile).then(fileData => fileData).catch(error => { showError(resultElement, `ගොනුව සැකසීමේ දෝෂයකි: ${error.message}`); disableApiButtons(false); throw error; });
             try {
                 const fileData = await fileReadPromise; const prompt = [ { "text": `Analyze the provided image/document, which contains a question paper. 1. Identify each distinct question, including its number. 2. Generate a concise and accurate answer for each identified question based on general knowledge or the context within the paper if possible. For mathematical problems, provide the solution steps or the final answer. 3. Present the answers in a clearly numbered list format in Sinhala. Example format: 1. [පළමු ප්‍රශ්නයට පිළිතුර] 2. [දෙවන ප්‍රශ්නයට පිළිතුර] ... If the file is unclear or a question cannot be answered, state that clearly for the specific question number. Focus on providing the answers directly.` }, { "inline_data": { "mime_type": fileData.mimeType, "data": fileData.base64String } } ];
                 await callGeminiAPI(prompt, resultElement, null, processingKey);
             } catch (error) { console.error('Error processing answer generation file:', error); }
        });

         // 8. Answer Generation (Section II)
        submitSectionTwoAnswers.addEventListener('click', async () => {
             const paperFile = sectionTwoPaperImage.files[0]; const resultElement = sectionTwoResult; const processingKey = submitSectionTwoAnswers.getAttribute('data-processing-key');
             if (!paperFile) { showError(resultElement, 'කරුණාකර II කොටසේ ප්‍රශ්න පත්‍රයේ ගොනුවක් (Image/PDF) තෝරන්න.'); return; }
             let fileReadPromise = readFileAsBase64(paperFile).then(fileData => fileData).catch(error => { showError(resultElement, `ගොනුව සැකසීමේ දෝෂයකි: ${error.message}`); disableApiButtons(false); throw error; });
             try {
                 const fileData = await fileReadPromise; const prompt = [ { "text": `Analyze the provided image/document, which contains Section II (likely essay or long-answer questions) of a question paper. 1. Identify each distinct question, including its number or letter. 2. Generate a comprehensive and detailed answer for each identified question, suitable for a long-answer format. Address all parts of the question thoroughly. Lengthy answers are expected and acceptable. 3. Structure the answers clearly, using paragraphs, and potentially bullet points or numbered lists within an answer where appropriate. 4. Present the answers in Sinhala, clearly indicating which answer corresponds to which question number. Example format: 1. [පළමු ප්‍රශ්නයට දීර්ඝ පිළිතුර මෙතන...] 2. a) [දෙවන ප්‍රශ්නයේ 'a' කොටසට පිළිතුර...] b) [දෙවන ප්‍රශ්නයේ 'b' කොටසට පිළිතුර...] ... If the file is unclear or a question cannot be reasonably answered, state that clearly for the specific question number.` }, { "inline_data": { "mime_type": fileData.mimeType, "data": fileData.base64String } } ];
                 await callGeminiAPI(prompt, resultElement, null, processingKey);
             } catch (error) { console.error('Error processing Section II answer generation file:', error); }
        });


        // --- Scientific Calculator Logic ---
        let currentExpression = ''; let shouldResetDisplay = true;
        function saveCalculatorState() { saveToStorage('input_calculatorDisplay', calculatorDisplay.value); saveToStorage('input_calculatorExpression', currentExpression); saveToStorage('calculator_shouldReset', shouldResetDisplay); }
        function clearDisplay() { calculatorDisplay.value = '0'; currentExpression = ''; shouldResetDisplay = true; saveCalculatorState(); }
        function deleteLast() { if (shouldResetDisplay || calculatorDisplay.value === 'Error' || calculatorDisplay.value === 'Infinity' || calculatorDisplay.value === 'NaN' || calculatorDisplay.value === '0') { clearDisplay(); return; } calculatorDisplay.value = calculatorDisplay.value.slice(0, -1); currentExpression = currentExpression.slice(0, -1); if (calculatorDisplay.value === '') { clearDisplay(); } saveCalculatorState(); }
        function appendNumber(number) { if (calculatorDisplay.value === '0' || shouldResetDisplay) { calculatorDisplay.value = number; currentExpression = number; shouldResetDisplay = false; } else { calculatorDisplay.value += number; currentExpression += number; } saveCalculatorState(); }
        function appendDecimal() { if (shouldResetDisplay) { calculatorDisplay.value = '0.'; currentExpression = '0.'; shouldResetDisplay = false; saveCalculatorState(); return; } if (!calculatorDisplay.value.includes('.') || /[\+\-\*\/÷\(\^]/.test(calculatorDisplay.value.slice(-1))) { const segments = calculatorDisplay.value.split(/[\+\-\*\/÷\(\^]/); const lastSegment = segments[segments.length-1]; if (!lastSegment.includes('.')) { calculatorDisplay.value += '.'; currentExpression += '.'; saveCalculatorState(); } } }
        function appendOperator(operator) { if (calculatorDisplay.value === 'Error' || calculatorDisplay.value === 'Infinity' || calculatorDisplay.value === 'NaN') { clearDisplay(); return; } let displayOp = operator; if (operator === '*') { displayOp = '×'; } else if (operator === '/') { displayOp = '÷'; } else if (operator === '**') { displayOp = '^'; } const lastDispChar = calculatorDisplay.value.trim().slice(-1); const isDispOperator = /[\+\-×÷\^\%\(]$/.test(lastDispChar); if (currentExpression === '' && operator === '-') { calculatorDisplay.value = '-'; currentExpression = '-'; } else if (lastDispChar && (lastDispChar === '(' || !isDispOperator)) { if (operator !== '(' && operator !== ')') { calculatorDisplay.value += displayOp; currentExpression += operator; } else if (operator === '(') { if (lastDispChar && !isDispOperator && lastDispChar !== '(') { calculatorDisplay.value += '×'; currentExpression += '*'; } calculatorDisplay.value += '('; currentExpression += '('; } else if (operator === ')') { const openParenCount = (currentExpression.match(/\(/g) || []).length; const closeParenCount = (currentExpression.match(/\)/g) || []).length; if (openParenCount > closeParenCount && lastDispChar && !isDispOperator && lastDispChar !== '(') { calculatorDisplay.value += ')'; currentExpression += ')'; } } } else if (lastDispChar === '' || isDispOperator) { if (operator === '(') { calculatorDisplay.value += '('; currentExpression += '('; } else if (operator === '-' && currentExpression !== '-') { calculatorDisplay.value += '-'; currentExpression += '-'; } } shouldResetDisplay = false; saveCalculatorState(); }
        function appendFunction(func) { if (calculatorDisplay.value === 'Error' || calculatorDisplay.value === 'Infinity' || calculatorDisplay.value === 'NaN') { clearDisplay(); } const funcName = func.split('(')[0].split('.').pop(); const lastDispChar = calculatorDisplay.value.trim().slice(-1); const isDispOperatorOrParen = /[\+\-×÷\^\%\(]$/.test(lastDispChar); if (shouldResetDisplay || calculatorDisplay.value === '0') { calculatorDisplay.value = funcName + '('; currentExpression = func; } else { if (lastDispChar && !isDispOperatorOrParen) { calculatorDisplay.value += '×'; currentExpression += '*'; } calculatorDisplay.value += funcName + '('; currentExpression += func; } shouldResetDisplay = false; saveCalculatorState(); }
        function appendConstant(constant) { if (calculatorDisplay.value === 'Error' || calculatorDisplay.value === 'Infinity' || calculatorDisplay.value === 'NaN') { clearDisplay(); } const constName = constant === 'Math.PI' ? 'π' : 'e'; const lastDispChar = calculatorDisplay.value.trim().slice(-1); const isDispOperatorOrParen = /[\+\-×÷\^\%\(]$/.test(lastDispChar); if (shouldResetDisplay || calculatorDisplay.value === '0') { calculatorDisplay.value = constName; currentExpression = constant; } else { if (lastDispChar && !isDispOperatorOrParen) { calculatorDisplay.value += '×'; currentExpression += '*'; } calculatorDisplay.value += constName; currentExpression += constant; } shouldResetDisplay = false; saveCalculatorState(); }
        function toggleSign() { if (shouldResetDisplay || calculatorDisplay.value === '0' || calculatorDisplay.value === 'Error' || calculatorDisplay.value === 'Infinity' || calculatorDisplay.value === 'NaN') return; const match = calculatorDisplay.value.match(/([\+\-×÷\^\%\(]|^)(-?\d+(\.\d+)?)$/); if (match) { const prefix = match[1] || ''; let numberStr = match[2]; let newNumberStr; let exprNumberStr = numberStr; const exprMatch = currentExpression.match(/([\+\-\*\/\^\%\(]|^)(-?(\d+(\.\d+)?|Math\.PI|Math\.E))$/); if (exprMatch) { exprNumberStr = exprMatch[2]; } if (numberStr.startsWith('-')) { newNumberStr = numberStr.substring(1); exprNumberStr = exprNumberStr.startsWith('-') ? exprNumberStr.substring(1) : exprNumberStr; } else { newNumberStr = '-' + numberStr; exprNumberStr = '-' + exprNumberStr; } calculatorDisplay.value = calculatorDisplay.value.substring(0, calculatorDisplay.value.length - match[2].length) + newNumberStr; currentExpression = currentExpression.substring(0, currentExpression.length - match[2].length) + exprNumberStr; saveCalculatorState(); } }
        function calculateResult() { if (shouldResetDisplay || currentExpression.trim() === '' || calculatorDisplay.value === 'Error') return; const openParen = (currentExpression.match(/\(/g) || []).length; const closeParen = (currentExpression.match(/\)/g) || []).length; if (openParen !== closeParen) { const lastExprChar = currentExpression.trim().slice(-1); if (!/[\+\-\*\/\%\(\^]$/.test(lastExprChar)) { const diff = openParen - closeParen; if (diff > 0) { currentExpression += ')'.repeat(diff); console.log("Auto-closing parens. New expression:", currentExpression); } else { calculatorDisplay.value = 'Error: Parens'; currentExpression = ''; shouldResetDisplay = true; saveCalculatorState(); return; } } else { calculatorDisplay.value = 'Error: Parens'; currentExpression = ''; shouldResetDisplay = true; saveCalculatorState(); return; } } try { let exprToEval = currentExpression .replace(/π/g, 'Math.PI') .replace(/e(?!xp)/g, 'Math.E') .replace(/\^/g, '**') .replace(/×/g, '*') .replace(/÷/g, '/'); exprToEval = exprToEval.replace(/(\d+(\.\d+)?)\s*%/g, '($1/100)'); exprToEval = exprToEval.replace(/([\+\-\*\/])\s*(\d+(\.\d+)?)\s*%/g, '$1($2/100)'); exprToEval = exprToEval.replace(/(^|[\(\s])%/g, '$1(1/100)'); exprToEval = exprToEval.replace(/%/g, '/100'); exprToEval = exprToEval.replace(/(\d|\.)(Math|Math\.PI|Math\.E|\()/g, '$1*$2'); exprToEval = exprToEval.replace(/\)(Math|Math\.PI|Math\.E|\d|\.|\()/g, ')*$1'); exprToEval = exprToEval.replace(/[\+\-\*\/]+$/, ''); if (!exprToEval) { clearDisplay(); return; } console.log("Evaluating:", exprToEval); const result = new Function(`"use strict"; return (${exprToEval});`)(); if (!isFinite(result)) { if (isNaN(result)) calculatorDisplay.value = 'NaN'; else calculatorDisplay.value = 'Infinity'; currentExpression = ''; shouldResetDisplay = true; saveCalculatorState(); return; } let resultString = String(result); if (resultString.includes('.') && resultString.split('.')[1].length > 10) { resultString = parseFloat(result.toFixed(10)).toString(); } calculatorDisplay.value = resultString; currentExpression = resultString; shouldResetDisplay = true; saveCalculatorState(); } catch (error) { console.error("Calculator Error:", error, "Expression:", currentExpression); calculatorDisplay.value = 'Error'; currentExpression = ''; shouldResetDisplay = true; saveCalculatorState(); } }

        // --- Number Base Converter Logic ---
          const baseMap = { decimal: { element: decimalInput, base: 10, regex: /^[0-9]+$/, storageKey: 'input_decimalInput' }, binary: { element: binaryInput, base: 2, regex: /^[01]+$/, storageKey: 'input_binaryInput' }, octal: { element: octalInput, base: 8, regex: /^[0-7]+$/, storageKey: 'input_octalInput' }, hex: { element: hexInput, base: 16, regex: /^[0-9A-Fa-f]+$/i, storageKey: 'input_hexInput' } };
          let isConverting = false;
         function convertBase(sourceKey, sourceValue) {
             if (isConverting) return; isConverting = true; hideBaseConverterError();
             const sourceInfo = baseMap[sourceKey]; const trimmedValue = sourceValue.trim().toUpperCase();
             saveToStorage(sourceInfo.storageKey, trimmedValue);
             if (trimmedValue === '') { clearBaseInputs(sourceKey, true); isConverting = false; return; }
             if (!sourceInfo.regex.test(trimmedValue)) { showBaseConverterError(`"${sourceValue}" යනු වලංගු ${sourceKey} අගයක් නොවේ.`); clearBaseInputs(sourceKey, true); isConverting = false; return; }
             try {
                 let decimalValueBigInt;
                 if (sourceInfo.base === 10) { decimalValueBigInt = BigInt(trimmedValue); }
                 else { decimalValueBigInt = BigInt(`0${sourceInfo.base === 2 ? 'b' : sourceInfo.base === 8 ? 'o' : 'x'}${trimmedValue}`); }
                 if (typeof decimalValueBigInt !== 'bigint' || decimalValueBigInt < 0n) { throw new Error("සංඛ්‍යාව පරිවර්තනය කළ නොහැක."); }
                 for (const targetKey in baseMap) {
                     if (targetKey !== sourceKey) {
                         const targetInfo = baseMap[targetKey];
                         try { const convertedValue = decimalValueBigInt.toString(targetInfo.base).toUpperCase(); targetInfo.element.value = convertedValue; saveToStorage(targetInfo.storageKey, convertedValue); }
                         catch (conversionError) { targetInfo.element.value = 'Error'; removeFromStorage(targetInfo.storageKey); }
                     }
                 }
             } catch (error) { console.error("Base Conversion Error:", error); showBaseConverterError(`පරිවර්තනයේදී දෝෂයකි: ${error.message}.`); clearBaseInputs(sourceKey, true); }
             finally { isConverting = false; }
         }
         function clearBaseInputs(keepSourceKey, clearStorage = false) {
             for (const key in baseMap) { if (key !== keepSourceKey) { baseMap[key].element.value = ''; if (clearStorage) { removeFromStorage(baseMap[key].storageKey); } } }
             if (keepSourceKey === null) { for (const key in baseMap) { baseMap[key].element.value = ''; if (clearStorage) { removeFromStorage(baseMap[key].storageKey); } } }
         }

        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            // Load state (theme, inputs, results, active section)
            loadSavedState();
            hideBaseConverterError();

             // API Key Check (Warning)
             setTimeout(() => {
                 if (!GEMINI_API_KEY || GEMINI_API_KEY === "YOUR_API_KEY_HERE" || GEMINI_API_KEY.length < 30) {
                       console.warn("Gemini API Key appears missing or invalid in the code. AI features might fail.");
                       // Optionally display a user-facing warning in a less critical way
                 }
             }, 1000);
        });

    </script>
</body>
</html>