<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- *** IMPORTANT CSP Update: Added 'blob:' for potential camera plugin use *** -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' data: blob: gap: https://ssl.gstatic.com 'unsafe-eval' 'unsafe-inline' https://api.ocr.space https://generativelanguage.googleapis.com; style-src 'self' 'unsafe-inline'; media-src *; img-src 'self' data: content: blob:;">
    <title>විතානගේ ස්ටෝස් - බිල</title>
    <style>
         body {
            font-family: 'Courier New', monospace;
            text-align: center;
            background-color: #121212;
            color: white;
            margin: 0;
            padding: 0;
        }
        .container {
            width: 320px;
            margin: auto;
            padding: 20px;
            background-color: #1e1e1e;
            border-radius: 10px;
            box-shadow: 0px 0px 10px rgba(255, 255, 255, 0.1);
            margin-top: 50px;
            text-align: left;
        }
        h2, h3 {
            text-align: center;
            margin: 5px 0;
            color: #00ffcc;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        input, button, select {
            width: 90%;
            padding: 10px;
            margin: 5px auto; /* Centered */
            display: block; /* Ensure block display for centering */
            background-color: #333;
            color: white;
            border: 1px solid #00ffcc;
            border-radius: 5px;
            transition: background-color 0.3s, color 0.3s;
             box-sizing: border-box; /* Include padding and border in element's total width */
        }
        /* Ensure password fields hide text */
        input[type="password"] {
            -webkit-text-security: disc;
            text-security: disc;
            font-family: text-security-disc; /* Standard property */
        }
        button:hover {
            background-color: #00ffcc;
            color: black;
        }
        .hidden { display: none; }
        .loading {
            display: block;
            font-size: 20px;
            color: #00ffcc;
            margin-top: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            text-align: center; /* Ensure loading text is centered */
        }
         #processingMessage, #processingMessageStock, #processingMessageProductMgmt { /* Style for AI processing messages */
            display: none; /* Hidden by default */
            font-size: 14px;
            color: #ffcc00; /* Yellow for attention */
            margin-top: 10px;
            text-align: center;
            padding: 5px;
            background-color: #444;
            border-radius: 5px;
        }
        .bill-card {
            background-color: #333;
            border-radius: 5px;
            padding: 10px;
            margin: 5px 0;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .bill-card:hover {
            transform: scale(1.05);
        }
        .bill-details {
            display: none;
            background-color: #444;
            padding: 10px;
            border-radius: 5px;
            margin-top: 5px;
        }
       .calculator { width: 90%; margin: 10px auto; background: #444; padding: 10px; border-radius: 5px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); }
        #display { width: 100%; height: 40px; font-size: 1.2em; text-align: right; padding: 5px; margin-bottom: 5px; border: none; border-radius: 5px; background: #555; color: white; box-sizing: border-box; }
        .buttons { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; }
        .buttons button { font-size: 0.9em; padding: 8px; border: none; border-radius: 5px; background: #555; color: white; cursor: pointer; width: 100%; }
        .buttons button:hover { background: #777; }
        .buttons button:active { background: #999; }

        .delete-button {
            background-color: #ff4444;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
            width: auto;
            display: inline-block;
        }
        .remove-item-button {
            background-color: #ff4444;
            color: white;
            border: none;
            padding: 3px 6px;
            border-radius: 3px;
            cursor: pointer;
            margin-left: 5px;
             width: auto;
             display: inline-block;
        }

        #productList, #kgProductList {
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #444;
            padding: 5px;
            margin-bottom: 10px;
        }

        .product-item, .kg-product-item {
            background-color: #333;
            border-radius: 5px;
            padding: 10px;
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .product-item span, .kg-product-item span {
            flex-grow: 1;
            margin-right: 10px;
            overflow-wrap: break-word;
            word-break: break-all;
        }

        .edit-button, .save-button, .cancel-button {
            background-color: #00ffcc;
            color: black;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 5px;
             width: auto;
            display: inline-block;
        }

        .edit-button:hover, .save-button:hover, .cancel-button:hover {
            background-color: #00bb99;
        }

        .delete-product-button {
            background-color: #ff4444;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 5px;
             width: auto;
            display: inline-block;
        }

        #customItemSection {
            margin-top: 20px;
            padding: 10px;
            background-color: #3a506b; /* Different color */
            border-radius: 5px;
        }

        /* --- Button Color Coding --- */
        .calculator-button { background-color: #444; } /* Dark Grey */
        .custom-item-button { background-color: #3a506b; } /* Dark Blue/Grey */
        .kg-item-button { background-color: #4a4e69; } /* Dark Purple/Grey */
        .scan-single-item-button { background-color: #b5838d; } /* Muted Pink/Brown */
        .scan-items-button { background-color: #0077b6; } /* Standard Blue */
        .scan-product-button { background-color: #d4a373; } /* Tan/Brown - NEW for product scan */
        /* --- End Button Color Coding --- */


        .print-button {
            background-color: #00bb99; /* Teal */
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
             width: auto;
            display: inline-block;
        }

        #stockManagementSection input,
        #stockManagementSection button {
            width: auto; /* Allow buttons/inputs to size naturally */
            display: inline-block; /* Allow side-by-side placement */
            margin: 5px; /* Add spacing */
        }
         #stockManagementSection .full-width-btn,
         #productManagementSection .full-width-btn { /* Class for full width button */
             display: block;
             width: 90%; /* Use slightly less than 100% */
             margin-left: auto;
             margin-right: auto;
             box-sizing: border-box; /* Ensure padding is included */
         }
         #stockList {
            margin-top: 10px;
            max-height: 250px; /* Increased height */
            overflow-y: auto; /* Enable scroll */
            border: 1px solid #444;
            padding: 5px;
         }

        .stock-item {
            background-color: #333;
            border-radius: 5px;
            padding: 10px;
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
             overflow-wrap: break-word;
             word-break: break-all;
        }
        /* Style for the estimated stock display */
        .stock-item .estimated-stock {
            font-size: 10px;
            color: #ffcc00; /* Yellow */
            margin-left: 10px;
            font-style: italic;
            white-space: nowrap; /* Prevent wrapping */
        }
        /* Style for disclaimer */
        .stock-disclaimer {
            font-size: 10px;
            color: #aaa;
            margin-top: 10px;
            text-align: center;
        }

        input[type="file"] {
             width: 90%;
            padding: 10px;
            margin: 5px auto;
            display: block;
            background-color: #333;
            color: white;
            border: 1px solid #00ffcc;
            border-radius: 5px;
            transition: background-color 0.3s, color 0.3s;
            box-sizing: border-box;
        }
        .file-upload-label {
            display: block;
            width: 90%;
            padding: 10px;
            margin: 5px auto;
            background-color: #555;
            color: white;
            border: 1px solid #00ffcc;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
             box-sizing: border-box;
        }
        .file-upload-label:hover {
            background-color: #777;
        }


         #deletePasswordPrompt {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #333;
            padding: 20px;
            border-radius: 5px;
            z-index: 1000;
            text-align: center;
            box-shadow: 0 0 15px rgba(0, 255, 204, 0.5);
            width: 90%;
            max-width: 300px;
        }
         /* Removed deleteConfirmationSection styles as it's being removed */
         #deletePasswordPrompt button { /* Style for Bill Delete Prompt buttons */
             display: block; /* Stack buttons */
             width: 80%;
             margin: 10px auto;
         }

        /* Password Prompt Div Styling (Generic) */
        .password-prompt {
            padding: 20px;
            background-color: #2a2a2a;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 255, 204, 0.3);
            margin-bottom: 15px;
        }
        .password-prompt input[type="password"] {
            width: 80%;
            margin-bottom: 10px;
        }
        .password-prompt button {
            width: 50%;
        }

         table {
            width: 100%;
            margin-top: 15px;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #444;
            padding: 5px;
            text-align: left;
            font-size: 11px; /* Slightly smaller font for table */
             overflow-wrap: break-word; /* Wrap long words */
        }
        th {
            background-color: #2a2a2a;
            color: #00ffcc;
        }
        td:nth-child(1) { width: 10%; text-align: center; } /* අංකය */
        td:nth-child(2) { width: 30%; } /* Item Name */
        td:nth-child(3) { width: 15%; text-align: center; } /* Qty/Wt */
        td:nth-child(4) { width: 20%; text-align: right; } /* මිල */
        td:nth-child(5) { width: 20%; text-align: right; } /* Amount */
        td:nth-child(6) { width: 5%; text-align: center; } /* Remove btn */

    </style>
</head>
<body>

    <div class="loading" id="loading">Loading...</div>

    <div class="container hidden" id="content">
        <h2>විතානගේ ස්ටෝස්</h2>
        <hr>

        <!-- Login Section -->
        <div id="loginSection">
            <input type="password" id="password" placeholder="Enter Password (1111)">
            <button onclick="checkPassword()">Login</button>
        </div>

        <!-- Billing Section -->
        <div id="billingSection" class="hidden">
            <div id="processingMessage"></div> <!-- Message area for billing AI -->

            <button onclick="toggleCustomItem()" class = "custom-item-button">අභිරුචි භාණ්ඩය</button>
            <button onclick="scanSingleItemAndPrice()" class="scan-single-item-button">භාණ්ඩය සහ මිල Scan (AI)</button>
            <button onclick="scanBillingItems()" class="scan-items-button">බඩු ලැයිස්තුව Scan (AI)</button>

            <!-- Custom Item Section -->
            <div id="customItemSection" class="hidden custom-item-button">
                <h3>අභිරුචි භාණ්ඩය</h3>
                <input type="number" id="customItemPrice" placeholder="මිල">
                <input type="number" id="customItemQuantity" placeholder="ප්‍රමාණය" value="1" onkeypress="addCustomItemOnEnter(event)">
                <button onclick="addCustomItem()">එකතු කරන්න</button>
            </div>

            <!-- Product Selection Menu -->
            <select id="productSelect" onchange="updatePrice()" >
                <option value="">භාණ්ඩයක් තෝරන්න</option>
            </select>
            <input type="number" id="price" placeholder="මිල" readonly onkeypress="moveToNext(event, 'quantity')">
            <input type="number" id="quantity" placeholder="ප්‍රමාණය" value="1" onkeypress="addItemOnEnter(event)">
            <button onclick="addItem()">එකතු කරන්න</button>

             <!-- kg Product Selection Menu -->
            <select id="kgProductSelect" onchange="updateKgPrice()">
                <option value="">කිලෝ ග්‍රෑම් බාණ්ඩයක් තෝරන්න</option>
            </select>
             <input type="number" id="kgPrice" placeholder="කිලෝ එකක මිල" readonly onkeypress="moveToNextWeight(event, 'weight')">
             <input type="number" id="weight" placeholder="බර" onkeypress="addKgItemOnEnter(event)">
             <select id="weightUnit" style="width: auto; display: inline-block; vertical-align: middle; margin-left: 5px;">
                 <option value="g">ග්‍රෑම් (g)</option>
                 <option value="kg">කිලෝ (kg)</option>
             </select>
            <button onclick="addKgItem()" class = "kg-item-button">බර එකතු කරන්න</button>

            <button onclick="resetBill()">Reset</button>
            <button onclick="toggleCalculator()" class = "calculator-button">කැල්කියුලේටරය</button>

            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>භාණ්ඩය</th>
                        <th>Qty/Wt</th>
                        <th>මිල</th>
                        <th>Amount</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="billList"></tbody>
            </table>

            <h3>මුළු ගණන: <span id="total">0.00</span> රු.</h3>

            <input type="number" id="cash" placeholder="ලබාදුන් මුදල" oninput="calculateChange()" onkeypress="calculateChangeOnEnter(event)">
            <h3><span id="changeLabel">ඉතිරි මුදල:</span> <span id="change">0.00</span> රු.</h3>

             <!-- Calculator Section -->
            <div id="calculator" style="display:none;" class="calculator">
                 <input type="text" id="display" readonly>
                <div class="buttons">
                     <button onclick="clearDisplay()">C</button>
                    <button onclick="appendCharacter('(')">(</button>
                    <button onclick="appendCharacter(')')">)</button>
                    <button onclick="appendCharacter('/')">÷</button>
                    <button onclick="appendCharacter('7')">7</button>
                    <button onclick="appendCharacter('8')">8</button>
                    <button onclick="appendCharacter('9')">9</button>
                    <button onclick="appendCharacter('*')">×</button>
                    <button onclick="appendCharacter('4')">4</button>
                    <button onclick="appendCharacter('5')">5</button>
                    <button onclick="appendCharacter('6')">6</button>
                    <button onclick="appendCharacter('-')">−</button>
                    <button onclick="appendCharacter('1')">1</button>
                    <button onclick="appendCharacter('2')">2</button>
                    <button onclick="appendCharacter('3')">3</button>
                    <button onclick="appendCharacter('+')">+</button>
                    <button onclick="appendCharacter('0')">0</button>
                    <button onclick="appendCharacter('.')">.</button>
                    <button onclick="calculate()">=</button>
                    <button onclick="backspace()">⌫</button>
                </div>
                <button onclick="addToBill()">Add to Bill</button>
            </div>

            <button onclick="saveBillAndPrint()">සේව් සහ ප්‍රින්ට්</button>
            <button onclick="saveBill()">සේව් කරන්න</button>
            <button onclick="showHistory()">බිල් හොරණට යන්න</button>
            <button onclick="showProductManagement()">භාණ්ඩ කළමනාකරණය</button>
            <button onclick="showSalesReport()">ආදායම් වාර්තාව</button>
            <button onclick="showStockManagement()">තොග කළමනාකරණය</button>
        </div>

        <!-- History Section -->
        <div id="historySection" class="hidden">
            <h2>Saved Bills</h2>
            <input type="date" id="searchDate" onchange="searchBills()">
            <select id="timeRange" onchange="searchBills()">
                <option value="">සියලුම වේලාවන්</option>
                <option value="12-18">දවල් 12:00 - හවස 6:00</option>
                <option value="18-24">හවස 6:00 - රෑ 12:00</option>
                <option value="00-06">රෑ 12:00 - උදේ 6:00</option>
                <option value="06-12">උදේ 6:00 - දවල් 12:00</option>
            </select>
            <div id="billHistory"></div>
            <button onclick="showBilling()">ආපසු</button>
        </div>

          <!-- Sales Report Section -->
        <div id="salesReportSection" class="hidden">
             <h2>ආදායම් වාර්තාව</h2>
            <input type="date" id="reportStartDate" placeholder="ආරම්භක දිනය">
            <input type="date" id="reportEndDate" placeholder="අවසන් දිනය">
             <!-- REMOVED: Other expenses input -->
            <button onclick="generateSalesReport()">වාර්තාව ජනනය කරන්න</button>
            <div id="salesReport" style="white-space: pre-wrap; text-align: left; background: #333; padding: 10px; border-radius: 5px; margin-top: 10px;"></div>
            <button onclick="showBilling()">ආපසු</button>
        </div>

        <!-- Stock Management Section -->
        <div id="stockManagementSection" class="hidden">
            <h2>තොග කළමනාකරණය</h2>

            <!-- NEW: Password Prompt for Stock Management -->
            <div id="stockManagementPasswordPrompt" class="password-prompt">
                 <input type="password" id="stockManagementPassword" placeholder="Enter Stock Management Password (1111)">
                 <button onclick="checkStockManagementPassword()">Enter</button>
            </div>

            <!-- Actual Stock Management Content (Initially Hidden) -->
            <div id="stockManagementContent" class="hidden">
                 <div id="processingMessageStock"></div> <!-- Message area for stock AI -->

                 <!-- Hidden File Input -->
                 <input type="file" id="billImage" accept="image/*" style="display: none;">
                 <!-- Label styled as a button -->
                 <label for="billImage" class="file-upload-label">Upload Bill Image</label>

                 <button onclick="scanStockBill()" class="full-width-btn scan-items-button">බිල්පත Scan කරන්න (AI)</button> <!-- Uses scan-items-button style -->

                 <input type="text" id="stockItemName" placeholder="භාණ්ඩයේ නම">
                 <input type="number" id="stockItemPrice" placeholder="මිලදී ගත් මුළු මිල">
                 <input type="number" id="stockItemQuantity" placeholder="ප්‍රමාණය">
                 <button onclick="addStockItem()">තොගය අතින් එකතු කරන්න</button>
                 <!-- MODIFIED: Button to directly prompt for deletion -->
                 <button onclick="confirmDeleteLastStockItemDirectly()" class="delete-button">අවසන් තොගය මකන්න</button>

                 <div id="stockList"></div> <!-- Stock items will be listed here -->
                 <div class="stock-disclaimer">සටහන: 'Est. Available' යනු මිලදී ගැනීම් සහ විකිණීම් මත පදනම් වූ ඇස්තමේන්තුවකි.</div>
                 <h3>මුළු තොග වියදම: <span id="totalExpenses">0.00</span> රු.</h3>
            </div>
            <!-- END Actual Stock Management Content -->

            <button onclick="showBilling()">ආපසු</button>
        </div>


         <!-- Product Management Section -->
        <div id="productManagementSection" class="hidden">
              <h2>භාණ්ඩ කළමනාකරණය</h2>

            <div id="productManagementPasswordPrompt" class="password-prompt">
                <input type="password" id="productManagementPassword" placeholder="Enter Product Management Password (1111)">
                <button onclick="checkProductManagementPassword()">Enter</button>
            </div>

            <div id="productManagementContent" class="hidden">
                <div id="processingMessageProductMgmt"></div> <!-- Message area for product mgmt AI -->

                <!-- MODIFIED: AI Scan Button -->
                <button onclick="scanProductForManagement()" class="scan-product-button full-width-btn">භාණ්ඩය Scan කර නම සහ මිල ලබාගන්න (AI)</button>
                <hr style="border-color: #444; margin: 15px 0;">

                <h3>සාමාන්‍ය භාණ්ඩ</h3>
                <input type="text" id="newProductName" placeholder="භාණ්ඩයේ නම">
                <input type="number" id="newProductPrice" placeholder="භාණ්ඩයේ විකුණුම් මිල">
                <button onclick="addProduct()">භාණ්ඩය එකතු කරන්න</button>
                <div id="productList"></div>

                <hr style="border-color: #444; margin: 15px 0;"> <!-- Separator -->

                 <h3>කිලෝ ග්‍රෑම් භාණ්ඩ</h3>
                 <input type="text" id="newKgProductName" placeholder="භාණ්ඩයේ නම">
                 <input type="number" id="newKgProductPrice" placeholder="කිලෝ එකක විකුණුම් මිල">
                 <button onclick="addKgProduct()" class="kg-item-button">KG භාණ්ඩය එකතු කරන්න</button> <!-- Added class for potential styling -->
                 <div id="kgProductList"></div>
            </div>

            <button onclick="showBilling()">ආපසු</button>
        </div>

           <!-- Delete Password Prompt Section (for Bills) -->
         <div id="deletePasswordPrompt" class="hidden">
             <p>ඔබට ඇත්තටම මෙම බිල මකා දැමීමට අවශ්‍යද?</p>
             <input type="password" id="deletePassword" placeholder="Enter Delete Password (1111)">
            <button onclick="confirmDeleteBill()">තහවුරු කරන්න</button>
            <button onclick="cancelDelete()">Cancel</button>
        </div>

         <!-- REMOVED Delete Confirmation Section (for Stock) as password is removed -->

    </div>

     <!-- Cordova script inclusion -->
     <script src="cordova.js"></script>

    <script>
        // --- START Global Variables & Config ---
        let items = [];
        let itemCount = 1;
        let correctPassword = "1111";
        let productManagementPassword = "1111"; // Password for Product Management
        let stockManagementPassword = "1111"; // NEW Password for Stock Management
        let deletePassword = "1111"; // Password for deleting bills
        let billNumber = parseInt(localStorage.getItem("billNumber")) || 1;
        let selectedBillToDelete = null;
        let products = JSON.parse(localStorage.getItem("products")) || [];
        let kgProducts = JSON.parse(localStorage.getItem("kgProducts")) || [];
        let stockItems = JSON.parse(localStorage.getItem("stockItems")) || [];
        let totalStockCost = parseFloat(localStorage.getItem("totalStockCost")) || 0;
        // let selectedStockItemIndex = null; // No longer needed as we delete last directly
        let isNativeEnvironment = false;
        let estimatedStockLevels = {}; // NEW: To store calculated available stock


        // API Keys - Replace with your actual key
        const GEMINI_API_KEY = "AIzaSyBoEmNZXw_8msv3PzTENFf36Sl0gwN0BRQ"; // <<< API KEY INSERTED HERE
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;
        // --- END Global Variables & Config ---


        // --- START Default Data ---
        if (localStorage.getItem("products") === null) { // Only set defaults if not already in localStorage
            products = [
                { name: "සබන්", price: 140 }, { name: "බිස්කට් (75g)", price: 85 },
                { name: "සැමන් ටින් (155g)", price: 380 }, { name: "තේ කොළ (100g)", price: 230 },
                { name: "සෝයා මීට් (90g)", price: 135 }, { name: "දිල්", price: 50 },
                { name: "කිරි පිටි (400g)", price: 525 }, { name: "ලුනු කුඩු", price: 70 },
                { name: "සූදු", price: 50 }, { name: "බිත්තර", price: 50 },
                { name: "ජින්ජර් බිස්කට්", price: 50 }, { name: "පෑන්", price: 22 },
                { name: "පොත", price: 140 }, { name: "පැන්සල්", price: 60 },
                { name: "ලයිට් බිස්කට්", price: 500 }, { name: "නිල් වික්ස් රොබින්", price: 75 },
                { name: "ලංකාසොයි සොසේජ්", price: 75 }, { name: "ලක්සරි සෝප්", price: 50 }
            ];
            localStorage.setItem("products", JSON.stringify(products));
        }

        if (localStorage.getItem("kgProducts") === null) { // Only set defaults if not already in localStorage
            kgProducts = [
                { name: "සීනි", price: 220 }, { name: "හාල්", price: 250 },
                { name: "පිටි", price: 200 }, { name: "පරිප්පු", price: 400 },
                { name: "ලූනු", price: 300 }, { name: "අල", price: 200 },
                { name: "මිරිස් කුඩු", price: 1400 }, { name: "කහ කුඩු", price: 2800 },
            ];
            localStorage.setItem("kgProducts", JSON.stringify(kgProducts));
        }
        // --- END Default Data ---


        // --- START Utility Functions ---
        function showProcessingMessage(section, message, isError = false) {
             let msgDivId;
             switch(section) {
                 case 'billing': msgDivId = 'processingMessage'; break;
                 case 'stock': msgDivId = 'processingMessageStock'; break;
                 case 'product': msgDivId = 'processingMessageProductMgmt'; break;
                 default: console.warn(`Unknown section for processing message: ${section}`); return;
             }
             let msgDiv = document.getElementById(msgDivId);
             if (msgDiv) {
                 msgDiv.innerHTML = message;
                 msgDiv.style.color = isError ? '#ff4444' : '#ffcc00'; // Red for error, yellow for info
                 msgDiv.style.display = message ? 'block' : 'none';
             }
             console.log(`Processing (${section}): ${message} ${isError ? '(Error)' : ''}`);
         }

        function clearProcessingMessage(section) {
             showProcessingMessage(section, '');
         }

        function cleanGeminiResponse(text) {
            // Handle potential markdown code blocks ```json ... ``` or just ```
            // Also handle cases where it might just output the JSON without ```
             if (typeof text !== 'string') return ''; // Handle cases where text might not be a string
             return text.replace(/^```json\s*|```\s*$/g, '').trim();
        }

        // NEW: Function to normalize item names for comparison
        function normalizeName(name) {
            if (typeof name !== 'string') return '';
            // Basic normalization: lowercase, trim whitespace
            // Consider removing common units like (g), (kg), L, ml if needed for better matching, but start simple.
             return name.toLowerCase().trim();
             // Example more aggressive normalization (might be too much):
             // return name.toLowerCase().replace(/\(.*?\)|kg|g|l|ml/g, '').replace(/\s+/g, ' ').trim();
         }

         // NEW: Simple similarity check (e.g., "සබන් LUX" contains "සබන්")
         function areNamesSimilar(name1, name2) {
             const norm1 = normalizeName(name1);
             const norm2 = normalizeName(name2);
             if (!norm1 || !norm2) return false;
             // Check if one contains the other (basic check)
             return norm1.includes(norm2) || norm2.includes(norm1);
         }
         // --- END Utility Functions ---


        // --- START Initialization and Navigation ---
        document.addEventListener('deviceready', onDeviceReady, false);

        window.onload = function () {
             if (!GEMINI_API_KEY || GEMINI_API_KEY === "YOUR_GEMINI_API_KEY") { // Still good to check if it was somehow unset
                 console.error("ERROR: Gemini API Key is not set! AI features will not work.");
                 document.getElementById("loading").innerText = "Error: API Key Missing!";
                 return; // Stop loading if key is missing
             }

             if (window.cordova || window.Capacitor?.isNativePlatform()) {
                 isNativeEnvironment = true;
                 console.log("Native environment detected (Cordova/Capacitor).");
             } else {
                 console.log("Running in a standard browser environment.");
             }

            setTimeout(() => {
                document.getElementById("loading").style.display = "none";
                document.getElementById("content").classList.remove("hidden");
                removeOldBills();
                loadProducts();     // Load both standard and kg products for dropdowns and lists
                loadKgProducts();
                loadStockItems();   // Load stock, calculate initial total cost AND estimated levels
                updateTotalExpensesDisplay();
                setupFileInputListener();
            }, 500);
        };

         function onDeviceReady() {
             console.log('DEVICEREADY event fired.');
             isNativeEnvironment = true;
             // Check for camera plugin availability
             if (navigator.camera?.getPicture) {
                 console.log('Cordova Camera plugin IS available via navigator.camera.');
             } else {
                  console.warn('Cordova Camera plugin NOT found via navigator.camera.');
             }
             if (window.Capacitor?.Plugins?.Camera?.getPhoto) {
                 console.log('Capacitor Camera plugin IS available.');
             } else {
                 console.warn('Capacitor Camera plugin NOT available.');
             }
             if (window.cordova?.plugins?.printer?.print) {
                 console.log('Cordova Printer plugin IS available.');
             } else {
                 console.warn('Cordova Printer plugin NOT available.');
             }
             if (window.Capacitor?.Plugins?.Printer?.print) {
                 console.log('Capacitor Printer plugin IS available.');
             } else {
                 console.warn('Capacitor Printer plugin NOT available.');
             }
             if (window.resolveLocalFileSystemURL) {
                 console.log('Cordova File plugin detected.');
             } else {
                 console.log('Cordova File plugin NOT detected.');
             }
         }

        function checkPassword() {
            let enteredPass = document.getElementById("password").value;
            if (enteredPass === correctPassword) {
                document.getElementById("loginSection").classList.add("hidden");
                document.getElementById("billingSection").classList.remove("hidden");
            } else {
                alert("වැරදි Password එකකි!");
                document.getElementById("password").value = "";
            }
        }

        // Clear processing messages when switching main sections
        function clearAllProcessingMessages() {
             clearProcessingMessage('billing');
             clearProcessingMessage('stock');
             clearProcessingMessage('product');
        }

        function hideAllSections() {
            document.getElementById("billingSection").classList.add("hidden");
            document.getElementById("historySection").classList.add("hidden");
            document.getElementById("salesReportSection").classList.add("hidden");
            document.getElementById("stockManagementSection").classList.add("hidden");
            document.getElementById("productManagementSection").classList.add("hidden");
        }

        function showHistory() {
            clearAllProcessingMessages();
            hideAllSections();
            document.getElementById("historySection").classList.remove("hidden");
            loadBills();
        }

        function showSalesReport() {
            clearAllProcessingMessages();
            hideAllSections();
            document.getElementById("salesReportSection").classList.remove("hidden");
            const today = new Date().toISOString().split('T')[0];
            const firstDayOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];
            document.getElementById("reportStartDate").value = document.getElementById("reportStartDate").value || firstDayOfMonth;
            document.getElementById("reportEndDate").value = document.getElementById("reportEndDate").value || today;
            generateSalesReport(); // Generate report immediately with defaults/current values
        }

        function showStockManagement() {
            clearAllProcessingMessages();
            hideAllSections();
            document.getElementById("stockManagementSection").classList.remove("hidden");
            // Hide content, show password prompt
            document.getElementById("stockManagementContent").classList.add("hidden");
            document.getElementById("stockManagementPasswordPrompt").classList.remove("hidden");
            document.getElementById("stockManagementPassword").value = ""; // Clear password field
            // loadStockItems(); // Load items only after password check succeeds
        }

        function showProductManagement() {
            clearAllProcessingMessages();
            hideAllSections();
            document.getElementById("productManagementSection").classList.remove("hidden");
            // Hide content until password is entered
            document.getElementById("productManagementContent").classList.add("hidden");
            document.getElementById("productManagementPasswordPrompt").classList.remove("hidden");
            document.getElementById("productManagementPassword").value = ""; // Clear password field
        }

        function showBilling() {
             clearAllProcessingMessages();
             hideAllSections();
             document.getElementById("billingSection").classList.remove("hidden");
        }
        // --- END Initialization and Navigation ---


        // --- START Billing Section Logic ---
        function moveToNext(event, nextId) {
           if (event.key === "Enter") {
               event.preventDefault();
               document.getElementById(nextId)?.focus();
           }
        }

        function moveToNextWeight(event, nextId) {
           if (event.key === "Enter") {
                event.preventDefault();
               document.getElementById(nextId)?.focus();
           }
        }

        function addItemOnEnter(event) {
            if (event.key === "Enter") {
                event.preventDefault();
                addItem();
            }
        }

        function addKgItemOnEnter(event) {
             if (event.key === "Enter") {
                 event.preventDefault();
                addKgItem();
            }
        }

        function addCustomItemOnEnter(event) {
            if (event.key === "Enter") {
                event.preventDefault();
                addCustomItem();
            }
        }

        function addItem() {
            let priceInput = document.getElementById("price");
            let quantityInput = document.getElementById("quantity");
            let productSelect = document.getElementById("productSelect");

            let price = parseFloat(priceInput.value);
            let quantity = parseInt(quantityInput.value) || 1;
            let productName = productSelect.value;

            if (!productName) {
                 alert("කරුණාකර භාණ්ඩයක් තෝරන්න.");
                 productSelect.focus();
                 return;
            }

            if (!isNaN(price) && price >= 0 && !isNaN(quantity) && quantity > 0) {
                items.push({
                    number: itemCount++,
                    name: productName,
                    quantity: quantity,
                    unitPrice: price,
                    totalPrice: price * quantity,
                    type: 'quantity' // Standard item sold by quantity
                });
                updateTable();
                priceInput.value = "";
                quantityInput.value = "1";
                productSelect.value = "";
                productSelect.focus();
            } else {
                alert("කරුණාකර වලංගු මිලක් (0 හෝ වැඩි) සහ ප්‍රමාණයක් (0 ට වැඩි) ඇතුලත් කරන්න.");
                 if (isNaN(quantity) || quantity <= 0) quantityInput.focus();
                 else if (isNaN(price) || price < 0) productSelect.focus();
            }
        }

        function addCustomItem() {
            let priceInput = document.getElementById("customItemPrice");
            let quantityInput = document.getElementById("customItemQuantity");

            let name = "අභිරුචි භාණ්ඩය"; // Default name
            let price = parseFloat(priceInput.value);
            let quantity = parseFloat(quantityInput.value) || 1;

            if (!isNaN(price) && price >= 0 && !isNaN(quantity) && quantity > 0) {
                items.push({
                    number: itemCount++,
                    name: name,
                    quantity: quantity,
                    unitPrice: price,
                    totalPrice: price * quantity,
                    type: 'custom'
                });
                updateTable();
                priceInput.value = "";
                quantityInput.value = "1";
                toggleCustomItem(); // Hide after adding
            } else {
                alert("කරුණාකර වලංගු අගයක් ඇතුලත් කරන්න (මිල 0 හෝ වැඩි, ප්‍රමාණය 0 ට වැඩි)");
                if (isNaN(quantity) || quantity <= 0) quantityInput.focus();
                else if (isNaN(price) || price < 0) priceInput.focus();
            }
        }

        function addKgItem() {
            let kgPriceInput = document.getElementById("kgPrice");
            let weightInput = document.getElementById("weight");
            let weightUnitSelect = document.getElementById("weightUnit");
            let productSelect = document.getElementById("kgProductSelect");

            let kgPrice = parseFloat(kgPriceInput.value); // Price per KG
            let weight = parseFloat(weightInput.value);
            let weightUnit = weightUnitSelect.value;
            let productName = productSelect.value;

            if (!productName) {
                 alert("කරුණාකර කිලෝ ග්‍රෑම් බාණ්ඩයක් තෝරන්න.");
                 productSelect.focus();
                 return;
            }

            if (!isNaN(kgPrice) && kgPrice >= 0 && !isNaN(weight) && weight > 0) {
                let totalPrice;
                let displayWeight;
                let weightInKg; // NEW: Store the weight consistently in KG for stock calculation

                if (weightUnit === "g") {
                    totalPrice = (kgPrice / 1000) * weight;
                    displayWeight = weight + "g";
                    weightInKg = weight / 1000; // Convert grams to KG
                } else { // kg
                    totalPrice = kgPrice * weight;
                    displayWeight = weight + "kg";
                    weightInKg = weight; // Already in KG
                }

                 items.push({
                    number: itemCount++,
                    name: productName,
                    quantity: displayWeight, // Display string like '500g' or '1.5kg'
                    unitPrice: kgPrice, // Store price per KG
                    totalPrice: totalPrice,
                    type: 'weight', // Item sold by weight
                    weightInKg: weightInKg // Store KG value for stock calculation
                });
                updateTable();
                 kgPriceInput.value = "";
                 weightInput.value = "";
                 productSelect.value = "";
                 productSelect.focus();
            } else {
                 alert("කරුණාකර වලංගු මිලක් (0 හෝ වැඩි) සහ බරක් (0 ට වැඩි) ඇතුලත් කරන්න.");
                  if (isNaN(weight) || weight <= 0) weightInput.focus();
                  else if (isNaN(kgPrice) || kgPrice < 0) productSelect.focus();
            }
        }

        function removeItem(index) {
            if (index >= 0 && index < items.length) {
                 items.splice(index, 1);
                 // Renumber items
                 itemCount = 1;
                 items.forEach(item => { item.number = itemCount++; });
                 updateTable();
                 calculateChange();
            }
        }

        function updateTable() {
            let tableBody = document.getElementById("billList");
            tableBody.innerHTML = "";
            let total = 0;

            items.forEach((item, index) => {
                total += item.totalPrice;
                 // Display unit price appropriately
                 let displayUnitPrice = item.unitPrice?.toFixed(2) || '0.00'; // Default to 0.00 if undefined
                 if (item.type === 'weight') {
                     displayUnitPrice = `${item.unitPrice.toFixed(2)}/kg`;
                 } else if (item.type === 'ai_list_item_unknown' || (item.type === 'ai_single_item' && item.unitPrice === 0)) {
                    displayUnitPrice = '-'; // Show dash if price unknown from AI
                 } else if (item.type === 'custom' || item.type === 'calculator' || item.type === 'ai_single_item') {
                     // Use the stored unitPrice which is the actual value for these types
                      displayUnitPrice = item.unitPrice.toFixed(2);
                 } else {
                    // Standard quantity item, unitPrice is correct
                 }


                let row = `<tr>
                    <td>${item.number}</td>
                    <td>${item.name}</td>
                    <td>${item.quantity}</td>
                    <td style="text-align: right;">${displayUnitPrice}</td>
                    <td style="text-align: right;">${item.totalPrice.toFixed(2)}</td>
                    <td><button class="remove-item-button" onclick="removeItem(${index})">X</button></td>
                </tr>`;
                tableBody.innerHTML += row;
            });

            document.getElementById("total").innerText = total.toFixed(2);
             calculateChange(); // Recalculate change whenever the table updates
        }

        function calculateChange() {
            let total = parseFloat(document.getElementById("total").innerText) || 0;
            let cash = parseFloat(document.getElementById("cash").value) || 0;
            let change = cash - total;

            document.getElementById("changeLabel").innerText = change < 0 ? "හිඟ මුදල:" : "ඉතිරි මුදල:";
            document.getElementById("change").innerText = Math.abs(change).toFixed(2);
        }

        function calculateChangeOnEnter(event) {
            if (event.key === "Enter") {
                event.preventDefault();
                calculateChange();
                // Optional: Move focus elsewhere or trigger save/print?
            }
        }

        function resetBill() {
            items = [];
            itemCount = 1;
            updateTable();
            document.getElementById("cash").value = "";
             // Reset dropdowns and inputs
             document.getElementById("productSelect").value = "";
             document.getElementById("kgProductSelect").value = "";
             document.getElementById("price").value = "";
             document.getElementById("quantity").value = "1";
             document.getElementById("kgPrice").value = "";
             document.getElementById("weight").value = "";
             document.getElementById("customItemPrice").value = "";
             document.getElementById("customItemQuantity").value = "1";
             clearProcessingMessage('billing');
             console.log("Bill reset.");
        }

        function saveBillAndPrint() {
            const saved = saveBill(false); // Save but don't reset UI yet
             if (saved) {
                 const printedBillNumber = billNumber - 1; // Get the number that was just saved
                 printBill(printedBillNumber, true); // Print and pass flag to reset UI after printing attempt
             }
        }

        function saveBill(shouldReset = true) {
             if (items.length === 0) {
                 if(shouldReset) alert("බිල්පතට භාණ්ඩ එකතු කර නොමැත."); // Only alert if it's a standalone save action
                return false; // Indicate failure
            }
            const now = new Date();
            const billData = {
                billNumber: billNumber,
                items: JSON.parse(JSON.stringify(items)), // Deep copy items
                total: document.getElementById("total").innerText,
                cash: document.getElementById("cash").value || "0.00",
                change: document.getElementById("change").innerText,
                time: now.toLocaleString(), // Human readable time for display
                dateSaved: now.toISOString() // ISO string for reliable sorting/filtering
            };

            let savedBills = JSON.parse(localStorage.getItem("bills")) || [];
            savedBills.push(billData);

            // Store updated bills and next bill number
            localStorage.setItem("bills", JSON.stringify(savedBills));
            localStorage.setItem("billNumber", billNumber + 1);

             if(shouldReset) alert("බිල සුරක්ෂිතයි! බිල් අංකය: " + billNumber);

             console.log(`Bill ${billNumber} saved.`);
             // NEW: Trigger stock recalculation after saving a bill
             calculateEstimatedStockLevels(); // Update estimates based on new sale
             // Refresh stock display IF stock section is visible (though unlikely just after saving a bill)
             if (!document.getElementById("stockManagementSection").classList.contains("hidden") &&
                 !document.getElementById("stockManagementContent").classList.contains("hidden")) { // Check if content is visible too
                  loadStockItems(); // This will use the updated 'estimatedStockLevels'
             }


            billNumber++; // Increment global bill number for the next bill

            if (shouldReset) {
                 resetBill(); // Clear the UI for the next bill
            }
            return true; // Indicate success
        }

        function toggleCalculator() {
            let calculator = document.getElementById("calculator");
            if (calculator) {
                calculator.style.display = calculator.style.display === "none" ? "block" : "none";
                if (calculator.style.display === "block") {
                    document.getElementById("display").focus();
                }
            } else {
                console.error("Calculator element with id 'calculator' not found!");
            }
        }


        function toggleCustomItem() {
            let customItemSection = document.getElementById("customItemSection");
            customItemSection.classList.toggle("hidden");
            if (!customItemSection.classList.contains('hidden')) {
                // Focus on price input
                document.getElementById('customItemPrice').focus();
            }
        }
        // --- END Billing Section Logic ---


        // --- START Calculator Logic ---
        function appendCharacter(char) { document.getElementById("display").value += char; }
        function clearDisplay() { document.getElementById("display").value = ""; }
        function backspace() { let d = document.getElementById("display"); d.value = d.value.slice(0, -1); }
        function calculate() {
            let display = document.getElementById("display");
            try {
                 // Replace display symbols with JS operators
                 let expression = display.value.replace(/×/g, '*').replace(/÷/g, '/');
                 // Use Function constructor for safe evaluation
                 const result = Function('"use strict";return (' + expression + ')')();
                 // Check if result is a valid number
                 if (typeof result === 'number' && isFinite(result)) {
                     display.value = result;
                 } else {
                     display.value = "Error";
                 }
            } catch (error) {
                 console.error("Calculator error:", error);
                 display.value = "Error";
             }
        }
         function addToBill() {
            let display = document.getElementById("display");
            try {
                 let calcValue = parseFloat(display.value);
                if (!isNaN(calcValue) && calcValue >= 0) {
                    items.push({
                        number: itemCount++,
                        name: "කැල්කියුලේටරය",
                        quantity: 1, // Calculator adds one 'item'
                        unitPrice: calcValue,
                        totalPrice: calcValue,
                        type: 'calculator' // Mark as calculator item
                    });
                    updateTable();
                    clearDisplay();
                    toggleCalculator(); // Close calculator after adding
                } else {
                    alert("කරුණාකර වලංගු සංඛ්‍යාත්මක අගයක් කැල්කියුලේටරයෙන් ලබාගන්න.");
                }
            } catch (error) { alert("කරුණාකර වලංගු ගණනය කිරීමක් ඇතුලත් කරන්න"); }
        }
        // --- END Calculator Logic ---


        // --- START History Section Logic ---
        function loadBills() { searchBills(); } // Initial load calls search
         function searchBills() {
            let savedBills = JSON.parse(localStorage.getItem("bills")) || [];
            let searchDate = document.getElementById("searchDate").value;
            let timeRange = document.getElementById("timeRange").value;
            let filteredBills = savedBills;

            // Filter by date
            if (searchDate) {
                filteredBills = filteredBills.filter(bill => {
                    try {
                         // Ensure dateSaved exists and is valid before converting
                         if (!bill.dateSaved || isNaN(new Date(bill.dateSaved))) return false;
                         // Compare YYYY-MM-DD strings
                         let billDate = new Date(bill.dateSaved).toLocaleDateString('en-CA'); // Gets YYYY-MM-DD
                         return billDate === searchDate;
                    } catch (e) {
                        console.warn("Error parsing date for filtering bill:", bill, e);
                        return false; // Exclude bills with invalid dates
                    }
                });
            }
            // Filter by time range
            if (timeRange) {
                const [startHour, endHour] = timeRange.split('-').map(Number);
                filteredBills = filteredBills.filter(bill => {
                     try {
                         // Ensure dateSaved exists and is valid
                         if (!bill.dateSaved || isNaN(new Date(bill.dateSaved))) return false;
                         let billHour = new Date(bill.dateSaved).getHours();
                         // Handle time ranges correctly, including overnight
                         if (endHour === 24) { // e.g., 18-24 (6 PM to midnight)
                             return billHour >= startHour;
                         } else if (endHour === 6 && startHour === 0) { // e.g., 00-06 (midnight to 6 AM)
                             return billHour < endHour;
                         }
                         // Standard range e.g., 06-12 (6 AM to 11:59 AM)
                         return billHour >= startHour && billHour < endHour;
                    } catch (e) {
                        console.warn("Error parsing time for filtering bill:", bill, e);
                        return false; // Exclude bills with invalid times
                    }
                });
            }
            displayBills(filteredBills);
        }
        function displayBills(bills) {
            const billHistoryDiv = document.getElementById("billHistory");
            billHistoryDiv.innerHTML = "";
            if (bills.length === 0) {
                billHistoryDiv.innerHTML = "<p style='text-align: center;'>No bills found matching criteria.</p>"; return;
            }
            // Sort bills by date descending (most recent first)
            bills.sort((a, b) => {
                try {
                     const dateA = new Date(a.dateSaved || 0); // Use epoch start if date missing/invalid
                     const dateB = new Date(b.dateSaved || 0);
                     // Handle potential NaN dates during sort
                     if (isNaN(dateA) && isNaN(dateB)) return 0;
                     if (isNaN(dateA)) return 1; // Put invalid dates last
                     if (isNaN(dateB)) return -1;
                     return dateB - dateA; // Descending order
                } catch (e) { return 0; } // Prevent sort crash
             });

            let historyHTML = bills.map(bill => {
                 let itemsHTML = '';
                 if (bill.items && Array.isArray(bill.items)) {
                     itemsHTML = bill.items.map(item => {
                         // Use defaults for missing data to prevent errors
                         let qty = item.quantity !== undefined ? item.quantity : '?';
                         let uPrice = !isNaN(item.unitPrice) ? parseFloat(item.unitPrice).toFixed(2) : '?.??';
                         let tPrice = !isNaN(item.totalPrice) ? parseFloat(item.totalPrice).toFixed(2) : '?.??';
                         let name = item.name || 'Unknown';
                         let uPriceDisplay = item.type === 'weight' ? `${uPrice}/kg` : uPrice; // Show /kg if applicable
                        return `<p style="margin: 1px 0; font-size: 9px;"> - ${name} (${qty}) @ ${uPriceDisplay} = ${tPrice}</p>`;
                    }).join('');
                 } else { itemsHTML = '<p style="margin: 1px 0; font-size: 9px; color: orange;">Info: Items missing or invalid</p>'; }

                 // Format date and time safely
                 let displayDate = 'Invalid Date';
                 let displayTime = '';
                 try {
                     if (bill.dateSaved && !isNaN(new Date(bill.dateSaved))) {
                        let billDate = new Date(bill.dateSaved);
                        displayDate = billDate.toLocaleDateString();
                        displayTime = billDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true }); // AM/PM format
                     }
                 } catch (e) { /* Keep 'Invalid Date' */ }

                 let totalDisplay = !isNaN(bill.total) ? parseFloat(bill.total).toFixed(2) : '?.??';

                // Card structure
                return `<div class="bill-card">
                    <div onclick="showBillDetails(${bill.billNumber})" style="cursor: pointer;">
                        <p style="font-weight: bold; margin: 2px 0;">Bill: ${bill.billNumber} | ${displayDate} ${displayTime} | Total: ${totalDisplay} රු.</p>
                    </div>
                    <div style="margin-top: 5px;">
                        <button class="delete-button" onclick="deleteBillPrompt(event, ${bill.billNumber})">Delete</button>
                        <button class="print-button" onclick="printBill(${bill.billNumber})">Print</button>
                    </div>
                    <div class="bill-details" id="billDetails${bill.billNumber}">
                        <p>Time: ${displayDate} ${displayTime}</p>
                        <p>Total: ${totalDisplay} රු.</p>
                        <p>Cash: ${bill.cash || 'N/A'} රු.</p>
                        <p>Change: ${bill.change || 'N/A'} රු.</p>
                        <hr style="border-color: #555;">
                        <p><strong>Items:</strong></p>
                        ${itemsHTML}
                        <hr style="border-color: #555;">
                    </div>
                </div>`;
            }).join('');
            billHistoryDiv.innerHTML = historyHTML;
        }
        function showBillDetails(billNumber) {
            let billDetails = document.getElementById(`billDetails${billNumber}`);
            if (billDetails) {
                // Hide other details panes first
                document.querySelectorAll('.bill-details').forEach(d => {
                     if (d.id !== billDetails.id) d.style.display = 'none';
                 });
                 // Toggle the selected one
                billDetails.style.display = billDetails.style.display === "block" ? "none" : "block";
            }
        }
        function deleteBillPrompt(event, billNum) {
             event.stopPropagation(); // Prevent card click event
             selectedBillToDelete = billNum;
            document.getElementById("deletePasswordPrompt").classList.remove("hidden");
            document.getElementById("deletePassword").value = "";
            document.getElementById("deletePassword").focus();
        }
        function confirmDeleteBill() {
            let password = document.getElementById("deletePassword").value;
            if (password === deletePassword) {
                let savedBills = JSON.parse(localStorage.getItem("bills")) || [];
                let initialLength = savedBills.length;
                savedBills = savedBills.filter(bill => bill.billNumber !== selectedBillToDelete);
                 if (savedBills.length < initialLength) {
                     localStorage.setItem("bills", JSON.stringify(savedBills));
                     console.log(`Bill ${selectedBillToDelete} deleted.`);
                     loadBills(); // Refresh the history list
                     // NEW: Recalculate stock after deleting a bill
                     calculateEstimatedStockLevels();
                      if (!document.getElementById("stockManagementSection").classList.contains("hidden") &&
                          !document.getElementById("stockManagementContent").classList.contains("hidden")) { // Check if content is visible too
                           loadStockItems();
                      }
                 } else {
                    console.log(`Bill ${selectedBillToDelete} not found for deletion.`);
                 }
                 cancelDelete(); // Hide prompt
            } else {
                alert("වැරදි ඩිලීට් Password එකකි!");
                cancelDelete(); // Hide prompt even on failure
            }
        }
        function cancelDelete() {
            document.getElementById("deletePasswordPrompt").classList.add("hidden");
            document.getElementById("deletePassword").value = "";
            selectedBillToDelete = null;
        }
        function removeOldBills() {
            let savedBills = JSON.parse(localStorage.getItem("bills")) || [];
            if (savedBills.length === 0) return; // Nothing to do
            let oneMonthAgo = new Date();
            oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
            oneMonthAgo.setHours(0,0,0,0); // Start of the day one month ago

            let billsToKeep = savedBills.filter(bill => {
                try {
                    // Keep only if dateSaved is valid and within the last month
                    if (!bill.dateSaved) return false; // Remove if no date
                    let d = new Date(bill.dateSaved);
                    return !isNaN(d.getTime()) && d >= oneMonthAgo;
                } catch(e) {
                    return false; // Remove if date is unparseable
                }
            });

             if(billsToKeep.length < savedBills.length){
                console.log(`Removed ${savedBills.length - billsToKeep.length} bills older than 1 month or with invalid dates.`);
                localStorage.setItem("bills", JSON.stringify(billsToKeep));
                // Recalculate stock if old bills were removed
                calculateEstimatedStockLevels();
             }
        }
        // --- END History Section Logic ---


        // --- START Sales Report Logic ---
        function generateSalesReport() {
            let startDateStr = document.getElementById("reportStartDate").value;
            let endDateStr = document.getElementById("reportEndDate").value;
            // REMOVED: Reading otherExpenses input
            let savedBills = JSON.parse(localStorage.getItem("bills")) || [];
            let reportDiv = document.getElementById("salesReport");

             // Validate date inputs
             if (!startDateStr || !endDateStr) {
                 reportDiv.innerText = "කරුණාකර ආරම්භක සහ අවසන් දිනයන් තෝරන්න."; return;
             }

             let start, end;
             try {
                 start = new Date(startDateStr); start.setHours(0, 0, 0, 0); // Start of the selected day
                 end = new Date(endDateStr); end.setHours(23, 59, 59, 999); // End of the selected day
                 if (isNaN(start.getTime()) || isNaN(end.getTime())) {
                    throw new Error("Invalid date format");
                 }
             } catch (e) {
                 reportDiv.innerText = "කරුණාකර වලංගු දිනයන් තෝරන්න."; return;
             }

             // Check if start date is after end date
             if (start > end) {
                 reportDiv.innerText = "ආරම්භක දිනය අවසන් දිනයට පසුව විය නොහැක."; return;
             }

            // Filter bills based on the selected date range
            let filteredBills = savedBills.filter(bill => {
                try {
                    if (!bill.dateSaved) return false;
                    let d = new Date(bill.dateSaved);
                    // Check if the bill date is within the range [start, end]
                    return !isNaN(d.getTime()) && d >= start && d <= end;
                } catch(e) {
                    return false; // Exclude bills with invalid dates
                }
            });

            // Calculate total sales from filtered bills
            let totalSales = 0;
            filteredBills.forEach(bill => {
                let billTotal = parseFloat(bill.total);
                if (!isNaN(billTotal)) {
                    totalSales += billTotal;
                }
            });

            // Use the globally tracked totalStockCost (ensure it's up-to-date via loadStockItems)
            let currentTotalStockCost = totalStockCost; // Use the value updated by loadStockItems

            // Calculate profit: Sales - Total Recorded Stock Cost
            let profit = totalSales - currentTotalStockCost;

            // Generate the report text
            let reportText = `ආදායම් වාර්තාව (${startDateStr} සිට ${endDateStr})\n`;
            reportText += `------------------------------------\n`;
            reportText += `මුළු විකුණුම් ආදායම : ${totalSales.toFixed(2)} රු.\n`;
            reportText += `සම්පූර්ණ තොග වියදම* : ${currentTotalStockCost.toFixed(2)} රු.\n`; // Use tracked stock cost
            reportText += `------------------------------------\n`;
            reportText += `ඇස්තමේන්තුගත ලාභය : ${profit.toFixed(2)} රු.\n\n`;
            reportText += `*සටහන: තොග වියදම යනු 'තොග කළමනාකරණය' යටතේ මෙතෙක් වාර්තාගත සියලුම මිලදී ගැනීම් වල මුළු පිරිවැයයි.\n`;


            reportDiv.innerText = reportText;
        }
        // --- END Sales Report Logic ---


        // --- START Stock Management Logic ---

         // NEW: Check password for Stock Management section
         function checkStockManagementPassword() {
            let pass = document.getElementById("stockManagementPassword").value;
            if (pass === stockManagementPassword) {
                document.getElementById("stockManagementPasswordPrompt").classList.add("hidden");
                document.getElementById("stockManagementContent").classList.remove("hidden");
                // Load items AFTER password is confirmed
                loadStockItems();
            } else {
                alert("වැරදි Stock Management Password එකකි!");
                document.getElementById("stockManagementPassword").value = "";
            }
        }

         function addStockItem() {
            let nameInput = document.getElementById("stockItemName");
            let priceInput = document.getElementById("stockItemPrice"); // This is TOTAL cost for the quantity
            let quantityInput = document.getElementById("stockItemQuantity");
            let stockItemName = nameInput.value.trim();
            let stockItemTotalPrice = parseFloat(priceInput.value); // Total cost for the batch
            let stockItemQuantity = parseInt(quantityInput.value);

             if (!stockItemName) { alert("භාණ්ඩයේ නම ඇතුලත් කරන්න."); nameInput.focus(); return; }
            // Validate total price (can be 0, e.g., free sample, but usually > 0)
            if (isNaN(stockItemTotalPrice) || stockItemTotalPrice < 0) { alert("වලංගු මුළු මිලදී ගත් මිලක් ඇතුලත් කරන්න (0 හෝ වැඩි)."); priceInput.focus(); return; }
             // Validate quantity (must be > 0)
             if (isNaN(stockItemQuantity) || stockItemQuantity <= 0) { alert("වලංගු ප්‍රමාණයක් ඇතුලත් කරන්න (0 ට වැඩි)."); quantityInput.focus(); return; }

            saveStockItemData(stockItemName, stockItemQuantity, stockItemTotalPrice);

            // Clear inputs for next entry
            nameInput.value = ""; priceInput.value = ""; quantityInput.value = ""; nameInput.focus();
        }

         function saveStockItemData(name, quantity, totalCost) {
             let newStockItem = {
                name: name,
                totalCost: totalCost, // Total cost for this batch
                quantity: quantity,
                dateAdded: new Date().toISOString() // Record when added
            };
             stockItems.push(newStockItem);
             localStorage.setItem("stockItems", JSON.stringify(stockItems));
             console.log(`Stock item saved: ${name}, Qty: ${quantity}, Cost: ${totalCost}`);

             // Attempt to automatically update selling price based on this new cost
             try {
                 updateSellingPriceFromStock(name, quantity, totalCost);
             }
             catch (e) {
                 console.error("Error attempting to update selling price from stock data:", e);
             }

             // Refresh stock list display and update total expense calculation AND estimates
             loadStockItems(); // This calls calculateEstimatedStockLevels internally now
         }

         // Function to automatically suggest/update selling price based on cost price
         function updateSellingPriceFromStock(stockItemName, stockItemQuantity, stockItemTotalPrice) {
             if (stockItemQuantity <= 0) {
                 console.warn(`Cannot calculate unit cost for ${stockItemName}, quantity is zero or less.`);
                 return;
             }
             let unitCostPrice = stockItemTotalPrice / stockItemQuantity;
             let normStockName = normalizeName(stockItemName);

             // --- Find matching product (standard or KG) ---
             // Prioritize exact normalized match first
             let existingProductIndex = products.findIndex(p => normalizeName(p.name) === normStockName);
             let existingKgProductIndex = -1;
             if (existingProductIndex === -1) {
                 existingKgProductIndex = kgProducts.findIndex(p => normalizeName(p.name) === normStockName);
             }

             // If no exact match, try similarity match (e.g., "සබන් LUX" stock vs "සබන්" product)
             if (existingProductIndex === -1 && existingKgProductIndex === -1) {
                  console.log(`No exact normalized match for "${stockItemName}". Trying similarity check...`);
                 existingProductIndex = products.findIndex(p => areNamesSimilar(p.name, stockItemName));
                 if (existingProductIndex === -1) {
                     existingKgProductIndex = kgProducts.findIndex(p => areNamesSimilar(p.name, stockItemName));
                 }
             }
             // --- End Finding ---


             // --- Calculate and Update Selling Price ---
             let markup = 1.20; // Example: 20% markup (1.20 = 1 + 0.20)
             // Round selling price to nearest 5 or 10 cents or whole number? For now, 2 decimal places.
             let newSellingPrice = parseFloat((unitCostPrice * markup).toFixed(2));

             if (newSellingPrice <= 0 || isNaN(newSellingPrice)) {
                 console.warn(`Calculated selling price for ${stockItemName} is invalid (${newSellingPrice}). Not updating.`);
                 return;
             }

             if (existingProductIndex !== -1) {
                 const targetProduct = products[existingProductIndex];
                 const oldPrice = targetProduct.price;
                 targetProduct.price = newSellingPrice;
                 localStorage.setItem("products", JSON.stringify(products)); // PERSIST change
                 console.log(`Updated selling price for "${targetProduct.name}" from ${oldPrice.toFixed(2)} to ${newSellingPrice.toFixed(2)} based on stock "${stockItemName}"`);
                 loadProducts(); // Refresh product list and dropdown
             } else if (existingKgProductIndex !== -1) {
                  const targetKgProduct = kgProducts[existingKgProductIndex];
                  const oldPrice = targetKgProduct.price;
                  targetKgProduct.price = newSellingPrice; // Price per KG
                  localStorage.setItem("kgProducts", JSON.stringify(kgProducts)); // PERSIST change
                  console.log(`Updated selling price for KG item "${targetKgProduct.name}" from ${oldPrice.toFixed(2)}/kg to ${newSellingPrice.toFixed(2)}/kg based on stock "${stockItemName}"`);
                  loadKgProducts(); // Refresh KG product list and dropdown
             } else {
                 console.log(`Stock item "${stockItemName}" added, but no matching product/kg-product found for automatic selling price update. Consider adding it manually in Product Management.`);
             }
         }

        // MODIFIED: To calculate and display estimated stock levels
        function loadStockItems() {
            // 1. Calculate Estimated Levels FIRST
            calculateEstimatedStockLevels(); // Update the global 'estimatedStockLevels' object

            // 2. Display Stock Items and their estimates
            let stockListDiv = document.getElementById("stockList");
            if (!stockListDiv) { console.error("stockList element not found"); return; }
            stockListDiv.innerHTML = "";
            let currentTotalStockCost = 0; // Recalculate total cost from scratch

             // Sort stock items by date added descending (most recent first)
             stockItems.sort((a, b) => {
                try {
                     const dateA = new Date(a.dateAdded || 0);
                     const dateB = new Date(b.dateAdded || 0);
                     if (isNaN(dateA) && isNaN(dateB)) return 0;
                     if (isNaN(dateA)) return 1;
                     if (isNaN(dateB)) return -1;
                     return dateB - dateA; // Descending
                } catch (e) { return 0; }
             });

            stockItems.forEach((item, index) => {
                let itemDiv = document.createElement("div");
                itemDiv.classList.add("stock-item");
                 // Display details safely
                 let displayDate = 'N/D';
                 try { if(item.dateAdded && !isNaN(new Date(item.dateAdded))) displayDate = new Date(item.dateAdded).toLocaleDateString(); } catch(e) {}
                 let displayCost = (!isNaN(item.totalCost)) ? parseFloat(item.totalCost).toFixed(2) : '0.00';
                 let displayQty = item.quantity || 0;
                 let normName = normalizeName(item.name); // Normalize name to lookup estimate

                 // Get the estimated level (default to 'N/A' if not found)
                 let estimatedLevel = estimatedStockLevels[normName] !== undefined ? estimatedStockLevels[normName] : 'N/A';

                 // Format estimate: Show KG if it's a KG product, otherwise show count
                 let estimateDisplay = estimatedLevel;
                 if (estimatedLevel !== 'N/A' && !isNaN(estimatedLevel)) { // Check if it's a valid number
                      const isKgProduct = kgProducts.some(kgp => normalizeName(kgp.name) === normName || areNamesSimilar(kgp.name, item.name));
                      if (isKgProduct) {
                          estimateDisplay = `${parseFloat(estimatedLevel).toFixed(2)} kg`; // Show KG with 2 decimal places
                      } else {
                           // Round non-KG items (like count) to avoid decimals if they creep in
                          estimateDisplay = `${Math.round(parseFloat(estimatedLevel))}`; // Show as whole number count
                      }
                 } else {
                    estimateDisplay = 'N/A'; // Ensure it says N/A if calculation failed or result is NaN
                 }


                 itemDiv.innerHTML = `
                    <span style="flex-grow: 1; margin-right: 5px;">${index + 1}. ${item.name} (Qty:${displayQty}) Cost:${displayCost} [${displayDate}]</span>
                    <span class="estimated-stock">Est. Avail: ${estimateDisplay}</span>
                 `;
                stockListDiv.appendChild(itemDiv);
                // Add valid costs to the total
                currentTotalStockCost += parseFloat(displayCost);
            });

            // Update global variable and storage for total cost
            totalStockCost = currentTotalStockCost;
            localStorage.setItem("totalStockCost", totalStockCost.toFixed(2));
            updateTotalExpensesDisplay(); // Update the display in the Stock section
        }

        // NEW: Function to calculate estimated stock levels based on purchases and sales
        function calculateEstimatedStockLevels() {
            console.log("Calculating estimated stock levels...");
            estimatedStockLevels = {}; // Reset estimates
            const allStockItems = JSON.parse(localStorage.getItem("stockItems")) || [];
            const allBills = JSON.parse(localStorage.getItem("bills")) || [];

            let purchaseMap = {}; // { normalizedName: totalQuantityPurchased }
            let salesMap = {};    // { normalizedName: totalQuantitySold }

            // 1. Aggregate Purchases
            allStockItems.forEach(stockItem => {
                const normName = normalizeName(stockItem.name);
                const qty = parseFloat(stockItem.quantity) || 0;
                if (normName && qty > 0) {
                    purchaseMap[normName] = (purchaseMap[normName] || 0) + qty;
                }
            });
            // console.log("Purchase Map:", purchaseMap); // Less verbose logging

            // 2. Aggregate Sales
            allBills.forEach(bill => {
                if (bill.items && Array.isArray(bill.items)) {
                    bill.items.forEach(item => {
                        const itemName = item.name;
                        const normSoldName = normalizeName(itemName);
                        let soldQty = 0;

                        // Determine quantity sold based on item type
                        if (item.type === 'weight' && item.weightInKg) {
                            soldQty = parseFloat(item.weightInKg) || 0; // Use KG value
                        } else if (item.type === 'quantity' || item.type === 'custom' || item.type === 'ai_single_item' || item.type === 'ai_list_item_unknown' || item.type === 'calculator') {
                             // For all non-weight types, use the stored quantity (even for custom/AI)
                             soldQty = parseFloat(item.quantity) || 0; // Use standard quantity
                        } else {
                           // console.warn(`Unhandled item type for sales calculation: ${item.type}`, item); // Less verbose logging
                        }

                        if (normSoldName && soldQty > 0) {
                            // Find the best matching purchase item name based on similarity
                            let matchedPurchaseName = null;
                            // First, check for exact match in purchaseMap keys
                            if (purchaseMap.hasOwnProperty(normSoldName)) {
                                matchedPurchaseName = normSoldName;
                            } else {
                                // If no exact match, check for similarity against purchaseMap keys
                                for (const purchaseNameNorm in purchaseMap) {
                                    // Using areNamesSimilar which does normalized comparison
                                    if (areNamesSimilar(normSoldName, purchaseNameNorm)) {
                                        matchedPurchaseName = purchaseNameNorm;
                                        break; // Take the first similar match
                                    }
                                }
                            }


                             if (matchedPurchaseName) {
                                // Aggregate sales against the matched purchase name
                                salesMap[matchedPurchaseName] = (salesMap[matchedPurchaseName] || 0) + soldQty;
                            } else {
                                // console.warn(`Sold item "${itemName}" (normalized: ${normSoldName}) could not be matched to any purchased item.`); // Less verbose logging
                            }
                        }
                    });
                }
            });
            // console.log("Sales Map (mapped to purchase names):", salesMap); // Less verbose logging

            // 3. Calculate Estimated Levels
            for (const normName in purchaseMap) {
                const purchased = purchaseMap[normName] || 0;
                const sold = salesMap[normName] || 0;
                estimatedStockLevels[normName] = purchased - sold;
            }

            // console.log("Estimated Stock Levels:", estimatedStockLevels); // Less verbose logging
            // The global 'estimatedStockLevels' is now updated.
        }


        function updateTotalExpensesDisplay() {
             const totalExpensesSpan = document.getElementById("totalExpenses");
             if(totalExpensesSpan) {
                 totalExpensesSpan.innerText = totalStockCost.toFixed(2);
             }
        }

         // MODIFIED: Directly confirm and delete last stock item without password
         function confirmDeleteLastStockItemDirectly() {
             if (stockItems.length > 0) {
                 // Items are sorted descending by date, so index 0 is the most recent
                 let itemToDelete = stockItems[0];
                 let costDisplay = (!isNaN(itemToDelete.totalCost)) ? parseFloat(itemToDelete.totalCost).toFixed(2) : '??.??';
                 if (confirm(`අවසන් වරට ඇතුලත් කල (${itemToDelete.name} - ${costDisplay} රු.) තොග අයිතමය මකා දැමීමට ඔබට විශ්වාසද? මෙම ක්‍රියාව අහෝසි කළ නොහැක.`)) {
                     // Proceed with deletion
                     let deletedItem = stockItems.shift(); // Remove the first item (most recent)
                     localStorage.setItem("stockItems", JSON.stringify(stockItems)); // Update storage
                     console.log(`Deleted stock item: ${deletedItem.name}`);
                     loadStockItems(); // Reload list, recalculate total cost AND estimates
                     alert("අවසන් තොග අයිතමය සාර්ථකව මකා දමන ලදී.");
                 } else {
                     // User cancelled
                     console.log("Stock item deletion cancelled.");
                 }
             } else {
                 alert("මකා දැමීමට තොග දත්ත කිසිවක් හමුවී නැත.");
             }
         }

         /* REMOVED: deleteLastStockItemPrompt, confirmDeleteStockItem, cancelDeleteStockItem as password is removed */

         // --- END Stock Management Logic ---


         // --- START Product Management Logic ---
        function loadProducts() {
            let productSelect = document.getElementById("productSelect"); // Billing dropdown
            let currentVal = productSelect ? productSelect.value : null; // Preserve selection if possible
            if(productSelect) {
                productSelect.innerHTML = '<option value="">භාණ්ඩයක් තෝරන්න</option>';
                products.sort((a, b) => a.name.localeCompare(b.name, 'si')); // Sort Sinhala correctly
                products.forEach(p => {
                    let o = document.createElement("option");
                    o.value = p.name;
                    o.text = `${p.name} (${p.price.toFixed(2)})`;
                    productSelect.add(o);
                });
                 try { if (currentVal) productSelect.value = currentVal; } catch(e) { /* Ignore if value no longer exists */ }
             }
             // Update list only if product management section is actually visible and password entered
             if (document.getElementById("productManagementSection") &&
                 !document.getElementById("productManagementSection").classList.contains("hidden") &&
                 document.getElementById("productManagementContent") &&
                 !document.getElementById("productManagementContent").classList.contains("hidden")) {
                 displayProductList();
             }
        }
        function loadKgProducts() {
            let kgSelect = document.getElementById("kgProductSelect"); // Billing dropdown for KG
            let currentVal = kgSelect ? kgSelect.value : null; // Preserve selection
            if(kgSelect) {
                kgSelect.innerHTML = '<option value="">කිලෝ ග්‍රෑම් බාණ්ඩයක් තෝරන්න</option>';
                kgProducts.sort((a, b) => a.name.localeCompare(b.name, 'si'));
                kgProducts.forEach(p => {
                    let o = document.createElement("option");
                    o.value = p.name;
                    o.text = `${p.name} (${p.price.toFixed(2)}/kg)`; // Indicate price is per kg
                    kgSelect.add(o);
                });
                 try { if(currentVal) kgSelect.value = currentVal; } catch(e) { /* Ignore */ }
            }
             // Update list only if product management section is actually visible and password entered
             if (document.getElementById("productManagementSection") &&
                 !document.getElementById("productManagementSection").classList.contains("hidden") &&
                 document.getElementById("productManagementContent") &&
                 !document.getElementById("productManagementContent").classList.contains("hidden")) {
                 displayKgProductList();
             }
        }
        function updatePrice() { // When standard product dropdown changes in Billing
            let productSelect = document.getElementById("productSelect");
            let priceInput = document.getElementById("price");
            let qtyInput = document.getElementById("quantity");
            if (!productSelect || !priceInput || !qtyInput) return;

            let name = productSelect.value;
            let p = products.find(x => x.name === name);
            if (p) {
                 priceInput.value = p.price.toFixed(2);
                 qtyInput.value = "1"; // Default quantity to 1
                 qtyInput.focus(); // Move focus to quantity
             } else {
                 priceInput.value = ""; // Clear price if no product selected
             }
        }
        function updateKgPrice() { // When KG product dropdown changes in Billing
            let kgSelect = document.getElementById("kgProductSelect");
            let kgPriceInput = document.getElementById("kgPrice"); // Price per KG
            let weightInput = document.getElementById("weight");
             if (!kgSelect || !kgPriceInput || !weightInput) return;

            let name = kgSelect.value;
            let p = kgProducts.find(x => x.name === name);
            if (p) {
                 kgPriceInput.value = p.price.toFixed(2);
                 weightInput.value = ""; // Clear weight input
                 weightInput.focus(); // Move focus to weight
             } else {
                 kgPriceInput.value = ""; // Clear price if no product selected
             }
        }
        // Add a NEW standard product (Product Management)
        function addProduct() {
            let nameInput = document.getElementById("newProductName");
            let priceInput = document.getElementById("newProductPrice");
            let name = nameInput.value.trim();
            let price = parseFloat(priceInput.value);
            if (name && !isNaN(price) && price >= 0) {
                 let normName = normalizeName(name);
                 // Check for duplicates in BOTH lists using normalized names
                 if (products.some(p => normalizeName(p.name) === normName) || kgProducts.some(p => normalizeName(p.name) === normName)) {
                    alert("මෙම නමින් භාණ්ඩයක් (සාමාන්‍ය හෝ KG) දැනටමත් පවතී.");
                    return;
                }
                products.push({ name: name, price: price });
                localStorage.setItem("products", JSON.stringify(products)); // PERSIST
                loadProducts(); // Refresh list and dropdown
                nameInput.value = ""; priceInput.value = ""; // Clear inputs
                nameInput.focus();
            } else {
                alert("කරුණාකර වලංගු නම සහ මිල (0 හෝ වැඩි) ඇතුළත් කරන්න.");
                if (!name) nameInput.focus();
                else priceInput.focus();
            }
        }
        // Add a NEW KG product (Product Management)
        function addKgProduct() {
            let nameInput = document.getElementById("newKgProductName");
            let priceInput = document.getElementById("newKgProductPrice"); // Price PER KG
            let name = nameInput.value.trim();
            let price = parseFloat(priceInput.value); // Price per KG
            if (name && !isNaN(price) && price >= 0) {
                 let normName = normalizeName(name);
                 // Check for duplicates in BOTH lists using normalized names
                 if (products.some(p => normalizeName(p.name) === normName) || kgProducts.some(p => normalizeName(p.name) === normName)) {
                    alert("මෙම නමින් භාණ්ඩයක් (සාමාන්‍ය හෝ KG) දැනටමත් පවතී.");
                    return;
                }
                kgProducts.push({ name: name, price: price });
                localStorage.setItem("kgProducts", JSON.stringify(kgProducts)); // PERSIST
                loadKgProducts(); // Refresh KG list and dropdown
                nameInput.value = ""; priceInput.value = ""; // Clear inputs
                nameInput.focus();
            } else {
                alert("කරුණාකර වලංගු නම සහ කිලෝවක මිල (0 හෝ වැඩි) ඇතුළත් කරන්න.");
                 if (!name) nameInput.focus();
                 else priceInput.focus();
            }
        }
        // Display standard product list in Product Management
        function displayProductList() {
            let listDiv = document.getElementById("productList");
            if(!listDiv) return;
            listDiv.innerHTML = "";
            products.sort((a, b) => a.name.localeCompare(b.name, 'si'));
            products.forEach((p, i) => {
                let div = document.createElement("div"); div.classList.add("product-item");
                div.setAttribute('data-index', i); // Store index for editing
                div.innerHTML = `<span>${p.name} - ${p.price.toFixed(2)}</span> <div> <button class="edit-button" onclick="editProduct(${i})">Edit</button> <button class="delete-product-button" onclick="deleteProduct(${i})">Del</button> </div>`;
                listDiv.appendChild(div);
            });
        }
         // Display KG product list in Product Management
         function displayKgProductList() {
            let listDiv = document.getElementById("kgProductList");
            if(!listDiv) return;
            listDiv.innerHTML = "";
            kgProducts.sort((a, b) => a.name.localeCompare(b.name, 'si'));
            kgProducts.forEach((p, i) => {
                let div = document.createElement("div"); div.classList.add("kg-product-item");
                div.setAttribute('data-index', i); // Store index for editing
                 div.innerHTML = `<span>${p.name} - ${p.price.toFixed(2)}/kg</span> <div> <button class="edit-button" onclick="editKgProduct(${i})">Edit</button> <button class="delete-product-button" onclick="deleteKgProduct(${i})">Del</button> </div>`;
                listDiv.appendChild(div);
            });
        }
        // Edit standard product (show input fields)
        function editProduct(index) {
            cancelEdit(); cancelKgEdit(); // Cancel any other active edits first

            if (index < 0 || index >= products.length) return;
            let listDiv = document.getElementById("productList");
            if(!listDiv) return;
            let div = listDiv.querySelector(`.product-item[data-index="${index}"]`); // Find by index
            if (!div) return;

            let p = products[index];
            div.innerHTML = `<input type="text" style="width: 50%; display: inline-block;" id="editName${index}" value="${p.name}"> <input type="number" style="width: 25%; display: inline-block;" id="editPrice${index}" value="${p.price.toFixed(2)}"> <button class="save-button" style="width: auto;" onclick="saveProduct(${index})">Save</button> <button class="cancel-button" style="width: auto;" onclick="cancelEdit()">Cancel</button>`;
            document.getElementById(`editName${index}`)?.focus();
        }
        // Edit KG product (show input fields)
        function editKgProduct(index) {
            cancelEdit(); cancelKgEdit(); // Cancel any other active edits first

             if (index < 0 || index >= kgProducts.length) return;
             let listDiv = document.getElementById("kgProductList");
             if(!listDiv) return;
             let div = listDiv.querySelector(`.kg-product-item[data-index="${index}"]`); // Find by index
             if (!div) return;

            let p = kgProducts[index];
            div.innerHTML = `<input type="text" style="width: 50%; display: inline-block;" id="editKgName${index}" value="${p.name}"> <input type="number" style="width: 25%; display: inline-block;" id="editKgPrice${index}" value="${p.price.toFixed(2)}"> <button class="save-button" style="width: auto;" onclick="saveKgProduct(${index})">Save</button> <button class="cancel-button" style="width: auto;" onclick="cancelKgEdit()">Cancel</button>`;
            document.getElementById(`editKgName${index}`)?.focus();
        }
        // Save edited standard product
        function saveProduct(index) {
            let nameInput = document.getElementById(`editName${index}`);
            let priceInput = document.getElementById(`editPrice${index}`);
            if (!nameInput || !priceInput) return;

            let name = nameInput.value.trim();
            let price = parseFloat(priceInput.value);

             if (name && !isNaN(price) && price >= 0) {
                 let normName = normalizeName(name);
                 let originalNormName = normalizeName(products[index].name);
                // Check for duplicates ONLY if the name has changed, using normalized names
                if (normName !== originalNormName) {
                     if (products.some((p, i) => i !== index && normalizeName(p.name) === normName) || kgProducts.some(p => normalizeName(p.name) === normName)) {
                         alert("මෙම නමින් වෙනත් භාණ්ඩයක් (සාමාන්‍ය හෝ KG) දැනටමත් පවතී.");
                         return;
                     }
                }
                // Update product and save
                products[index].name = name; products[index].price = price;
                localStorage.setItem("products", JSON.stringify(products)); // PERSIST
                loadProducts(); // Refresh standard list and dropdown
             } else {
                alert("කරුණාකර වලංගු නම සහ මිල (0 හෝ වැඩි) ඇතුළත් කරන්න.");
            }
        }
        // Save edited KG product
        function saveKgProduct(index) {
            let nameInput = document.getElementById(`editKgName${index}`);
            let priceInput = document.getElementById(`editKgPrice${index}`); // Price per KG
            if (!nameInput || !priceInput) return;

            let name = nameInput.value.trim();
            let price = parseFloat(priceInput.value); // Price per KG

             if (name && !isNaN(price) && price >= 0) {
                 let normName = normalizeName(name);
                 let originalNormName = normalizeName(kgProducts[index].name);
                 // Check for duplicates ONLY if the name has changed, using normalized names
                 if (normName !== originalNormName) {
                      if (kgProducts.some((p, i) => i !== index && normalizeName(p.name) === normName) || products.some(p => normalizeName(p.name) === normName)) {
                         alert("මෙම නමින් වෙනත් භාණ්ඩයක් (සාමාන්‍ය හෝ KG) දැනටමත් පවතී.");
                         return;
                     }
                 }
                 // Update product and save
                kgProducts[index].name = name; kgProducts[index].price = price;
                localStorage.setItem("kgProducts", JSON.stringify(kgProducts)); // PERSIST
                loadKgProducts(); // Refresh KG list and dropdown
             } else {
                alert("කරුණාකර වලංගු නම සහ කිලෝවක මිල (0 හෝ වැඩි) ඇතුළත් කරන්න.");
            }
        }
        function cancelEdit() { displayProductList(); } // Just redisplay the normal list to cancel edit UI
        function cancelKgEdit() { displayKgProductList(); } // Just redisplay the normal list to cancel edit UI

        // Delete standard product
        function deleteProduct(index) {
            if (index < 0 || index >= products.length) return;
            let name = products[index].name;
            if (confirm(`"${name}" භාණ්ඩය ලැයිස්තුවෙන් සහ බිල්පත් තේරීමෙන් මකා දැමීමට ඔබට විශ්වාසද?`)) {
                 products.splice(index, 1);
                 localStorage.setItem("products", JSON.stringify(products)); // PERSIST
                 loadProducts(); // Refresh list and dropdown
                 console.log(`Deleted product: ${name}`);
            }
        }
        // Delete KG product
        function deleteKgProduct(index) {
             if (index < 0 || index >= kgProducts.length) return;
             let name = kgProducts[index].name;
            if (confirm(`"${name}" කිලෝ ග්‍රෑම් භාණ්ඩය ලැයිස්තුවෙන් සහ බිල්පත් තේරීමෙන් මකා දැමීමට ඔබට විශ්වාසද?`)) {
                 kgProducts.splice(index, 1);
                 localStorage.setItem("kgProducts", JSON.stringify(kgProducts)); // PERSIST
                 loadKgProducts(); // Refresh list and dropdown
                 console.log(`Deleted KG product: ${name}`);
             }
        }
         // Check password for Product Management section
         function checkProductManagementPassword() {
            let pass = document.getElementById("productManagementPassword").value;
            if (pass === productManagementPassword) {
                document.getElementById("productManagementPasswordPrompt").classList.add("hidden");
                document.getElementById("productManagementContent").classList.remove("hidden");
                // Load lists when content is shown
                loadProducts();
                loadKgProducts();
            } else {
                alert("වැරදි Product Management Password එකකි!");
                document.getElementById("productManagementPassword").value = "";
            }
        }
         // --- END Product Management Logic ---


         // --- START Printing Logic ---
         function printBill(billNumToPrint, shouldResetBillingUI = false) {
            let savedBills = JSON.parse(localStorage.getItem("bills")) || [];
            let bill = savedBills.find(b => b.billNumber === billNumToPrint);
             if (bill) {
                 // Build HTML content for printing
                 let printContent = `<div style="font-family: 'Courier New', monospace; width: 280px; margin: auto; font-size: 10px; line-height: 1.3;"> <h2 style="text-align: center; margin: 5px 0; font-size: 12px;">විතානගේ ස්ටෝස්</h2> <p style="text-align: center; margin: 2px 0;">-------------------------</p> <p style="margin: 2px 0;">Bill No: ${bill.billNumber}</p> <p style="margin: 2px 0;">Date: ${new Date(bill.dateSaved).toLocaleDateString()} ${new Date(bill.dateSaved).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false })}</p> <p style="margin: 2px 0;">-------------------------</p> <table style="width: 100%; border-collapse: collapse; font-size: 10px;"> <thead> <tr> <th style="text-align: left;">Item</th> <th style="text-align: right;">Qty</th> <th style="text-align: right;">Amount</th> </tr> </thead> <tbody>`;
                 if (bill.items && Array.isArray(bill.items)) {
                     bill.items.forEach(item => {
                          // Shorten long names for receipt
                          let name = (item.name || 'Unk').length > 15 ? (item.name.substring(0, 14) + '.') : (item.name || 'Unk');
                          let qty = item.quantity !== undefined ? item.quantity : '?';
                          let price = !isNaN(item.totalPrice) ? parseFloat(item.totalPrice).toFixed(2) : '?.??';
                         printContent += `<tr> <td style="text-align: left; padding-right: 3px; word-break: break-all;">${name}</td> <td style="text-align: right;">${qty}</td> <td style="text-align: right;">${price}</td> </tr>`; }); }
                 printContent += `</tbody> </table> <p style="margin: 2px 0;">-------------------------</p> <p style="text-align: right; margin: 2px 0; font-weight: bold; font-size: 11px;">Total: ${parseFloat(bill.total).toFixed(2)} රු.</p>`;
                 // Add cash/change only if cash was entered
                 if (parseFloat(bill.cash) > 0) {
                      let cashVal = parseFloat(bill.cash);
                      let changeVal = parseFloat(bill.change);
                      if(!isNaN(cashVal) && !isNaN(changeVal)) {
                        printContent += `<p style="text-align: right; margin: 1px 0;">Cash : ${cashVal.toFixed(2)}</p><p style="text-align: right; margin: 1px 0;">Change: ${changeVal.toFixed(2)}</p>`;
                      }
                 }
                 printContent += `<p style="margin: 2px 0;">-------------------------</p> <p style="text-align: center; margin-top: 5px; font-size: 9px;">Thank You! Come Again.</p> <p style="text-align: center; margin: 0;">.</p> </div>`; // Extra dot for paper feed

                  // --- Attempt Native Printing ---
                  let printedNatively = false;
                  if (window.cordova?.plugins?.printer?.print) {
                      printedNatively = true;
                      console.log("Attempting print via Cordova Printer Plugin...");
                      window.cordova.plugins.printer.print(printContent, { name: `Bill_${bill.billNumber}` }, (res) => {
                           console.log('Cordova Print result:', res);
                           if (shouldResetBillingUI && res) {
                                resetBill(); // Reset UI only on successful print
                           } else if (!res) {
                                console.warn('Cordova Print reported failure or cancellation.');
                                // Optional: Reset anyway? Or alert user?
                                if (shouldResetBillingUI) resetBill(); // Reset if requested, even on fail
                           }
                       });
                  }
                  else if (window.Capacitor?.Plugins?.Printer?.print) {
                      printedNatively = true;
                       console.log("Attempting print via Capacitor Printer Plugin...");
                       window.Capacitor.Plugins.Printer.print({ content: printContent })
                       .then(() => {
                           console.log('Capacitor Print OK');
                           if (shouldResetBillingUI) resetBill(); // Reset UI on success
                        })
                       .catch(e => {
                           console.error('Capacitor Print Error:', e);
                           alert("Printing failed via Capacitor plugin. Error: " + e.message);
                            if (shouldResetBillingUI) resetBill(); // Reset even on error if requested
                        });
                  }

                  // --- Fallback to Browser Print ---
                  if (!printedNatively) {
                      console.warn("Native print plugin not found. Using window.print() fallback.");
                      let printWin = window.open('', '_blank', 'height=600,width=400');
                     if (printWin) {
                         printWin.document.write(`<html><head><title>Print Bill ${bill.billNumber}</title><style>body{font-family:"Courier New",monospace;font-size:10px;line-height:1.3;margin:5px;}table{width:100%;border-collapse:collapse}td,th{padding:1px}@media print { body { margin: 0; } }</style></head><body>${printContent}</body></html>`);
                         printWin.document.close();
                         setTimeout(() => { // Allow content to render before printing
                             try {
                                 printWin.focus();
                                 printWin.print();
                                 // Closing the window immediately after print might cancel it in some browsers
                                 // Consider leaving it open or closing after a longer delay if needed.
                                 // printWin.close();
                                 if (shouldResetBillingUI) {
                                     setTimeout(resetBill, 1000); // Reset after a short delay
                                 }
                             } catch (e) {
                                 console.error("Browser print error:", e);
                                 alert("Browser print failed. Check console.");
                                 if (printWin) printWin.close(); // Try to close the failed window
                                 if (shouldResetBillingUI) resetBill(); // Reset even if print failed
                             }
                         }, 500);
                      } else {
                          alert("Popup blocked? Could not open print window.");
                          if (shouldResetBillingUI) resetBill(); // Reset if window couldn't open
                      }
                  }
             } else {
                 alert(`Bill ${billNumToPrint} not found.`);
                  if (shouldResetBillingUI) resetBill(); // Reset if bill wasn't found?
             }
         }
         // --- END Printing Logic ---


         // --- START Image Capture & Processing Setup ---
         function setupFileInputListener() {
             const fileInput = document.getElementById('billImage');
             if (fileInput) {
                 fileInput.onchange = () => {
                     const file = fileInput.files[0];
                     const context = fileInput.getAttribute('data-capture-context') || 'unknown';
                     const section = determineSectionFromContext(context);

                     if (file) {
                         const reader = new FileReader();
                         reader.onloadend = function() {
                             const base64String = reader.result.split(',')[1];
                             if (base64String) {
                                  console.log(`File read for context: ${context}`);
                                  processImageData(base64String, context); // Process automatically
                             } else {
                                showProcessingMessage(section, 'Error reading file data.', true);
                                handleImageProcessingCompletion(false, context);
                             }
                         }
                         reader.onerror = function(err) {
                            console.error("FileReader error:", err);
                            showProcessingMessage(section, 'Error reading file.', true);
                            handleImageProcessingCompletion(false, context);
                        }
                         reader.readAsDataURL(file);
                     } else {
                        handleImageProcessingCompletion(false, context);
                     }
                     // Reset file input and context after processing attempt
                     fileInput.value = null; // Clear file selection
                     fileInput.removeAttribute('data-capture-context');
                 };
             } else { console.error(`File input #billImage not found.`); }
         }

        function determineSectionFromContext(context) {
             if (context === 'stock_ai') return 'stock';
             if (context === 'product_management_scan') return 'product';
             return 'billing'; // Default to billing section
        }

        function captureImage(context) {
            const sectionForMessage = determineSectionFromContext(context);

            if (!GEMINI_API_KEY || GEMINI_API_KEY === "YOUR_GEMINI_API_KEY") {
                 showProcessingMessage(sectionForMessage, 'AI ක්‍රියාකාරීත්වය සඳහා API Key එකක් අවශ්‍යයි.', true);
                 handleImageProcessingCompletion(false, context);
                 return;
             }


            if (!isNativeEnvironment) {
                console.warn("Not in native environment. Triggering file input fallback for context:", context);
                const fileInput = document.getElementById('billImage');
                if (fileInput) {
                    fileInput.setAttribute('data-capture-context', context); // Store context
                    fileInput.click(); // Trigger file selection dialog
                } else {
                    showProcessingMessage(sectionForMessage, 'කැමරාව ලබා ගත නොහැක. කරුණාකර ගොනුවක් තෝරන්න.', true);
                    console.error('File input #billImage not found for fallback.');
                    handleImageProcessingCompletion(false, context);
                }
                return;
            }

            console.log(`Attempting native camera capture for context: ${context}`);
            showProcessingMessage(sectionForMessage, 'කැමරාව විවෘත වෙමින් පවතී...');

             const successCallback = (imageData) => {
                 console.log("Image data received from native camera.");
                 clearProcessingMessage(sectionForMessage); // Clear "Opening camera..." message
                 if (imageData) {
                     processImageData(imageData, context); // Pass context along for auto-processing
                 } else {
                    console.error('Received null or empty image data from plugin.');
                    handleCaptureError(sectionForMessage, 'ඡායාරූප දත්ත ලබා ගැනීමට නොහැකි විය.', context);
                 }
             };

             const errorCallback = (message) => {
                 handleCaptureError(sectionForMessage, message, context);
             };

             const options = {
                 quality: 75, // Use lower quality for faster uploads
                 destinationType: window.Camera?.DestinationType?.DATA_URL || 0, // 0 = DATA_URL (Base64)
                 sourceType: window.Camera?.PictureSourceType?.CAMERA || 1, // 1 = CAMERA
                 encodingType: window.Camera?.EncodingType?.JPEG || 0, // 0 = JPEG
                 mediaType: window.Camera?.MediaType?.PICTURE || 0, // 0 = PICTURE
                 correctOrientation: true,
                 saveToPhotoAlbum: false // Don't save to gallery
             };

             // Prioritize Capacitor, then Cordova
             if (window.Capacitor?.Plugins?.Camera?.getPhoto) {
                  console.log("Using Capacitor Camera API");
                 window.Capacitor.Plugins.Camera.getPhoto({
                     quality: options.quality,
                     allowEditing: false, // Usually false for scans
                     resultType: window.Capacitor.CameraResultType.Base64, // Correct enum for Capacitor
                     source: window.Capacitor.CameraSource.Camera, // Correct enum
                     correctOrientation: options.correctOrientation
                 }).then(image => {
                     if (image && image.base64String) {
                         successCallback(image.base64String);
                     } else {
                         // Handle potential cancellation or error within Capacitor result structure
                         errorCallback(image?.errorMessage || 'Failed to get base64 string from Capacitor Camera.');
                     }
                 })
                 .catch(error => {
                     // Catch errors from the getPhoto promise itself
                      console.error("Capacitor Camera getPhoto error:", error);
                      errorCallback(error?.message || 'Capacitor Camera Plugin Error');
                  });
             }
             else if (navigator.camera?.getPicture) {
                  console.log("Using Cordova Camera API (navigator.camera.getPicture)");
                  navigator.camera.getPicture(successCallback, errorCallback, options);
             }
             else {
                  // This case should ideally not happen if isNativeEnvironment is true and checks passed
                  console.error("Camera plugin check failed unexpectedly in native environment.");
                  errorCallback('කැමරා plugin එක හමු නොවුනි.');
              }
          }

         function processImageData(base64ImageData, context) {
             // Route based on the context passed from captureImage
             // These functions will automatically add items upon success
             switch (context) {
                 case 'single_item_price':
                     extractSingleItemAndPriceFromImage(base64ImageData);
                     break;
                 case 'billing_list':
                     addItemsFromListUsingGemini(base64ImageData);
                     break;
                 case 'stock_ai':
                     addStockFromBillUsingGemini(base64ImageData);
                     break;
                 case 'product_management_scan':
                     extractProductDetailsFromImage(base64ImageData);
                     break;
                 default:
                     console.error(`Unknown processing context: ${context}`);
                     const section = determineSectionFromContext(context);
                     showProcessingMessage(section, `Unknown context: ${context}`, true);
                     handleImageProcessingCompletion(false, context);
             }
         }

         function handleCaptureError(section, message, originalContext) {
             console.error('Camera Plugin Error:', message);
             let errorMessage = 'Unknown camera error';
             // Try to extract a meaningful message
             if (typeof message === 'string') { errorMessage = message; }
             else if (message && typeof message === 'object' && message.message) { errorMessage = message.message; }
             else { try { errorMessage = JSON.stringify(message); } catch (e) {} } // Fallback to stringify

             // Check for common cancellation messages (these can vary between plugins/platforms)
             const cancelledMsgs = ['cancelled', 'no image selected', 'selection cancelled', '20', 'user cancelled', 'camera cancelled', 'operation cancelled', 'did not return data']; // Added 'did not return data'
             if (cancelledMsgs.some(msg => errorMessage.toLowerCase().includes(msg))) {
                 console.log('Camera action cancelled by user.');
                 clearProcessingMessage(section); // Just clear the message, don't show error
             } else if (errorMessage.toLowerCase().includes('permission')) {
                 showProcessingMessage(section, 'කැමරා අවසරය අවශ්‍යයි. කරුණාකර app settings බලන්න.', true);
             } else {
                 showProcessingMessage(section, 'කැමරා දෝෂයකි: ' + errorMessage, true);
             }
             handleImageProcessingCompletion(false, originalContext); // Indicate failure
         }

         function handleImageProcessingCompletion(success, originalContext) {
             console.log(`Image processing complete for context ${originalContext}. Success: ${success}`);
             // The specific AI functions now handle success/error messages and actions (like adding items).
             // No further general action needed here.
         }
         // --- END Image Capture & Processing Setup ---


        // --- START AI Single Item & Price Scan Logic (Billing) ---
        function scanSingleItemAndPrice() {
             captureImage('single_item_price');
         }

        async function extractSingleItemAndPriceFromImage(base64ImageData) {
            const currentSection = 'billing';
            showProcessingMessage(currentSection, 'AI මගින් භාණ්ඩය සහ මිල සොයමින් පවතී...');
            console.log("Sending image to Gemini for Single Item & Price Scan...");
            let success = false;

             // Prompt asking for name and price
             const prompt = `Analyze the image for a single product, possibly with a price tag visible. Extract the main product name (use Sinhala if possible, be concise) and its numerical price.
             Respond strictly with a JSON object like this: {"item": "PRODUCT_NAME", "price": PRICE_NUMBER}.
             Example: {"item": "සබන්", "price": 140.00}
             If a name is unclear, use "AI Scanned Item". If a price is unclear or not found, use 0 as the price value.
             Do not include currency symbols (like Rs. or රු) or any text outside the JSON object. Output only the JSON.`;

            const payload = {
               "contents": [{
                   "parts": [
                       { "text": prompt },
                       { "inline_data": { "mime_type": "image/jpeg", "data": base64ImageData } }
                   ]
               }],
               "generationConfig": { "temperature": 0.2, "maxOutputTokens": 150 }
            };

            try {
                const response = await fetch(GEMINI_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const data = await response.json();
                console.log("Gemini Single Item & Price Scan Raw Response:", JSON.stringify(data));

                if (!response.ok) { throw new Error(`API Error (${response.status}): ${data?.error?.message || 'Unknown error'}`); }
                if (data.promptFeedback?.blockReason) { throw new Error(`Request blocked: ${data.promptFeedback.blockReason}. Details: ${JSON.stringify(data.promptFeedback.safetyRatings)}`); }
                if (!data.candidates || !data.candidates[0]?.content?.parts?.[0]?.text) { throw new Error("AI ප්‍රතිචාරයේ අන්තර්ගතයක් නොමැත."); }

                let jsonString = cleanGeminiResponse(data.candidates[0].content.parts[0].text);
                let detectedData = {};
                try { detectedData = JSON.parse(jsonString); }
                catch (parseError) { console.error("Failed to parse Gemini JSON for single item:", parseError, "\nRaw response text:", jsonString); throw new Error("AI ප්‍රතිචාරය (JSON) තේරුම් ගැනීමට නොහැකි විය."); }

                const name = detectedData.item?.trim() || "AI Scanned Item";
                const price = parseFloat(detectedData.price); // Price from AI

                if (name && !isNaN(price) && price >= 0) { // Check if name exists and price is valid
                    items.push({ // AUTOMATICALLY ADD to bill
                        number: itemCount++,
                        name: name,
                        quantity: 1, // Assume quantity 1 for single scan
                        unitPrice: price, // Use price found by AI
                        totalPrice: price, // Total price is just the unit price here
                        type: 'ai_single_item' // Mark as AI scanned
                    });
                    updateTable(); // Add to bill
                    showProcessingMessage(currentSection, `AI එකතු කරන ලදී: ${name} - ${price.toFixed(2)} රු.`);
                    success = true;
                    setTimeout(() => clearProcessingMessage(currentSection), 3000);

                } else {
                      // JSON parsed but name or price is invalid/missing
                      let errorMsg = "AI මගින් වලංගු නමක් හෝ මිලක් හඳුනාගැනීමට නොහැකි විය.";
                      if (!name) errorMsg += " (නම නොමැත)";
                      if (isNaN(price) || price < 0) errorMsg += " (මිල වැරදියි)";
                      console.warn(`AI response invalid: ${jsonString}`);
                      throw new Error(errorMsg);
                }

            } catch (error) {
                console.error('Error getting single item/price from Gemini:', error);
                showProcessingMessage(currentSection, 'AI Scan දෝෂයකි: ' + error.message, true);
                success = false;
                setTimeout(() => clearProcessingMessage(currentSection), 5000); // Keep error message longer

            } finally {
                 handleImageProcessingCompletion(success, 'single_item_price');
            }
        }
        // --- END AI Single Item & Price Scan Logic ---


         // --- START AI Billing Item Scan (Gemini) Logic (Billing) ---
         function scanBillingItems() {
            captureImage('billing_list');
         }

         async function addItemsFromListUsingGemini(base64ImageData) {
             const currentSection = 'billing';
             showProcessingMessage(currentSection, 'AI මගින් බඩු ලැයිස්තුව Scan වෙමින් පවතී...');
             console.log("Sending image to Gemini for Billing List Scan...");
             let success = false;

             // Prompt remains focused on item name and quantity for lists.
             // Trying to get reliable prices from lists is often inaccurate.
             // We will rely on matching the name to our stored products.
             const prompt = `Analyze the image, which could be a handwritten or printed shopping list, or show multiple product packages. Identify each distinct item name and its quantity if specified (assume quantity 1 if not mentioned). Ignore any prices shown in the image.
             Format the output strictly as a JSON array of objects. Each object must have "item" (string, use Sinhala if possible, keep it concise) and "quantity" (number, defaulting to 1).
             Example: [{"item": "සබන්", "quantity": 2}, {"item": "කිරි පිටි", "quantity": 1}, {"item": "හාල්", "quantity": 5}]
             If no items are clearly identifiable, return an empty array []. Do not include explanations, notes, or any text outside the JSON array. Focus on accuracy of item names and quantities found.`;


             const payload = {
                "contents": [{ "parts": [ { "text": prompt }, { "inline_data": { "mime_type": "image/jpeg", "data": base64ImageData } } ] }],
                "generationConfig": { "temperature": 0.3, "maxOutputTokens": 1024 }
             };

             try {
                 const response = await fetch(GEMINI_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                 const data = await response.json();
                 console.log("Gemini Billing List Raw Response:", JSON.stringify(data));

                 if (!response.ok) { throw new Error(`API Error (${response.status}): ${data?.error?.message || 'Unknown error'}`); }
                 if (data.promptFeedback?.blockReason) { throw new Error(`Request blocked: ${data.promptFeedback.blockReason}. Details: ${JSON.stringify(data.promptFeedback.safetyRatings)}`); }
                 if (!data.candidates || !data.candidates[0]?.content?.parts?.[0]?.text) { throw new Error("AI ප්‍රතිචාරයේ අන්තර්ගතයක් නොමැත."); }


                 let jsonString = cleanGeminiResponse(data.candidates[0].content.parts[0].text);
                 let detectedItems = [];
                 try { detectedItems = JSON.parse(jsonString); }
                 catch (parseError) { console.error("Failed to parse Gemini JSON for billing list:", parseError, "\nRaw response text:", jsonString); throw new Error("AI ප්‍රතිචාරය (JSON) තේරුම් ගැනීමට නොහැකි විය."); }

                 if (!Array.isArray(detectedItems)) { throw new Error("AI ප්‍රතිචාරය බලාපොරොත්තු වූ array ආකෘතියෙන් නොවේ."); }

                 if (detectedItems.length > 0) {
                     let itemsAddedCount = 0;
                     detectedItems.forEach(detectedItem => {
                         const name = detectedItem.item?.trim();
                         const quantity = parseInt(detectedItem.quantity); // Get quantity

                         // Validate data from AI
                         if (name && !isNaN(quantity) && quantity > 0) {
                             let price = 0; let itemType = 'ai_list_item'; let unitPriceForDisplay = 0; let displayQuantity = quantity; let weightInKg = null;
                             const normName = normalizeName(name);

                             // Try to find the item in existing product lists to get price
                             // Check standard products first
                             let product = products.find(p => normalizeName(p.name) === normName || areNamesSimilar(p.name, name));
                             let kgProduct = null;
                             if (!product) { // If not in standard, check KG products
                                kgProduct = kgProducts.find(p => normalizeName(p.name) === normName || areNamesSimilar(p.name, name));
                             }


                             if (product) { // Found in standard products
                                 unitPriceForDisplay = product.price;
                                 price = product.price * quantity;
                                 itemType = 'quantity'; // Treat as a normal quantity item now
                             } else if (kgProduct) { // Found in KG products
                                 // Assumption: Quantity from AI for a matched KG item is likely KG.
                                 unitPriceForDisplay = kgProduct.price; // Price per KG
                                 price = kgProduct.price * quantity; // Total price = price/kg * quantity_kg
                                 displayQuantity = quantity + 'kg'; // Display as 'Xkg'
                                 weightInKg = quantity; // Assume quantity is KG for stock calculation
                                 itemType = 'weight'; // Treat as a weight item
                                 console.warn(`AI detected KG item "${name}". Assumed quantity ${quantity} is in KG. Please verify in the bill.`);
                             } else {
                                 // Item not found in either list
                                 price = 0; // Add with price 0
                                 unitPriceForDisplay = 0;
                                 itemType = 'ai_list_item_unknown'; // Mark as unknown
                                 console.warn(`AI detected item "${name}" not found in product lists. Added with price 0. Please verify.`);
                             }

                             // Add the item AUTOMATICALLY to the current bill
                             items.push({
                                 number: itemCount++,
                                 name: name,
                                 quantity: displayQuantity, // Use 'Xkg' string if applicable
                                 unitPrice: unitPriceForDisplay,
                                 totalPrice: price,
                                 type: itemType,
                                 weightInKg: weightInKg // Add weight in KG if applicable
                                });
                             itemsAddedCount++;
                         } else { console.warn("Skipping invalid item from AI billing list:", detectedItem); }
                     });

                     if (itemsAddedCount > 0) {
                         updateTable(); // Refresh the bill table
                         showProcessingMessage(currentSection, `AI මගින් භාණ්ඩ ${itemsAddedCount} ක් එකතු කරන ලදී. මිල ගණන් සහ බර/ප්‍රමාණයන් තහවුරු කරන්න.`);
                         success = true;
                          setTimeout(() => clearProcessingMessage(currentSection), 5000); // Keep message longer
                     } else {
                         // Parsed JSON but contained no valid items
                         showProcessingMessage(currentSection, "AI ප්‍රතිචාරයේ වලංගු භාණ්ඩ හමු නොවීය.", true);
                         success = false;
                          setTimeout(() => clearProcessingMessage(currentSection), 4000);
                     }
                 } else {
                      // AI returned empty array []
                      showProcessingMessage(currentSection, "AI මගින් භාණ්ඩ හඳුනාගැනීමට නොහැකි විය.", true);
                      success = false;
                       setTimeout(() => clearProcessingMessage(currentSection), 4000);
                 }

             } catch (error) {
                 console.error('Error processing billing list with Gemini:', error);
                 showProcessingMessage(currentSection, 'AI Scan දෝෂයකි: ' + error.message, true);
                 success = false;
                  setTimeout(() => clearProcessingMessage(currentSection), 5000); // Keep error longer
             } finally {
                 handleImageProcessingCompletion(success, 'billing_list');
             }
         }
         // --- END AI Billing Item Scan (Gemini) Logic ---


         // --- START AI Stock Bill Scan (Gemini) Logic (Stock Management) ---
         function scanStockBill() {
            captureImage('stock_ai');
         }

         async function addStockFromBillUsingGemini(base64ImageData) {
             const currentSection = 'stock';
             showProcessingMessage(currentSection, 'AI මගින් තොග බිල්පත Scan වෙමින් පවතී...');
             console.log("Sending image to Gemini for Stock Bill Scan...");
             let success = false;
             let addedItemsForStockCheck = []; // Keep track of names added in this scan

             // Prompt remains the same: get item name, quantity, and TOTAL COST per line
             const prompt = `Analyze the provided store receipt/invoice image. Identify each purchased item line. Extract the item name (use Sinhala if possible, include brand/weight details if present), the quantity purchased for that line, and the total cost paid for that specific line item (amount after potential line discounts, not unit price or overall bill total).
             Format the output strictly as a JSON array of objects. Each object must have "item" (string), "quantity" (number, default 1 if unclear), and "total_cost" (number).
             Ignore sub-totals, taxes, overall totals, payment details listed separately. Focus only on the individual item lines showing name, quantity, and line total cost. Aim for accuracy.
             Example: [{"item": "සබන් LUX 100g", "quantity": 10, "total_cost": 450.00}, {"item": "කිරි පිටි ANCHOR 400G", "quantity": 5, "total_cost": 2600.00}]
             If no valid item lines with names, quantities, and costs are clearly identifiable, return an empty array []. Do not include any text outside the JSON array.`;

             const payload = {
                 "contents": [{ "parts": [ { "text": prompt }, { "inline_data": { "mime_type": "image/jpeg", "data": base64ImageData } } ] }],
                 "generationConfig": { "temperature": 0.2, "maxOutputTokens": 2048 } // Increased tokens for potentially long receipts
             };

             try {
                 const response = await fetch(GEMINI_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                 const data = await response.json();
                 console.log("Gemini Stock Bill Raw Response:", JSON.stringify(data));

                 if (!response.ok) { throw new Error(`API Error (${response.status}): ${data?.error?.message || 'Unknown error'}`); }
                  if (data.promptFeedback?.blockReason) { throw new Error(`Request blocked: ${data.promptFeedback.blockReason}. Details: ${JSON.stringify(data.promptFeedback.safetyRatings)}`); }
                 if (!data.candidates || !data.candidates[0]?.content?.parts?.[0]?.text) { throw new Error("AI ප්‍රතිචාරයේ අන්තර්ගතයක් නොමැත."); }

                 let jsonString = cleanGeminiResponse(data.candidates[0].content.parts[0].text);
                 let detectedStockItems = [];
                 try { detectedStockItems = JSON.parse(jsonString); }
                 catch (parseError) { console.error("Failed to parse Gemini JSON for stock bill:", parseError, "\nRaw response text:", jsonString); throw new Error("AI ප්‍රතිචාරය (JSON) තේරුම් ගැනීමට නොහැකි විය."); }

                 if (!Array.isArray(detectedStockItems)) { throw new Error("AI ප්‍රතිචාරය බලාපොරොත්තු වූ array ආකෘතියෙන් නොවේ."); }

                 if (detectedStockItems.length > 0) {
                     let itemsAddedCount = 0;
                     detectedStockItems.forEach(detected => {
                         const name = detected.item?.trim();
                         const quantity = parseInt(detected.quantity);
                         const totalCost = parseFloat(detected.total_cost);

                         // Validate the extracted data
                         if (name && !isNaN(quantity) && quantity > 0 && !isNaN(totalCost) && totalCost >= 0) {
                             // Save valid data AUTOMATICALLY using the existing function
                             saveStockItemData(name, quantity, totalCost); // This now triggers loadStockItems which recalculates estimates & updates selling prices
                             itemsAddedCount++;
                         } else {
                             console.warn("Skipping invalid stock item from AI:", detected);
                         }
                     });

                     if (itemsAddedCount > 0) {
                          // saveStockItemData calls loadStockItems, which now calculates estimates.
                          showProcessingMessage(currentSection, `AI මගින් තොග භාණ්ඩ ${itemsAddedCount} ක් එකතු කරන ලදී. ඇස්තමේන්තුගත තොගය සහ විකුණුම් මිල ගණන් තහවුරු කරන්න.`);
                          success = true;
                           setTimeout(() => clearProcessingMessage(currentSection), 6000); // Keep message longer
                     } else {
                          showProcessingMessage(currentSection, "AI ප්‍රතිචාරයේ වලංගු තොග දත්ත හමු නොවීය.", true);
                          success = false;
                           setTimeout(() => clearProcessingMessage(currentSection), 4000);
                     }
                 } else {
                      showProcessingMessage(currentSection, "AI මගින් තොග බිල්පතේ භාණ්ඩ හඳුනාගැනීමට නොහැකි විය.", true);
                      success = false;
                       setTimeout(() => clearProcessingMessage(currentSection), 4000);
                 }

             } catch (error) {
                 console.error('Error processing stock bill with Gemini:', error);
                 showProcessingMessage(currentSection, 'AI Scan දෝෂයකි: ' + error.message, true);
                 success = false;
                  setTimeout(() => clearProcessingMessage(currentSection), 5000);
             } finally {
                 handleImageProcessingCompletion(success, 'stock_ai');
             }
         }
         // --- END AI Stock Bill Scan (Gemini) Logic ---

         // --- START AI Product Scan (Gemini) Logic (Product Management) ---
         // Function triggered by the new button in Product Management
         function scanProductForManagement() {
            captureImage('product_management_scan');
         }

         // NEW async function to process image for product details
         async function extractProductDetailsFromImage(base64ImageData) {
             const currentSection = 'product'; // Use product management message area
             showProcessingMessage(currentSection, 'AI මගින් භාණ්ඩයේ නම සහ මිල Scan වෙමින් පවතී...');
             console.log("Sending image to Gemini for Product Name & Price Scan...");
             let success = false;

             // UPDATED Prompt: Ask for name AND price from a single product image
             const prompt = `Analyze the image, focusing on the main product shown. Extract the most likely product name and its price if visible on the packaging or a price tag. Use Sinhala for the name if possible and keep it concise.
             Respond strictly with a JSON object like this: {"item": "PRODUCT_NAME", "price": PRICE_NUMBER}.
             Example: {"item": "සබන්", "price": 140.00} or {"item": "Anchor Milk Powder", "price": 525.00}
             If the name is unclear, use "Scanned Product". If the price is unclear or not found, use 0 for the price value.
             Do not include currency symbols or any text outside the JSON object. Output only the JSON.`;

             const payload = {
                "contents": [{
                    "parts": [
                        { "text": prompt },
                        { "inline_data": { "mime_type": "image/jpeg", "data": base64ImageData } }
                    ]
                }],
                "generationConfig": { "temperature": 0.3, "maxOutputTokens": 150 } // Slightly higher temp might help with varied text
             };

             try {
                 const response = await fetch(GEMINI_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                 const data = await response.json();
                 console.log("Gemini Product Name & Price Scan Raw Response:", JSON.stringify(data));

                 if (!response.ok) { throw new Error(`API Error (${response.status}): ${data?.error?.message || 'Unknown error'}`); }
                 if (data.promptFeedback?.blockReason) { throw new Error(`Request blocked: ${data.promptFeedback.blockReason}. Details: ${JSON.stringify(data.promptFeedback.safetyRatings)}`); }
                 if (!data.candidates || !data.candidates[0]?.content?.parts?.[0]?.text) { throw new Error("AI ප්‍රතිචාරයේ අන්තර්ගතයක් නොමැත."); }

                 let jsonString = cleanGeminiResponse(data.candidates[0].content.parts[0].text);
                 let detectedData = {};
                 try { detectedData = JSON.parse(jsonString); }
                 catch (parseError) { console.error("Failed to parse Gemini JSON for product details:", parseError, "\nRaw response text:", jsonString); throw new Error("AI ප්‍රතිචාරය (JSON) තේරුම් ගැනීමට නොහැකි විය."); }

                 const name = detectedData.item?.trim();
                 const price = parseFloat(detectedData.price); // Price from AI

                 // --- Update UI based on findings ---
                 let message = "";
                 let focusElementId = null; // To set focus after populating
                 let nameField = document.getElementById('newProductName');
                 let priceField = document.getElementById('newProductPrice');

                 if (name && name !== "Scanned Product") {
                     if(nameField) nameField.value = name; // Populate name field
                     message += `AI හඳුනාගත් නම: "${name}". `;
                     focusElementId = 'newProductPrice'; // Focus price next
                     success = true; // At least name found
                 } else {
                     message += 'AI මගින් නම පැහැදිලිව හඳුනාගත නොහැකි විය. ';
                     focusElementId = 'newProductName'; // Focus name field if name not found
                 }

                 if (!isNaN(price) && price > 0) { // Only populate price if valid AND greater than 0
                     if(priceField) priceField.value = price.toFixed(2); // Populate price field
                     message += `මිල: ${price.toFixed(2)} රු. `;
                      // If name was also found, focus stays on price (or maybe focus the 'Add' button?)
                      // if (focusElementId === 'newProductPrice') { /* focus add button? */ }
                      success = true; // Name and/or Price found
                 } else if (name && name !== "Scanned Product") { // Name found, but price is 0 or invalid
                     message += 'මිල හඳුනාගත නොහැකි විය හෝ 0 විය. කරුණාකර මිල ඇතුළත් කරන්න. ';
                     // Keep focus on price input
                 } else {
                    // Name not found, don't mention price specifically.
                 }

                 if (!success) { // Neither name nor valid price found
                      message += 'කරුණාකර නම සහ මිල අතින් ඇතුළත් කරන්න.';
                      focusElementId = 'newProductName'; // Focus name field
                 } else {
                      message += 'තොරතුරු තහවුරු කර භාණ්ඩය එකතු කරන්න.';
                 }

                 showProcessingMessage(currentSection, message, !success); // Show as error if nothing useful found

                 // Set focus to the most relevant field
                 if (focusElementId) {
                    setTimeout(() => {
                        const elementToFocus = document.getElementById(focusElementId);
                        if(elementToFocus) elementToFocus.focus();
                    }, 100); // Small delay for UI update before focusing
                 }

                 // Clear message after a while
                 setTimeout(() => clearProcessingMessage(currentSection), 8000); // Keep message longer for user to read


             } catch (error) {
                 console.error('Error getting product details from Gemini:', error);
                 showProcessingMessage(currentSection, 'AI Scan දෝෂයකි: ' + error.message, true);
                 success = false;
                 // Focus name field on error
                 setTimeout(() => document.getElementById('newProductName')?.focus(), 100);
                 setTimeout(() => clearProcessingMessage(currentSection), 6000); // Keep error longer
             } finally {
                 handleImageProcessingCompletion(success, 'product_management_scan');
             }
         }
         // --- END AI Product Scan (Gemini) Logic ---

    </script>

</body>
</html>